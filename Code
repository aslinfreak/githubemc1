SELECT DISTINCT  
       ISNULL(PRR.AssociateID,'') AS AssociateID,
       ISNULL(LTRIM(RTRIM(CAD.Associate_FirstName)),'') + ' ' + 
       ISNULL(LTRIM(RTRIM(CAD.Associate_LastName)),'') AS AssociateName,
       AL.Project_ID AS ProjectID,   -- << Always fetch ACTIVE Project
       ISNULL(PRR.Amount,'') AS Amount,
       ISNULL(PRR.InputRemarks,'') AS Remarks
FROM PR.Reversal PRR WITH(NOLOCK)

-- Associate Details  
LEFT JOIN CENTRALREPOSITORY.dbo.VW_CENTRALREPOSITORY_ASSOCIATE_DETAILS CAD WITH(NOLOCK)
    ON CAD.Associate_ID = PRR.AssociateID

-- Component check  
INNER JOIN ComponentMaster CM WITH(NOLOCK)
    ON CM.PK_ComponentId = PRR.FK_ComponentID
    AND CM.RowStatus = 1
    AND CM.FK_ComponentGroupID = @componentGroupId

-- >>> ADD THIS JOIN TO ACTIVE PROJECT <<< --
INNER JOIN CentralRepository..vw_CentralRepository_Allocation AL WITH(NOLOCK)
    ON AL.Associate_ID = PRR.AssociateID
    AND AL.Assignment_Status = 'A'     -- Only ACTIVE project
    AND (
            AL.Allocation_End_Date IS NULL
            OR AL.Allocation_End_Date >= GETDATE()
        )

WHERE PRR.RowStatus = 1
  AND PRR.Status = 1;
