INSERT INTO STG.ExceptiontovalidAllowance
    (UniqueID, RowStatus, FK_ComponentGroupID, RejectionReason, Approve_Reject, CreatedBy, CreatedDate)
VALUES
    (13, 1, 10, 'Test rejection - manual BJ', 'Reject', 240485, GETDATE());

	INSERT INTO STG.ExceptiontovalidAllowance
    (UniqueID, RowStatus, FK_ComponentGroupID, RejectionReason, Approve_Reject, CreatedBy, CreatedDate)
VALUES
    (12, 1, 10, 'Manual Test-2', 'Reject', 240485, GETDATE()); --CONTE2C118C435674C0884F608F99582B075

	INSERT INTO STG.ExceptiontovalidAllowance
    (UniqueID, RowStatus, FK_ComponentGroupID, RejectionReason, Approve_Reject, CreatedBy, CreatedDate)
VALUES
    (29116, 1, 11, 'Manual Test-1', 'Reject', 240485, GETDATE()); --CONT7CD08F1CEEA644A5A370012569F83D86

 select * from STG.ExceptiontovalidAllowance

 select * from  PR.BPSTransportAllowance 


 UPDATE STG.ExceptiontovalidAllowance
SET RowStatus = 1,
    FK_ComponentGroupID = 10,
    RejectionReason = 'Manual Test-1',
    Approve_Reject = 'Reject',
    ModifiedBy = '240485',
    ModifiedDate = GETDATE()
WHERE UniqueID = 13;  
 
 
 DECLARE @componentGroupId INT = 10;
 SELECT
  STP.UniqueID,
  STP.RejectionReason,
  STP.Approve_Reject,
  STP.RowStatus AS STP_RowStatus,
  STP.FK_ComponentGroupID,
  NSA.PK_BPSNSAId,
  NSA.AssociateID,
  NSA.RowStatus AS NSA_RowStatus,
  NSA.Status AS NSA_Status,
  NSA.NSADate,
  NSA.ProjectId,
  CASE 
    WHEN (ISNULL(STP.RejectionReason,'') = '' AND STP.Approve_Reject = 'Reject') THEN 'Rejection reason is mandatory'
    WHEN ISNULL(CONVERT(VARCHAR(50),NSA.PK_BPSNSAId),'') = '' THEN 'Please upload the valid Unique id'
    ELSE ''
  END AS ExceptionRemarks
FROM STG.ExceptiontovalidAllowance STP
LEFT JOIN PR.BPSNSA NSA ON STP.UniqueID = NSA.PK_BPSNSAId
WHERE STP.RowStatus = 1
  AND STP.FK_ComponentGroupID = @componentGroupId
  AND NSA.RowStatus = 1
  AND NSA.Status IN (1,3,4,8,14,18,17,15,16,12,21,35);
 

DECLARE @componentGroupId INT = 10;
DECLARE @FileUploadID VARCHAR(50) = 'CONTDFA98DB52A8344E0A80F30F68A650ABB';
 
EXEC dbo.usp_StagingToMain_BulkRejection @componentGroupId = 10, @FileUploadID ='CONTDFA98DB52A8344E0A80F30F68A650ABB';
 
SELECT TOP 50 *
FROM PR.BPSNSA_Log
WHERE PK_BPSNSAId = 14   
ORDER BY LogCreateddate DESC;
 
SELECT PK_BPSNSAId, Status, RejectionReason, ApprovedBy, ApprovedDate, RejectedBy, RejectedDate, ModifiedBy, ModifiedDate
FROM PR.BPSNSA
WHERE PK_BPSNSAId = 14;
 
 select top 100 * from ExceptionLog order by exceptiondatetime desc

SELECT * 
FROM STG.ExceptiontovalidAllowance
WHERE FileUploadID = 'CONTDFA98DB52A8344E0A80F30F68A650ABB';
 
SELECT * 
FROM pr.BPSNSA
WHERE FK_ComponentGroupID = 10;
 
