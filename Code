In my application, while updating the data(ie.move from exception to valid),I getting 512 error in the application.So I run the sp manually by declaring the values,now Iam gettin the below error:
Msg 512, Level 16, State 1, Line 179
Subquery returned more than 1 value. This is not permitted when the subquery follows =, !=, <, <= , >, >= or when the subquery is used as an expression.
Help me to fix this.

This is my StoredProcedure [dbo].[usp_CE_SF_MoveExpToValidUploaderData]

USE [OneC_SPay]
GO
Declare
	@ComponentGrpID INT=18,
    @keyId INT=574,
	@Amount varchar(20)=13000,
	@StartDate varchar(100)='06-02-2025',
	@EndDate varchar(100)='04-24-2026',
	@FrequencyType int=1,
	@FrequencySelection int=6,	
	@Installments int=3,
	@SchoolFeesReceiptID VARCHAR(50)='CONT955BA3E490834FBCA6FD2C52B8B2DEE1',
	@LoginID VARCHAR(11)=2298944,
	@CountryId int=15,
    @ComponentCountryMappingId INT = 253

declare @ComponentId INT ,@CountryName varchar(20),@Countrycode varchar(10)
declare @AssociateID varchar(11), @PayoutType varchar(50), @Year varchar(10),@ChildType int, 
@MaxPercentage int
set @ComponentId=58
Select @CountryName= Country from ComponentCountryMaster where PK_ComponentCountryID=@CountryID
select @Countrycode=CountryID from ComponentCountryMaster where PK_ComponentCountryID=@CountryID

 SELECT @AssociateID=AssociateID,@PayoutType= PayoutType ,@year=Year , @ChildType= Childtype  
 FROM EXP.CESchoolFees WITH (NOLOCK) 
 WHERE PK_CESchoolFeesID=@keyID and Rowstatus=1	 
 

select @MaxPercentage = PK_CriteriaType from policy.policymaster where AssociateId=@AssociateID	
and fk_ComponentCountrymappingid=@ComponentCountrymappingid and rowstatus=1

IF(@CountryId = 17)
BEGIN
SELECT @Installments =1;
END

DECLARE @MaxCapAmount money, @Child1TotalAmount money,@Child2TotalAmount money

select @MaxCapAmount= isnull(sum(Amount),'') from PR.CESchoolFees where AssociateID=@AssociateId
and FK_componentcountrymappingid=@ComponentCountryMappingId and Rowstatus=1		
					   and StartDate=@Startdate and EndDate=@EndDate and Rowstatus=1 

select @Child1TotalAmount=  isnull(sum(Amount),'') from PR.CESchoolFees where AssociateID=@AssociateId 
and FK_componentcountrymappingid=@ComponentCountryMappingId and Rowstatus=1
						and ChildType=1	and StartDate=@Startdate and EndDate=@EndDate 
select @Child2TotalAmount=  isnull(sum(Amount),'') from PR.CESchoolFees where AssociateID=@AssociateId 
and FK_componentcountrymappingid=@ComponentCountryMappingId and Rowstatus=1
						   and ChildType=2 and StartDate=@Startdate and EndDate=@EndDate 


Declare @EmplID INT,@Emplstatus varchar(20),@location varchar(100),@Country varchar(10),@Jobcode varchar(10),
@DeptID varchar(20),@Empltype varchar(10),@Effdt varchar(20),@Company varchar(5),@Businessunit varchar(6),
@GradeLevel varchar(10),@locationtype varchar(50)


	DECLARE @SETIDLIST TABLE
	(
		Business_Unit VARCHAR(5),
		Country_ID VARCHAR(3)
	)
	
	INSERT INTO @SETIDLIST(Business_Unit,Country_ID)
		SELECT DISTINCT Business_Unit,Country_ID 
		FROM CENTRALREPOSITORY.DBO.vw_CentralRepository_HCMLocation WITH(NOLOCK) WHERE ISActive='A'
	
		CREATE TABLE #SFEXCEPTIONS
		(
			EXCEPTIONREASON VARCHAR(8000) NULL
		)	
	
	CREATE TABLE #Assodump
	(
	PK INT IDENTITY(1,1) PRIMARY KEY,
	AssociateID VARCHAR(11),
	StartDate DateTIME
	)

	INSERT INTO #Assodump(AssociateID,StartDate)
	SELECT @AssociateID,GETDATE()

    CREATE TABLE #SFTEMP
    (
    PK INT IDENTITY(1,1) PRIMARY KEY,
    AssociateID VARCHAR(11),
    LOCATION VARCHAR(50),
    BU VARCHAR(50),
    COUNTRYID VARCHAR(50),
    GRADE VARCHAR(50),
    DEPARTMENTID VARCHAR(50),
    EMPLTYPE VARCHAR(10),
    EMPLSTATUS VARCHAR(5),
    EFFDT DATETIME,
    COMPANY VARCHAR(10)
    )


----------------Fetch data with CTE--------------
;WITH JR_DUMP
AS
(
SELECT AL.PK,JR.EMPLID, JR.LOCATION AS LOCATION, JR.BUSINESS_UNIT AS BU, JR.JOBCODE AS GRADE, 
JR.HR_STATUS, JR.EMPL_STATUS,
JR.DEPTID AS DEPARTMENTID, JR.PER_ORG AS EMPLTYPE, JR.EMPL_STATUS AS EMPLSTATUS, JR.EFFDT AS EFFDT, 
JR.COMPANY,JR.EMPL_RCD AS EMPL_RCD,
RANK() OVER
       (
       PARTITION BY EMPLID ORDER BY JR.EFFDT DESC,
       CASE
              WHEN (JR.HR_STATUS = 'A' AND (JR.EMPL_STATUS IN ('A','L','P','W') 
			  OR (JR.EMPL_STATUS = 'S' AND JR.ACTION <> 'OGA'))) 
              THEN 2
              WHEN JR.HR_STATUS = 'I' THEN 1
              ELSE 0
       END DESC) AS RNK_EFF,
RANK() OVER
       (
       PARTITION BY EMPLID,JR.EFFDT,JR.EMPL_RCD ORDER BY JR.EFFSEQ DESC
       ) AS RNK_SEQ,
 RANK() OVER
       (
       PARTITION BY EMPLID ORDER BY JR.EFFDT DESC, JR.EFFSEQ DESC, JR.EMPL_RCD DESC
       ) AS RNK_ALT
FROM #Assodump AL
INNER JOIN CENTRALREPOSITORY.DBO.VW_CENTRALREPOSITORY_JOB_REFERENCE JR WITH(NOLOCK) 
ON AL.ASSOCIATEID=JR.EMPLID AND JR.ACTION <> 'INA' and JR.EFFDT<=convert(date,StartDate)
), JR_Final
AS
(
SELECT PK,EMPLID,LOCATION,BU,GRADE,DEPARTMENTID,EMPLTYPE,EMPLSTATUS,EFFDT,COMPANY,
RANK() OVER(
       PARTITION BY EMPLID ORDER BY  CASE
              WHEN (JR.RNK_EFF=1 AND JR.RNK_SEQ=1) THEN 2
              WHEN JR.RNK_ALT = 1 THEN 1
              ELSE 0 END DESC,EMPL_RCD DESC) AS FinalRNK 
FROM JR_DUMP JR  WITH(NOLOCK)
)

INSERT INTO #SFTEMP  (AssociateID ,LOCATION ,BU ,COUNTRYID ,GRADE ,DEPARTMENTID ,EMPLTYPE ,
EMPLSTATUS ,EFFDT ,COMPANY)
SELECT JR.EMPLID AssociateID,JR.LOCATION, JR.BU,HL.COUNTRY_ID, JR.GRADE,  JR.DEPARTMENTID, 
JR.EMPLTYPE,JR.EMPLSTATUS,JR.EFFDT,JR.COMPANY
FROM JR_Final JR WITH(NOLOCK)
LEFT OUTER JOIN CENTRALREPOSITORY.DBO.VW_CENTRALREPOSITORY_HCMLOCATION HL WITH(NOLOCK) 
ON HL.HCMLOCATIONCODE=JR.LOCATION AND HL.BUSINESS_UNIT=JR.BU
WHERE FinalRNK=1
			 
	select @EmplID=AssociateID,@Emplstatus=EmplStatus,@locationtype=LOCATION,@Country=CountryID,
	@Jobcode=Grade,@DeptID=DepartmentId,
	@Empltype=EmplType,@Company=COMPANY,@Businessunit=BU from #SFTEMP
		
	select @AssociateId as AssociateId,@ChildType as ChildType into #AssocaiteDetails


Declare @Calculatedamount Money
---------------Check the Calculate amount------
if(@ChildType=1)
BEGIN
	Set @Calculatedamount = (Select
	CASE WHEN ((cast(PPM.PK_CriteriaType as FLOAT)/cast(100 as FLOAT))) * convert(money,@Amount)<PPM.Upto1Month 
	THEN (cast(PPM.PK_CriteriaType as FLOAT)/cast(100 as FLOAT)) * convert(money,@Amount)
	 ELSE PPM.Upto1Month END FROM Policy.PolicyMaster PPM with(nolock)  
	where PPm.AssociateId=@AssociateID and PPM.FK_ComponentCountrymappingid=@ComponentCountrymappingid 
	and PPM.Rowstatus=1)
END
ELSE IF(@ChildType=2)
BEGIN
	Set @Calculatedamount = (Select CASE 
	WHEN ((cast(PPM.PK_CriteriaType as FLOAT)/cast(100 as FLOAT)))<PPM.Above1Month THEN
	 ((cast(PPM.PK_CriteriaType as FLOAT)/cast(100 as FLOAT))) * convert(money,@Amount)
	ELSE PPM.Above1Month END
	FROM Policy.PolicyMaster PPM with(nolock)  
	where PPm.AssociateId=@AssociateID and PPM.FK_ComponentCountrymappingid=@ComponentCountrymappingid 
	and PPM.Rowstatus=1)
END
	
---------------------Insert into SF exception-----------------		
  INSERT INTO #SFEXCEPTIONS(EXCEPTIONREASON)
		 SELECT 'Associate''s DOJ should be lesser than claim date,' 
		 FROM CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK)
		 WHERE AD.Associate_ID=@AssociateID AND AD.DATEOFJOINING>CONVERT(DATE,@StartDate) 
		
		UNION ALL

		SELECT COALESCE((CASE WHEN AssociateID=@LoginID and @AssociateId<>@LoginID 
		THEN 'Associate can only upload his own record' END),'')  AS EXCEPTIONREASON 
		FROM Policy.PolicyMaster WITH (NOLOCK)
		WHERE FK_Componentcountrymappingid=@ComponentCountryMappingId  and RowStatus=1

		UNION ALL

        SELECT 	DISTINCT	
		
			COALESCE((CASE WHEN ((@EmplStatus <> 'A') OR (AD.ASSOCIATE_ID IS NULL)) 
											THEN 'AssociateID is InActive,' END), '') 
			+
			COALESCE((CASE WHEN AD.IsActive = 'T' and (DATEDIFF(DD,EffDt ,getdate()) > 30)  
			  THEN 'Associate’s termination date is greater than 30 days. Special pay can’t be processed,' 
			  ELSE NULL END), '')   
				
			+		   
			COALESCE((CASE WHEN ISNULL(@SchoolFeesReceiptID,'')='' OR @SchoolFeesReceiptID='0'
			THEN 'Invoice is mandatory,' ELSE NULL END), '')
			+
			COALESCE((CASE WHEN AD.COMPANY IS NULL THEN 'Company Unavailable,' ELSE NULL END), '')  
			+
			COALESCE((CASE WHEN AD.BUSINESS_UNIT IS NULL THEN 'SetId Unavailable,' ELSE NULL END), '')
			+
			COALESCE((CASE WHEN  (DATEDIFF(mm,@Startdate,@EndDate)<10) 
			THEN 'Claim Month Should be atleast 10 months,' ELSE NULL END), '') 
			+			
			 COALESCE((CASE WHEN  
			AD.DATEOFJOINING>CONVERT(DATE,getdate())    
			THEN 'Associate''s DOJ should be lesser than claim date,' ELSE NULL END), '')
		 
			AS EXCEPTIONREASON	
			FROM CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK)  
			Where AD.Associate_ID =@AssociateID
	  
	UNION ALL

	     SELECT DISTINCT 'Associate Details not available in CRS,' AS EXCEPTIONREASON from #SFTEMP SFT
		 WHERE ISNULL(@AssociateID,'')<>ISNULL(SFT.AssociateID,'')

	UNION ALL

			SELECT DISTINCT
			COALESCE((CASE WHEN AD.Per_Org ='CWR' THEN 'Associate is a contractor,' ELSE NULL END), '')  
				+
		    COALESCE((CASE WHEN JR.ACTION='TER' AND JR.Action_reason='CTE' AND AD.Per_Org <>'CWR' 
			AND JR.EFFDT=AD.DateOfJoining
		    THEN 'Associate has converted from contractor to Employee,' ELSE NULL END), '')  
			
			AS EXCEPTIONREASON			
			FROM CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK) 			
			LEFT OUTER JOIN CENTRALREPOSITORY.DBO.VW_CENTRALREPOSITORY_JOB_REFERENCE JR WITH(NOLOCK) ON 
			JR.Emplid=AD.Associate_ID
			WHERE ISNUMERIC(JR.EMPLID)=1 AND  AD.Associate_ID=@AssociateID 
		
	UNION ALL

		SELECT DISTINCT 
		COALESCE((CASE WHEN SL.Country_ID IS NULL 
		THEN 'Associate not active in '+Country+' Payroll as on claim date,' ELSE NULL END), '')
		AS ExceptionReason
		FROM ComponentCountryMaster CCM LEFT OUTER JOIN @SETIDLIST SL
		ON (SL.Country_ID=CCM.SETIDDivision OR SL.Country_ID=CCM.CountryID) and BUSINESS_UNIT=@Businessunit
		where PK_ComponentCountryID=@CountryId

	UNION ALL

	    SELECT DISTINCT 'Associate not eligible for this allowance,' AS EXCEPTIONREASON 
		from #AssocaiteDetails AD
	    left outer join  Policy.PolicyMaster PPM on AD.AssociateID=PPM.AssociateId  
		and PPM.Rowstatus=1 and PPM.FK_Componentcountrymappingid=@ComponentCountryMappingId 
	    Where ISNULL(PPM.AssociateId,0)=0
  
   UNION ALL			

		SELECT DISTINCT		
		COALESCE((CASE WHEN (@Amount IS NULL) THEN 'Amount is Mandatory,' 
		WHEN (@Amount<>'' AND ISNUMERIC(@Amount) <> 1 OR CONVERT(MONEY,@Amount)<1)
		THEN 'Amount is InValid ,' ELSE NULL END), '')
		AS EXCEPTIONREASON

	UNION ALL

	     SELECT DISTINCT 'Amount for child 2 not configured for this Associate,' AS EXCEPTIONREASON 
		 from #AssocaiteDetails AD
	     left outer join  Policy.PolicyMaster PPM on AD.AssociateID=PPM.AssociateId  
		 and PPM.Rowstatus=1 and PPM.FK_Componentcountrymappingid=@ComponentCountryMappingId 
	     Where (ISNULL(@Amount,'')<>'' or @Amount<>0) and (ISNULL(PPM.Above1Month,'')=''
		 or PPM.Above1Month=convert(decimal,0)) and ISNULL(PPM.AssociateId,'')<>''
		 and ChildType=2
	
	UNION ALL

		 SELECT DISTINCT 'Claim date not within Academic year selection'  AS EXCEPTIONREASON 
		 From MonthMaster QM where QM.Quarter=@FrequencySelection and @FrequencyType=2 and
		 ((month(@Startdate)>QM.MonthID and @Year=Year(@StartDate)) 
		 OR (month(@EndDate)<QM.MonthID and @Year=Year(@EndDate)) 
		 OR ( @Year <> year(@Startdate) and @Year <> year(@Enddate)))		
		 having count(QM.MonthID)>=3

    UNION ALL		
	    SELECT DISTINCT 
		 COALESCE((CASE WHEN @FrequencyType=1 and (EOMONTH(cast(@Year+' -'+ ''
		 +convert(varchar,@FrequencySelection) +'' + '-1' AS DATE)) not between @StartDate and @Enddate
		 AND cast(@Year+' -'+ ''+convert(varchar,@FrequencySelection) +'' + '-1' AS DATE) 
		 not between @StartDate and @Enddate)  THEN 'Claim date not within Academic year selection' 
		 ELSE NULL END), '')
		 AS ExceptionReason

	UNION ALL


		 SELECT DISTINCT 
		 COALESCE((CASE WHEN @FrequencyType=3 and (@FrequencySelection not in (year(@StartDate) , 
		 year(@Enddate)))
		 THEN 'Claim date not within Academic year selection' ELSE NULL END), '')
		 AS ExceptionReason

	UNION ALL
		
			SELECT DISTINCT  (case when SF.AssociateID is null and AD.ChildType=2 
			then 'Amount for Child 1 is not claimed,' else null end) AS EXCEPTIONREASON 
			from  #AssocaiteDetails AD
			Left Outer join PR.CESchoolFees SF with(nolock) on SF.AssociateID=AD.AssociateId 
			and SF.ChildType=1 and SF.FK_ComponentCountrymappingid=@ComponentCountryMappingId
			and SF.Rowstatus=1


	UNION ALL
			
		 Select DISTINCT 'Max Cap Amount Exceeds,' AS EXCEPTIONREASON  from  Policy.PolicyMaster PPM	 
		 where  PPM.AssociateID=@AssociateId and PPM.AssociateID is not null 
		 and (@MaxCapAmount+@Calculatedamount)>convert(money,PPM.Amount)  
		 and PPM.FK_Componentcountrymappingid=@ComponentCountryMappingId 
		 and Rowstatus=1 
	  
	UNION ALL
     
		SELECT DISTINCT 'Amount for Child 1 exceeds Child 1 max cap,' AS EXCEPTIONREASON 
		from  Policy.PolicyMaster PPM	 
		where  PPM.AssociateID=@AssociateId and PPM.AssociateID is not null 
		and  (@Child1TotalAmount+@Calculatedamount) > convert(money,PPm.Upto1month) 
		and PPM.FK_Componentcountrymappingid=@ComponentCountryMappingId 
		and Rowstatus=1 and @ChildType=1

	UNION ALL
     
		SELECT DISTINCT 'Amount for Child 2 exceeds  Child 2 max cap,' AS EXCEPTIONREASON 
		from  Policy.PolicyMaster PPM	 
		where  PPM.AssociateID=@AssociateId and PPM.AssociateID is not null 
		and  (@Child2TotalAmount +@Calculatedamount)> convert(money,PPm.Above1Month) 
		and PPM.FK_Componentcountrymappingid=@ComponentCountryMappingId 
		and Rowstatus=1 and @ChildType=2

	
	   UNION ALL
	
	    SELECT  DISTINCT 
	    CASE WHEN Status=1 then 'SchoolFees has been already uploaded,' 
	    	  when Status=5 then 'SchoolFees has been already processed,'
	    	  when Status=14 then 'SchoolFees has been already Approved,' end AS EXCEPTIONREASON
        FROM PR.CESchoolFees PNP WITH(NOLOCK)    
        WHERE PNP.AssociateID=@AssociateID and  PNP.Rowstatus=1
		and FK_Componentcountrymappingid=@ComponentCountryMappingId and PNP.FrequencyType=@FrequencyType 
		and PNP.FrequencySelection=@FrequencySelection and @Year=PNP.Year
		and PNP.ChildType=@ChildType and ((convert(date,@StartDate) between  PNP.StartDate
		and PNP.EndDate and convert(date,@enddate) between PNP.StartDate and PNP.EndDate)
	   OR convert(date,getdate()) < PNP.StartDate)   

		
	   DELETE FROM #SFEXCEPTIONS where ISNULL(EXCEPTIONREASON,'')=''
			
			DECLARE @SFException VARCHAR(8000)  
			SELECT @SFException = COALESCE(@SFException + ', ', '') + EXCEPTIONREASON FROM #SFEXCEPTIONS
			SELECT @SFException=replace(@SFException,',,',',')
 
 ---- Check the SF exception is null-----
  IF((@SFException IS NULL OR @SFException='') )
  BEGIN
  Declare @Mydate datetime=getdate()
          UPDATE EXP.CESchoolfees SET ROWSTATUS=0,ModifiedBy=@LoginID,ModifiedDate=@Mydate,
		  Invoiceattachment=@SchoolFeesReceiptID WHERE PK_CESchoolFeesID=@keyId 

		 IF(@CountryId=17)
		 BEGIN
			INSERT INTO PR.CESchoolfees(AssociateID,StartDate,Enddate,ChildType,FrequencyType,
			FrequencySelection,Year,Amount,AmountClaimed,
			PayoutType,status,CreatedBy,CreatedDate,RowStatus,
			InvoiceAttachment,NumberOfinstallment,FK_Componentcountrymappingid,SetID,Grade)
		
			SElect @AssociateId,@StartDate,@Enddate,@ChildType,@FrequencyType,@FrequencySelection,
			@Year,@Calculatedamount/@Installments,@Amount,
			@PayoutType,1,@LoginID,
			GETDATE(),1,
			@SchoolFeesReceiptID,@Installments,@ComponentCountryMappingId,@Businessunit,@Jobcode			
		 END
		 ELSE
		 BEGIN
			INSERT INTO PR.CESchoolfees(AssociateID,StartDate,Enddate,ChildType,FrequencyType,
			FrequencySelection,Year,Amount,AmountClaimed,
			PayoutType,status,CreatedBy,CreatedDate,RowStatus,
			InvoiceAttachment,NumberOfinstallment,FK_Componentcountrymappingid,SetID,Grade)
		
			SElect @AssociateId,@StartDate,@Enddate,@ChildType,@FrequencyType,@FrequencySelection,
			@Year,@Calculatedamount/@Installments,@Amount,
			@PayoutType,1,@LoginID,
			DATEADD(month,MonthID,DATEADD(DAY,1,EOMONTH(getdate(),-1))),1,
			@SchoolFeesReceiptID,@Installments,@ComponentCountryMappingId,@Businessunit,@Jobcode
			From MonthMaster where MonthID<@Installments
		 END			 		

        SELECT 'success' AS STATUS
        
END
  ELSE
	BEGIN

	------ Update CEschoolfees ----------

		UPDATE EXP.CESchoolfees SET ModifiedBy=@LoginID,ModifiedDate=GETDATE(),
		ExceptionRemarks=@SFException
		WHERE PK_CESchoolFeesid=@keyId 

		SELECT @SFException AS 'Status' 
	END
        
      
    DROP TABLE  #SFEXCEPTIONS   
    DROP TABLE  #SFTEMP
