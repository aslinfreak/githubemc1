                      
ELSE IF(@ComponentId=5)  
BEGIN
	  CREATE TABLE #HOLIDAYS (HOLIDAY DATE)
	  INSERT INTO #HOLIDAYS (HOLIDAY)
	  SELECT DISTINCT CONVERT(DATE,HD.HOLIDAY)
	  FROM CentralRepository.dbo.VW_CentralRepository_HolidayDate HD WITH(NOLOCK) 
	  INNER JOIN CentralRepository.dbo.vw_CentralRepository_HCMLocation LOC WITH(NOLOCK)
	  ON LOC.HCMLocationCode = HD.LOCATION
	  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK)  
	  ON LOC.HCMLocationCode = AD.PresentHCMLocationCode AND AD.Associate_ID = CAST(@AssociateID AS CHAR)
   ------------------- fetch data--------------   
        INSERT INTO #STPEXCEPTION(EXCEPTIONREASON)  
        SELECT DISTINCT    
        COALESCE((CASE WHEN CSM.FK_ShiftTypeID IS NULL   
        THEN 'Component- shift type mismatch' ELSE '' END), '')  
         from ComponentShiftMapping CSM WITH(NOLOCK)   
        where CSM.FK_ComponentCountryMappingID=@ComponentCountryMappingID   
        AND Convert(int,CSM.FK_ShiftTypeID)=@ShiftType AND CSM.RowStatus=1  
                
          UNION ALL  
       SELECT DISTINCt COALESCE((CASE WHEN @STARTDATE=@ENDDATE   
       AND @STARTTIME=@ENDTIME THEN 'StartDateTime and EndDateTime is Equal' ELSE '' END), '')  
       UNION ALL  
     ------------------- fetch data--------------  
     SELECT DISTINCT   
   'This ProjectID is not configured for OCA ' where @ProjectID not in   
  (select Projectid FROM Approval_Projects AP WITH(NOLOCK)   
  where  AP.ROWSTATUS=1 AND AP.FK_ComponentID=5)  
  
     UNION ALL  
              ------------------- fetch data--------------     
         SELECT DISTINCT COALESCE((CASE WHEN  PGM.GradeLevelId IS NULL   
         THEN 'Ineligible Grade for OCA,' ELSE NULL END), '')  
         FROM CentralRepository.dbo.vw_CentralRepository_Designation AD WITH(NOLOCK)   
         LEFT OUTER JOIN Policy.GradeMaster PGM WITH(NOLOCK)   
         ON PGM.GradeLevelId=AD.Job_Family AND PGM.RowStatus=1   
         AND PGM.FK_ComponentCountryMappingID=@ComponentCountryMappingID  
         WHERE Convert(varchar,AD.JobCode)=@Grade AND AD.Bussiness_unit=@BU  
  
      UNION ALL  
         
           ------------------- fetch data--------------  
     SELECT DISTINCT COALESCE ((CASE WHEN CONVERT(DATE,NSADate)=CONVERT(DATE,@ShiftstartDate)  
     AND ASSOCIATEID=@ASSOCIATEID and fk_componentid=5   and @ComponentId=5
       and PK_ShiftTimePayoutID  not in (@KeyID)   
       THEN 'Duplicate: Multiple OCA claims on the same shift date,'END ),'')  
         FROM PR.ShiftTimePayout where Rowstatus = 1  
  
     UNION ALL  
  
     Select Distinct 'The allowance claim date falls on Cognizant'+   
     ' declared holiday,already there is a data with Cognizant Holiday with same date' from  
  pr.Shifttimepayout A with (nolock)  
     LEFT OUTER JOIN CentralRepository.dbo.vw_CentralRepository_HCMLocation LOC WITH(NOLOCK)   
  ON LOC.HCMLocationCode=@Location  
     LEFT OUTER JOIN CentralRepository.dbo.VW_CentralRepository_HolidayDate HD WITH(NOLOCK)    
  ON (CONVERT(DATE,HD.HOLIDAY)=CONVERT(DATE,A.Startdate))   
     where  A.Fk_Shifttypeid=7 and @SHIFTTYPE=6 and isnull(HD.HOLIDAY,'')<>''   
  and A.AssociateID=@AssociateID and A.startdate=@startdate and A.enddate=@Enddate  
  and A.Rowstatus=1 and A.status in (1,4)   
  and UPPER(LTRIM(RTRIM(HD.CITY)))=UPPER(LTRIM(RTRIM(LOC.CITY))) and UPPER(LTRIM(RTRIM(A.SetID)))=@BU  
  and UPPER(LTRIM(RTRIM(LOC.HCMLocationCode)))=@Location  
           
--------------- fetch data-----------  
     Union All  
    Select Distinct 'The allowance claim date is a Cognizant declared holiday,'+  
    ' please check the shift type' from  
    CentralRepository.dbo.vw_CentralRepository_HCMLocation LOC WITH(NOLOCK)   
     LEFT OUTER JOIN CentralRepository.dbo.VW_CentralRepository_HolidayDate HD WITH(NOLOCK)   
  ON (CONVERT(DATE,HD.HOLIDAY)=CONVERT(DATE,@Startdate))   
    where @SHIFTTYPE =6 and isnull(HD.HOLIDAY,'')<>'' and LOC.HCMLocationCode=@LOCATION   
    and UPPER(LTRIM(RTRIM(HD.CITY)))=UPPER(LTRIM(RTRIM(LOC.CITY)))

		 UNION ALL
	 ------------- fetch data ------------- 
	  SELECT DISTINCT 'The allowance claim date do not falls on Cognizant declared holiday'
	  FROM CentralRepository.dbo.vw_CentralRepository_HCMLocation LOC WITH(NOLOCK)
	  LEFT OUTER JOIN CentralRepository.dbo.VW_CentralRepository_HolidayDate HD WITH(NOLOCK) 
	  ON HD.LOCATION = LOC.HCMLocationCode 
	  LEFT OUTER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK)
	  ON AD.Associate_ID = CAST(@AssociateID AS CHAR) 
	  WHERE @SHIFTTYPE IN (7) AND ISNULL(HD.HOLIDAY,'') <> '' AND LOC.HCMLocationCode=AD.PresentHCMLocationCode  
	  AND TRIM(HD.CITY) = TRIM(LOC.CITY)
	  AND CAST(@Shiftstartdate AS DATE) NOT IN (SELECT HOLIDAY FROM #HOLIDAYS)
  --------------- fetch data-----------    
     UNION ALL  
     Select Distinct 'The allowance claim date falls on Client declared holiday,'+  
  ' already there is a data with Client Holiday with same date' from  
  pr.Shifttimepayout A with (nolock)  
     LEFT OUTER JOIN dbo.clientholiday HD WITH(NOLOCK)  
  ON (CONVERT(DATE,HD.ClientHolidayDate)=CONVERT(DATE,A.NSADate))   
    where  A.Fk_Shifttypeid=6 and @SHIFTTYPE=7 and isnull(HD.ClientHolidayDate,'')<>''         
  and A.AssociateID=@AssociateID and A.startdate=@startdate and A.enddate=@Enddate        
  and A.ProjectID = HD.ProjectID and A.Rowstatus=1 and A.status in (1,4) and isnull(HD.ClientHolidayDate,'')<>''        
  and HD.Country='IND'   
  
  UNION ALL  
  --------------- fetch data-----------  
  Select Distinct 'The allowance claim date is not a Client declared holiday,'+   
  ' please check the shift type' from  
  dbo.clientholiday HD WITH(NOLOCK)  WHERE   
  --(CONVERT(DATE,HD.ClientHolidayDate)=CONVERT(DATE,@ShiftstartDate)) and   
@SHIFTTYPE =6 and CONVERT(DATE,@ShiftStartDate) not in         
     (select distinct CONVERT(DATE,HD.ClientHolidayDate) from dbo.clientholiday HD WITH(NOLOCK)        
  where ProjectID=@Projectid and HD.Country='IND')    
  
    UNION ALL  
--------------- fetch data-----------  
Select DISTINCT 'Associate should be in office for atleast 30 minutes for OCA'  
         WHERE (DATEDIFF(MINUTE,@STARTDATETIME,@ENDDATETIME) < 30)  
   UNION ALL  
  
   --------------- fetch data-----------  
  SELECT DISTINCT CASE WHEN status in (1,4,12,21,15,34,35) AND PK_ShiftTimePayoutID not in (@KeyID)  
  then'Data was already uploaded for same date' WHEN status=5 THEN 'Data already processed' END  
        FROM pr.ShiftTimePayout  WITH (NOLOCK)  
        WHERE (Startdate = Convert(date,@STARTDATE)   
        AND Fk_ComponentID = @ComponentID AND AssociateID=@AssociateID   
        AND ROWSTATUS=1)OR (NSADate = Convert(date,@ShiftstartDate)   
  AND Fk_ComponentID = @ComponentID AND AssociateID=@AssociateID  
        AND ROWSTATUS=1 and @componentid = 5)  
    
   UNION ALL  
--------------- fetch data-----------  
SELECT DISTINCT CASE WHEN status in (1,4,12,21,15,34,35)   
  then'Allowance has already been claims for the same day under IT component'  
  WHEN status=5 THEN 'Data already processed IT component' END  
  FROM pr.ITShiftAllowance WITH (NOLOCK)  
  WHERE --(STP.Startdate = Convert(date,@STARTDATE) OR   
  (NSADate = Convert(date,@ShiftstartDate))    
  AND Fk_ComponentID=51 AND AssociateID=@AssociateID  
  AND ROWSTATUS=1   
  
  UNION ALL  
  
  --------------- fetch data-----------  
  SELECT DISTINCT CASE WHEN status in (1,4,12,21,15,34,35)   
  then'Allowance has already been claims for the same day under ADM component'   
  WHEN status=5 THEN 'Data already processed ADM component' END  
  FROM pr.ADMShiftAllowance  WITH (NOLOCK)  
  WHERE (NSADate = Convert(date,@ShiftstartDate))    
  AND Fk_ComponentID=171 AND AssociateID=@AssociateID  
  AND ROWSTATUS=1  
  
   UNION ALL  
   --------------- fetch data-----------  
        SELECT DISTINCT (CASE WHEN status in (1,4,12,21,15,34,35,5)   
  then'Overlapping been claims for the same day under ADM component'  END)  
        FROM pr.ADMShiftAllowance WHERE   
        (((StartDateTime BETWEEN @StartDateTime and @EndDateTime)   
  OR (EndDateTime BETWEEN @StartDateTime and @EndDateTime)  
  OR (@StartDateTime BETWEEN StartDateTime and EndDateTime)   
  OR (@EndDateTime BETWEEN StartDateTime and EndDateTime)))  
        AND  Fk_ComponentID=171 AND AssociateID=@AssociateID AND ROWSTATUS=1   
  
        UNION ALL  
  --------------- fetch data-----------  
        SELECT DISTINCT CASE WHEN status in (1,4,12,21,15,34,35,5)   
  then'Overlapping been claims for the same day under IT component'  END  
        FROM pr.ITShiftAllowance WHERE   
        (((StartDateTime BETWEEN @StartDateTime and @EndDateTime)   
  OR (EndDateTime BETWEEN @StartDateTime and @EndDateTime)  
  OR (@StartDateTime BETWEEN StartDateTime and EndDateTime)   
  OR (@EndDateTime BETWEEN StartDateTime and EndDateTime)))  
        AND  Fk_ComponentID=51 AND AssociateID=@AssociateID AND ROWSTATUS=1  
  --------------- fetch data-----------  
   SELECT @Amount=(CASE WHEN @ShiftType in (4,6,7)   
   THEN (SELECT DISTINCT FixedAmount FROM POLICY.GradeAmountMaster NOLOCK   
   WHERE FK_ComponentCountryMappingID=@ComponentCountryMappingID AND RowStatus=1 AND IsWeekDay=0)  
   ELSE (SELECT DISTINCT FixedAmount FROM POLICY.GradeAmountMaster NOLOCK   
   WHERE FK_ComponentCountryMappingID=@ComponentCountryMappingID AND RowStatus=1 AND IsWeekDay=1) END)  
   --------------- fetch data-----------  
    
   Select PST.PK_ShiftTimePayoutID as PRPkID,@AssociateID as AssociateID,  
   @ComponentID as ComponentID,@Amount as newAmount,PST.Amount as PRAmount  
   INTO #ProcessedDataCheck3  
   FROM PR.ShiftTimePayout PST WITH(NOLOCK)  
   WHERE PST.AssociateID=@AssociateID AND PST.FK_ComponentID<>@ComponentID AND  
   (((PST.StartDateTime BETWEEN @StartDateTime and @EndDateTime)  
   OR (PST.EndDateTime BETWEEN @StartDateTime and @EndDateTime)  
   OR (@StartDateTime BETWEEN PST.StartDateTime and PST.EndDateTime)  
   OR (@EndDateTime BETWEEN PST.StartDateTime and PST.EndDateTime) ) AND   
   ((@StartTime BETWEEN PST.StartTime AND '23:59' OR @StartTime BETWEEN '00:00' AND PST.EndTime)   
   OR (@EndTime BETWEEN PST.StartTime AND '23:59' OR @EndTime BETWEEN '00:00' AND PST.EndTime)  
   OR (PST.StartTime BETWEEN @StartTime AND '23:59' OR PST.StartTime BETWEEN '00:00' AND @EndTime)   
   OR (PST.EndTime BETWEEN @StartTime AND '23:59' OR PST.EndTime BETWEEN '00:00' AND @EndTime)) )   
   AND @ComponentID=5 AND PST.Fk_ComponentID=4  
   AND PST.RowStatus=1 AND PST.Status Not in (2,3,8,9,18,17,23,24,36)  
  
   --------------- fetch data-----------  
   Insert into Pr.ShiftTimePayout_log(Fk_Shifttimepayoutid,Associateid,Fk_ComponentID,Fk_ShifttypeID,  
   ProjectID,Startdate,Starttime,Startdatetime,Enddate,  
   Endtime,Enddatetime,Amount,Grade,SpecialCaseReason,inputremarks,RejectReason,RejectedBy,  
   Fk_RejectedRoleID,Status,  
   Setid,Createdby,Createddate,Modifiedby,Modifieddate,Remarks,Rowstatus,LogCreatedby,  
   LogCreateddate,HCMSchedule,Shiftstartdate)  
   --------------- fetch data-----------  
   select PK_ShiftTimePayoutID,PD.AssociateID,Fk_ComponentID,Fk_ShifttypeID,ProjectID,Startdate,Starttime,  
   Startdatetime,Enddate,Endtime,Enddatetime,Amount,Grade,  
   SpecialCaseReason,inputremarks,RejectionReason,RejectedBy,Fk_RejectedRoleID,Status,Setid,  
   Createdby,Createddate,Modifiedby,Modifieddate,Remarks,Rowstatus,@LoginID,getdate(),  
   HCMSchedule,PD.NSADate  
   FROM PR.ShiftTimePayout PD WITH(NOLOCK)  
   INNER JOIN #ProcessedDataCheck3 PTB WITH(NOLOCK) on PD.PK_ShiftTimePayoutID=PTB.PRPkID  
   where PD.Amount<PTB.newAmount and PD.RowStatus=1  
   --------------- fetch data-----------  
   INSERT INTO EXP.ShiftTimePayout (AssociateID, Fk_ComponentID, FK_ShiftTypeID, ProjectID,   
   StartDate, StartTime,   
   EndDate, EndTime,SpecialCaseReason, InputRemarks, ExceptionReason, CreatedBy, CreatedDate,  
   RowStatus,HCMSchedule,Shiftstartdate)  
   SELECT PD.AssociateID,Fk_ComponentID, FK_ShiftTypeID,ProjectID,Startdate,Starttime,Enddate,  
   Endtime,SpecialCaseReason,  
   InputRemarks,'Allowance with higher amount processed as per policy',CreatedBy,CreatedDate,1 ,  
   HCMSchedule,NSADate  
   FROM PR.ShiftTimePayout PD WITH(NOLOCK)  
   INNER JOIN #ProcessedDataCheck3 PTB WITH(NOLOCK) on PD.PK_ShiftTimePayoutID=PTB.PRPkID  
   where PD.Amount<PTB.newAmount and PD.RowStatus=1  
   --------------- fetch data-----------  
   Update PD set PD.RowStatus=0  
   FROM PR.ShiftTimePayout PD WITH(NOLOCK)   
   INNER JOIN #ProcessedDataCheck3 PTB WITH(NOLOCK) on PD.PK_ShiftTimePayoutID=PTB.PRPkID  
   where PD.Amount<PTB.newAmount and PD.RowStatus=1  
  
   INSERT INTO #STPEXCEPTION(EXCEPTIONREASON)  
   --------------- fetch data-----------  
   Select 'Overlapping allowance with higher amount available in valid tab' AS ExceptionReason  
   FROM PR.ShiftTimePayout PD WITH(NOLOCK)   
   INNER JOIN #ProcessedDataCheck3 PTB WITH(NOLOCK) on PD.PK_ShiftTimePayoutID=PTB.PRPkID  
   where PD.Amount>PTB.newAmount and PD.RowStatus=1  
   --------------- fetch data-----------  
   Select PST.PK_ShiftTimePayoutID as PRPkID,@AssociateID as AssociateID,  
   @ComponentID as ComponentID,@Amount as newAmount,PST.Amount as PRAmount  
   INTO #ProcessedDataCheck13  
   FROM PR.ShiftTimePayout PST WITH(NOLOCK)  
   WHERE PST.AssociateID=@AssociateID AND PST.FK_ComponentID<>@ComponentID AND  
   (((PST.StartDateTime BETWEEN @StartDateTime and @EndDateTime)  
   OR (PST.EndDateTime BETWEEN @StartDateTime and @EndDateTime)  
   OR (@StartDateTime BETWEEN PST.StartDateTime and PST.EndDateTime)   
   OR (@EndDateTime BETWEEN PST.StartDateTime and PST.EndDateTime) ) AND   
   ((@StartTime BETWEEN PST.StartTime AND '23:59'   
   OR @StartTime BETWEEN '00:00' AND PST.EndTime)   
   OR (@EndTime BETWEEN PST.StartTime AND '23:59'   
   OR @EndTime BETWEEN '00:00' AND PST.EndTime)  
   OR (PST.StartTime BETWEEN @StartTime AND '23:59'   
   OR PST.StartTime BETWEEN '00:00' AND @EndTime)   
   OR (PST.EndTime BETWEEN @StartTime AND '23:59'  
   OR PST.EndTime BETWEEN '00:00' AND @EndTime)) )   
   AND @ComponentID=5 AND PST.Fk_ComponentID=4  
   AND PST.RowStatus=1 AND PST.Status=5  
  
   INSERT INTO #STPEXCEPTION(EXCEPTIONREASON)  
   --------------- fetch data-----------  
   Select CASE WHEN PTB.PRAmount>PTB.newAmount   
   THEN 'Overlapping allowance with higher amount processed previously'  
   ELSE 'Overlapping allowance processed previously' END   
   AS ExceptionReason  
   FROM #ProcessedDataCheck13 PTB WITH(NOLOCK)  
  
--------------- fetch data-----------  
Select PST.PK_ShiftTimePayoutID as PRPkID,PST.Fk_ComponentID as PTComponentID,  
@AssociateID as AssociateID,@ComponentID as newComponentID  
   INTO #ProcessedDataCheck7  
   FROM PR.ShiftTimePayout PST WITH(NOLOCK)   
   WHERE @AssociateID=PST.AssociateID AND PST.Fk_ComponentID<>@ComponentID  
   and ((@StartDatetime=PST.StartDatetime) AND (@EndDatetime=PST.EndDatetime))  
   AND PST.RowStatus=1 AND PST.Status=1  
  
   IF EXISTS (SELECT PRPkID FROM #ProcessedDataCheck7 with (nolock))  
   BEGIN  
  
    INSERT INTO #STPEXCEPTION(EXCEPTIONREASON)  
  
    SELECT 'Allowances with higher amount processed as per policy' AS ExceptionReason  
  
   END  
  
   Select PST.PK_ShiftTimePayoutID as PRPkID,PST.Fk_ComponentID as PTComponentID,  
   @AssociateID as AssociateID,@ComponentID as newComponentID  
   INTO #ProcessedDataCheck14  
   FROM PR.ShiftTimePayout PST WITH(NOLOCK)   
   WHERE @AssociateID=PST.AssociateID AND PST.Fk_ComponentID<>@ComponentID   
   and ((@StartDatetime=PST.StartDatetime) AND (@EndDatetime=PST.EndDatetime))  
   AND PST.RowStatus=1 AND PST.Status=5  
  
   IF EXISTS (SELECT PRPkID FROM #ProcessedDataCheck14 with (nolock))  
   BEGIN  
  
    INSERT INTO #STPEXCEPTION(EXCEPTIONREASON)  
  
    SELECT 'Overlapping allowances processed previously' AS ExceptionReason  
  
   END  
  
   DROP TABLE #ProcessedDataCheck3  
   DROP TABLE #ProcessedDataCheck7  
   DROP TABLE #ProcessedDataCheck13  
   DROP TABLE #ProcessedDataCheck14  
END  
      
       END      
  END    

  declare @Flag INT,@ApproverId VARCHAR(30)=NULL
  IF(@StatusofRecord=34 OR @StatusofRecordOCA=34)
	BEGIN
		declare @DTable table (ApproverId VARCHAR(20),ApproverName VARCHAR(100),AssociateId VARCHAR(20),Flag INT)

		insert @DTable (ApproverId,ApproverName,AssociateId,Flag)
		exec [dbo].[usp_GetDirectorApprover] @AssociateID
		SELECT @Flag=Flag from @DTable where AssociateId=@AssociateID
		SELECT @ApproverId=ApproverId from @DTable where AssociateId=@AssociateID
		IF(@Flag=0 or isnull(@Flag,'')='' or isnull(@ApproverId,'')='')
		BEGIN
			INSERT INTO #STPEXCEPTION(EXCEPTIONREASON) 
			SELECT DISTINCT 'D+ approver is not mapped for actioning the records.'+
			'Please contact your Reporting Manager/HRSS Team.'
		END			
	END

        DECLARE @SHIFTEXCEPTIONS VARCHAR(8000)  
 SELECT @SHIFTEXCEPTIONS = COALESCE(@SHIFTEXCEPTIONS + ',', '') + ExceptionReason   
 FROM #STPEXCEPTION WHERE ExceptionReason<>''  
 SELECT @SHIFTEXCEPTIONS=REPLACE(@SHIFTEXCEPTIONS,',,',',')  
  
 ------------------- Fetch data --------------  
    DECLARE @Status INT=0  
    SELECT @Status =1 FROM    
    centralrepository.dbo.vw_Centralrepository_HCM_ShiftMgmnt_UserRoles UR WITH (NOLOCK)  
    WHERE Eff_Status='A' and UR.Project_ID=@ProjectID  
  
    DECLARE @Status1 INT=1  
  
IF (@Status1 = 1 AND Convert(date,@ShiftStartdate) >= @ShiftStartDates AND @ComponentID=5)  
  BEGIN  
   ------------------- Fetch data --------------  
  DECLARE @HCMShift VARCHAR(8000)  
   
  EXEC [dbo].[TrueTime_ShiftInsertValidUploader]  @ComponentID ,@AssociateID ,  
  @ProjectID,@ShiftType,@StartDate,@EndDate,@StartTime,@EndTime,@isTravel,@LoginId ,  
  @ShiftStartDate,@SHIFTEXCEPTIONS,@City,@HCMShift OUTPUT   
    
        SELECT @SHIFTEXCEPTIONS = @HCMShift  
    
END  
  
IF(ISNULL(@SHIFTEXCEPTIONS,'')='')  
  BEGIN  
  
     IF(@ComponentID=5)  
    BEGIN  
    ------------------- Fetch data --------------  
     SELECT @Amount=(CASE WHEN @ShiftType in (4,6,7) THEN   
     (SELECT DISTINCT FixedAmount FROM POLICY.GradeAmountMaster NOLOCK   
        WHERE FK_ComponentCountryMappingID=@ComponentCountryMappingID   
        AND RowStatus=1 AND IsWeekDay=0)  
        ELSE (SELECT DISTINCT FixedAmount   
        FROM POLICY.GradeAmountMaster NOLOCK  
        WHERE FK_ComponentCountryMappingID=@ComponentCountryMappingID   
        AND RowStatus=1 AND IsWeekDay=1) END)  
          
    END  
  
 IF(@ComponentID=4)  
    BEGIN  
  
          ------------------- Fetch data --------------   
      SELECT  @Amount=  (CASE WHEN (DATEDIFF(MINUTE,@StartDateTime,@EndDateTime)  
      BETWEEN 0 AND @MINHOURS *60) AND GM.GradeLevelId IS NOT NULL   
      THEN (SELECT GAM.FixedAmount FROM Policy.GradeAmountMaster GAM WITH(NOLOCK)   
      WHERE GAM.RowStatus=1 AND GAM.FK_ComponentCountryMappingID=@ComponentCountryMappingID  
      AND GAM.UptoShiftHour =@MINHOURS   
      AND GAM.GradeLevelId=@GradeLevelID and GAM.SixDayAllowanceEffDate  = @sixthdayEffDAte  
      GROUP BY GAM.FixedAmount)  ---- V1.0  
      WHEN   
      DATEDIFF(MINUTE,@StartDateTime,@EndDateTime)>(@MINHOURS *60)   
      AND GM.GradeLevelId IS NOT NULL THEN  
      (SELECT GAM.FixedAmount FROM Policy.GradeAmountMaster GAM WITH(NOLOCK)   
      WHERE GAM.RowStatus=1 AND GAM.FK_ComponentCountryMappingID=@ComponentCountryMappingID   
      AND GAM.UptoShiftHour =@MAXHOURS   
      AND GAM.GradeLevelId=@GradeLevelID and GAM.SixDayAllowanceEffDate  = @sixthdayEffDAte  
      GROUP BY GAM.FixedAmount)   ---- V1.0   
      END )   
      FROM  CentralRepository.dbo.vw_CentralRepository_Designation AD WITH(NOLOCK)  
      LEFT OUTER JOIN Policy.GradeMaster GM WITH(NOLOCK)   
      ON GM.FK_ComponentCountryMappingID=@ComponentCountryMappingID AND GM.GradeLevelId=AD.Job_Family   
      AND GM.RowStatus=1  
      LEFT OUTER JOIN Policy.GradeAmountMaster GAM WITH(NOLOCK)  
      ON GAM.FK_ComponentCountryMappingID=@ComponentCountryMappingID  
      AND GM.GradeLevelId=Convert(varchar,AD.Job_Family )  
      AND GAM.RowStatus=1  
      WHERE Convert(varchar,AD.JobCode)=@Grade  AND AD.Bussiness_unit=@BU   
      and GAM.SixDayAllowanceEffDate  = @sixthdayEffDAte   ---- V1.0  
  
    END  
      
  Insert into Pr.ShiftTimePayout_log(Fk_Shifttimepayoutid,Associateid,Fk_ComponentID,Fk_ShifttypeID,ProjectID,  
  Startdate,Starttime,Startdatetime,Enddate,Endtime,Enddatetime,Amount,Grade,  
  SpecialCaseReason,inputremarks,RejectReason,RejectedBy,Fk_RejectedRoleID,Status,  
  Setid,Createdby,Createddate,Modifiedby,Modifieddate,Remarks,Rowstatus,LogCreatedby,  
  LogCreateddate,HCMSchedule,Shiftstartdate,AIFlag)  
  
  select PK_ShiftTimePayoutID,AssociateID,Fk_ComponentID,Fk_ShifttypeID,ProjectID,Startdate,Starttime,  
  Startdatetime,Enddate,Endtime,Enddatetime,Amount,Grade,  
  SpecialCaseReason,inputremarks,RejectionReason,RejectedBy,Fk_RejectedRoleID,Status,Setid,  
  Createdby,Createddate,Modifiedby,Modifieddate,Remarks,Rowstatus,@loginid,getdate(),HCMSchedule,NSADate,AIFlag  
  from pr.ShiftTimePayout where PK_ShiftTimePayoutID=@KeyID  

  		-----------------------Project Based GradeAmount
		Declare @GAmount money,@FAmount money,@OwaFlag INT=0
		select @OwaFlag=keyvalue from SPaykeys where KeyCode='OWA Flag'
		IF(@ComponentID=4)
		Begin
			SELECT @GAmount = (CASE WHEN 
			(((DATEDIFF(mi,@StartDateTime,@EndDateTime) BETWEEN 0 AND 270) AND @City NOT IN ('CITYNAME')) OR
			((DATEDIFF(mi,@StartDateTime,@EndDateTime) BETWEEN 0 AND 240) AND @City IN ('CITYNAME'))) 
			then MinAmount
			else MaxAmount end)
			FROM Policy.ProjectGradeAmountMaster  PGM
			INNER JOIN PR.APACProject PP ON PP.ProjectID=PGM.ProjectID AND PP.Rowstatus=1
			AND PGM.FK_ComponentCountryMappingID=PP.Fk_ComponentCountryMappingID
			WHERE EffectiveDate= (select MAX(EffectiveDate) from Policy.ProjectGradeAmountMaster 
			where cast(EffectiveDate as date)<=cast(@startDate as date) and GradeLevelId=@GradeLevelID 
			and ProjectID=@ProjectID and FK_ComponentCountryMappingID=4)
			and GradeLevelId=@GradeLevelID and PGM.ProjectID=@ProjectID and PGM.FK_ComponentCountryMappingID=4
			and PGM.RowStatus=1 and @OwaFlag=1
		end
		else
		Begin
			SELECT @GAmount = (CASE WHEN (@ShiftType in (4,6,7)) then MaxAmount
			else MinAmount end)
			FROM Policy.ProjectGradeAmountMaster  PGM
			INNER JOIN PR.APACProject PP ON PP.ProjectID=PGM.ProjectID AND PP.Rowstatus=1
			AND PGM.FK_ComponentCountryMappingID=PP.Fk_ComponentCountryMappingID
			WHERE EffectiveDate= (select MAX(EffectiveDate) from Policy.ProjectGradeAmountMaster 
			where cast(EffectiveDate as date)<=cast(@startDate as date) and GradeLevelId=@GradeLevelID 
			and ProjectID=@ProjectID and FK_ComponentCountryMappingID=5)
			and GradeLevelId=@GradeLevelID and PGM.ProjectID=@ProjectID and PGM.FK_ComponentCountryMappingID=5
			and PGM.RowStatus=1 and @OwaFlag=1
		end

		select @FAmount=@Amount+isnull(@GAmount,0)
  
  UPDATE PR.ShiftTimePayout SET   
        FK_ShiftTypeID=@ShiftType,  
        ProjectID=@ProjectId,  
    StartDate=@startDate,  
    StartTime=@starttime,  
    StartDateTime=@StartDateTime,  
    EndDate=@Enddate,  
    EndTime=@endtime,  
    EndDateTime=@EndDateTime,  
    NSADATE=@ShiftstartDate,  
    Amount=@FAmount,  
	SDA_OCA_Amount=@Amount,
	SDA_OCA_Amount2=@GAmount,
    Grade=@Grade,  
    SetID=@BU,  
    Modifiedby=@LoginID,  
    ModifiedDate=GETDATE(),  
    RowStatus=1,  
    AIFlag = (CASE WHEN @FlagAI = 1 THEN ISNULL(AIFlag,'') + ' - UPDATED' ELSE AIFlag END),
    Status=(CASE WHEN Status=1 THEN 1 WHEN Status=3 THEN 4 WHEN Status=17 THEN 4    
    WHEN Status=23 THEN 4 When Status=34 then 34 when Status=36 then 34 ELSE Status END),
	D_Id=@ApproverId
    WHERE PK_ShiftTimePayoutID=@KeyID   
  
  SELECT 'Success' AS Status  
      
   END  
  ELSE  
    BEGIN   
    SELECT @SHIFTEXCEPTIONS AS Status  
    END  
  
 DROP TABLE #STPEXCEPTION  
 DROP TABLE #UptoShiftHour  
 END  
 ELSE  
 BEGIN  
  SELECT @SHIFTEXCEPTIONS = @EndDateException  
  SELECT @SHIFTEXCEPTIONS AS Status  
 END
 
