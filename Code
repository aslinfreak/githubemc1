 -----------------------------------------LEAVE CHECK--------------------------------------------------        
       
		  ;WITH cte AS
	   (
 SELECT DISTINCT STP.PK_BPSSDAID,ShiftType, STP.AssociateID,ProjectID,STP.Startdate,Starttime AS Starttime,Enddate,
 Endtime AS Endtime,TransportEligibility,BillingDetails, STP.Grade,SetID, STP.CreatedBy,STP.CreatedDate,
 pld.WF_Status,ROW_NUMBER() OVER (PARTITION BY ELD.Empl_ID,ELD.BGN_DT  ORDER BY ELD.ReceivedDateTime DESC) AS rn 
	   FROM #BPSSDA STP WITH(NOLOCK)	
	   INNER JOIN #STTEMP STT WITH(NOLOCK) ON STT.AssociateID=STP.AssociateID and convert(varchar,STP.startdate)=
	   convert(varchar,STT.startdate)
	   INNER JOIN CentralRepository.dbo.vw_CentralRepository_EAM_LeaveData ELD WITH (NOLOCK)
	   ON STP.AssociateID=ELD.Empl_Id
	   	inner join CentralRepository.dbo.vw_CentralRepository_EAM_perdayLeaveData PLD WITH (NOLOCK)
	   on ELD.empl_id=PLD.emplid
	   WHERE  STP.StartDate between ELD.BGN_DT and ELD.End_DT OR STP.STARTDATE=ELD.BGN_DT
	   AND PLD.absence_date=CONVERT(DATE,STP.StartDate) AND PLD.ct_total_hrs <>0)

SELECT DISTINCT PK_BPSSDAID,AssociateID,ShiftType,ProjectID,Startdate,Starttime AS Starttime,Enddate,Endtime 
AS Endtime,TransportEligibility,BillingDetails, Grade,SetID, case when WF_Status='A' 
then 'Associate is on leave as on claim date' else '' end as ExceptionReason, CreatedBy,CreatedDate
       INTO #LEAVE  FROM cte
WHERE rn = 1  

          INSERT INTO EXP.BPSSDA (ShiftType, AssociateID,StartDate,EndDate,StartTime,EndTime,StartDateTime,
		  EndDateTime, ProjectID,TransportEligibility,BillingDetails,Grade,SetID,ExceptionRemarks,CreatedBy,
		  CreatedDate,RowStatus)
          SELECT ShiftType, AssociateID,CONVERT(VARCHAR,Startdate),CONVERT(VARCHAR,Enddate),Starttime,Endtime,
           CONVERT(DATETIME,(CONVERT(VARCHAR,Startdate)+' '+CONVERT(VARCHAR,Starttime))) AS StartDateTime,
          CONVERT(DATETIME,(CONVERT(VARCHAR,Enddate)+' '+CONVERT(VARCHAR,Endtime))) AS EndDateTime,
           ProjectID,  TRansportEligibility, BillingDetails, Grade, SetID, ExceptionReason,CreatedBy,CreatedDate,1
		   FROM #LEAVE  WITH (NOLOCK) WHERE ISNULL(ExceptionReason,'')<>'' 
         
          DELETE FROM #BPSSDA WHERE PK_BPSSDAID IN (SELECT PK_BPSSDAID FROM #LEAVE WITH(NOLOCK) 
		  WHERE ISNULL(ExceptionReason,'')<>'')

          DROP TABLE #LEAVE

		  ----------------------Set id validations-----------------------------
		  INSERT INTO EXP.BPSSDA (ShiftType, AssociateID, StartDate, EndDate, StartTime, EndTime, StartDateTime,
		  EndDateTime,ProjectID,  TransportEligibility, BillingDetails, Grade, SetID,ExceptionRemarks,CreatedBy,
		  CreatedDate, RowStatus)
          SELECT ShiftType, AssociateID,CONVERT(VARCHAR,Startdate),CONVERT(VARCHAR,Enddate),Starttime,Endtime,
           CONVERT(DATETIME,(CONVERT(VARCHAR,Startdate)+' '+CONVERT(VARCHAR,Starttime))) AS StartDateTime,
          CONVERT(DATETIME,(CONVERT(VARCHAR,Enddate)+' '+CONVERT(VARCHAR,Endtime))) AS EndDateTime,
        SM.ProjectID, TRansportEligibility, BillingDetails, Grade, SM.SetId, 
		'Setid is not configured for this component',SM.CreatedBy,SM.CreatedDate,1
		 FROM Policy.SetIdMaster SM WITH (NOLOCK)       
		LEFT OUTER JOIN #BPSSDA A WITH (NOLOCK) on A.SetID=SM.SetId AND SM.FK_ComponentCountryMappingID=
		@ComponentCountryMappingID and SM.Rowstatus=1  
		WHERE isnull(SM.SetId,'')='' 
		
       DELETE  A FROM Policy.SetIdMaster SM WITH (NOLOCK)       
		LEFT OUTER JOIN #BPSSDA A WITH (NOLOCK) on A.SetID=SM.SetId AND 
		SM.FK_ComponentCountryMappingID=@ComponentCountryMappingID and SM.Rowstatus=1  
		WHERE isnull(SM.SetId,'')=''  
		     ------------------------InEligible ACcount check----------------------------------
           INSERT INTO EXP.BPSSDA(ShiftType, AssociateID, StartDate, EndDate, StartTime, EndTime, StartDateTime,
		   EndDateTime,ProjectID, TransportEligibility, BillingDetails,Grade, SetID,ExceptionRemarks,CreatedBy,
		   CreatedDate, RowStatus)      
         
           SELECT ShiftType, AssociateID,CONVERT(VARCHAR,Startdate),CONVERT(VARCHAR,Enddate),Starttime,Endtime,
         CONVERT(DATETIME,(CONVERT(VARCHAR,Startdate)+' '+CONVERT(VARCHAR,Starttime))) AS StartDateTime,
          CONVERT(DATETIME,(CONVERT(VARCHAR,Enddate)+' '+CONVERT(VARCHAR,Endtime))) AS EndDateTime,
            B.ProjectID, TransportEligibility, BillingDetails,Grade, A.SetID,
			'Ineligible Account' AS  ExceptionReason,
			A.CreatedBy,A.CreatedDate,1 FROM #BPSSDA A WITH (NOLOCK) 
               INNER JOIN @StagingProjectID B ON  A.Pk_BPSSDAID=B.Pk_BPSSDAID
              LEFT OUTER JOIN Policy.AccountMaster AM WITH (NOLOCK) on AM.CustomerID=B.CustomerID  and AM.Rowstatus=1 
			  AND AM.FK_ComponentCountryMappingID=@ComponentCountryMappingID
              WHERE AM.CustomerID is null                 

          DELETE A FROM #BPSSDA A
          INNER JOIN @StagingProjectID B ON A.ProjectID=B.ProjectID and A.PK_BPSSDAID=B.Pk_BPSSDAID
          LEFT OUTER JOIN Policy.AccountMaster AM WITH (NOLOCK) on AM.CustomerID=B.CustomerID  and AM.Rowstatus=1 
		  AND AM.FK_ComponentCountryMappingID=@ComponentCountryMappingID
          WHERE AM.CustomerID is null
