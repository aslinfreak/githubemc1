USE [OneC_SPay]
GO
Declare
@ComponentGrpID INT=5,  
@COMPONENTID INT=8,  
@MONTH INT=1,  
@YEAR INT='2026',  
@LOGINID INT='2084470',  
@RoleID int=2,  
@CountryId int =1,  
@Componentgrp varchar(500)=null  
   
-----------Declaring Temp Variables---------------  
Declare @RolePriority int  
Create table #RoleTable(Fk_RoleID int)  
  
declare @CustomerID varchar(20)  
Declare  @CustomerBPS table(CustomerID varchar(20))  
Declare @Project table(CustomerID varchar(20),ProjectId varchar(20))  
DECLARE @Uploader TABLE (CustomerID VARCHAR(10),ProjectID VARCHAR(20))  
DECLARE @Customer TABLE (CustomerID VARCHAR(10),ProjectID VARCHAR(20))  
  
--Notice Pay Buy out-payout  
  IF(@COMPONENTID=1)  
 BEGIN   
  SELECT PNP.PK_NoticePayID As UniqueID,PNP.AssociateID,ISNULL(LTRIM(RTRIM(AD.Associate_FirstName)),'')+' '+  
  ISNULL(LTRIM(RTRIM(AD.Associate_LastName)),'') AS NAME,  
   AD.JobCode+' - '+DESG.JobCodeDescription AS GRADE,  
  REPLACE(CONVERT(VARCHAR(11), AD.DateOfJoining, 106), ' ', '-') AS DateOfJoining,PNP.Amount,  
  LOC.City AS  PresentHCMLocationCode,PNP.ProjectId,PNP.CompanyId,PNP.SetId,  
  PNP.InputRemarks AS REMARKS , (CASE WHEN PNP.Status=1 THEN 'Valid'    
  WHEN PNP.Status=4 THEN 'Resubmitted' WHEN PNP.Status=10 THEN 'Resubmitted after PFSS Rejection'    
  WHEN PNP.Status=5 THEN 'Processed' END) AS STATUS,PNP.AdvisedBy,  
  ISNULL(LTRIM(RTRIM(UD.Associate_FirstName)),'')+' '+  
  ISNULL(LTRIM(RTRIM(UD.Associate_LastName)),'') AS UploaderName,  
  Case When isnull(PNP.Modifieddate,'')<>'' then PNP.ModifiedDate else PNP.Createddate end UploadedDate,   
  (CASE WHEN PNP.SpecialCaseReason='7' THEN 'Approved Payment'  ELSE '' END) AS SpecialCaseReason  
  FROM PR.NoticePay PNP WITH(NOLOCK)   
  LEFT OUTER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK)   
  ON CONVERT(VARCHAR,AD.Associate_ID)=CONVERT(VARCHAR,PNP.AssociateID)  
  LEFT OUTER JOIN CentralRepository.dbo.vw_CentralRepository_Designation DESG WITH(NOLOCK)   
  ON DESG.JobCode=AD.JobCode   
  AND DESG.Bussiness_unit=AD.Business_Unit   
  LEFT OUTER JOIN CENTRALREPOSITORY.DBO.VW_CENTRALREPOSITORY_HCMLOCATION LOC WITH(NOLOCK)   
  ON LOC.HCMLocationCode=AD.PresentHCMLocationCode   
  AND LOC.Business_Unit=AD.Business_Unit   
  LEFT OUTER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details UD WITH(NOLOCK)   
  ON CONVERT(VARCHAR,UD.Associate_ID)=CONVERT(VARCHAR,PNP.AdvisedBy)  
  WHERE PNP.Status IN (1,5) AND PNP.RowStatus=1   
  AND ((DATEPART(MM,PNP.CreatedDate)=@Month  AND DATEPART(YY,PNP.CreatedDate)=@Year)  
  OR(DATEPART(MM,PNP.ModifiedDate)=@Month  AND DATEPART(YY,PNP.ModifiedDate)=@Year))  
  END  
    
 -- Referral Bonus-payout  
  IF(@COMPONENTID=2)  
 BEGIN   
  
  SELECT PRB.PK_ReferralBonusID As UniqueID,PRB.ReferrorAssociateID,  
  ISNULL(LTRIM(RTRIM(CD.Associate_FirstName)),'')+' '+  
  ISNULL(LTRIM(RTRIM(CD.Associate_LastName)),'') AS REFERRORNAME,  
  REPLACE(CONVERT(VARCHAR(11), CD.DateOfJoining, 106), ' ', '-') AS REFERRORDOJ,  
  REFERRERPRESENT.JobCode+' - '+REFERRERPRESENT.JobCodeDescription AS ReferrorLevel,    
  REFERRERPRESENTDEP.Dept_Desc AS ReferrorDepartment,REFERRERPAST.JobCode+' - '+  
  REFERRERPAST.JobCodeDescription AS ReferrorLevelWhileReferring,  
  REFERRERPASTDEP.Dept_Desc AS ReferrorDepartmentWhileReferring,CD.Company AS REFERRERCOMPANY,  
  LOC.City AS LOC_OF_REFERRER,  
  PRB.ReferrerSetID AS REFERRER_SETID,  
  (CASE WHEN PRB.ReferrorBGstatus='1' THEN 'Positive'   
    WHEN PRB.ReferrorBGstatus='2' THEN 'Negative'  
                WHEN PRB.ReferrorBGstatus='3' THEN 'WIP'        
                WHEN PRB.ReferrorBGstatus='4' THEN 'NA'   
                ELSE '' END) AS ReferrorBGstatus,   
  PRB.RefereeAssociateID AS REFREEID,  
  ISNULL(LTRIM(RTRIM(AD.Associate_FirstName)),'')+' '+  
  ISNULL(LTRIM(RTRIM(AD.Associate_LastName)),'') AS REFEREENAME,  
  CONVERT(VARCHAR,PRB.RefereeDOJ,101) AS RefereeDOJ,    
  REFEREE.JobCode+' - '+REFEREE.JobCodeDescription AS REFREEGRADECODE,    
  REFEREEDEP.Dept_Desc  AS RefereeDepartment,LOC_A.City AS LOC_OF_REFREE,PRB.ProjectId,  
  (CASE WHEN PRB.RefereeBGstatus='1' THEN 'Positive'   
          WHEN PRB.RefereeBGstatus='2' THEN 'Negative'  
                      WHEN PRB.RefereeBGstatus='3' THEN 'WIP'        
                      WHEN PRB.RefereeBGstatus='4' THEN 'NA'   
                      ELSE '' END) AS RefereeBGstatus,PRB.Amount,PPM.Currency,   
  MCRB.CDescription AS SpecialCaseReason,
  (CASE WHEN PRB.Status=1 THEN 'Valid' WHEN PRB.Status=4 THEN 'Resubmitted' WHEN PRB.Status=5 THEN 'Processed'   
  WHEN PRB.Status=10 THEN 'Resubmitted after PFSS Rejection' END) AS STATUS,  
  PRB.Createdby AdvisedBy, ISNULL(LTRIM(RTRIM(UD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(  
  UD.Associate_LastName)),'')  
  AS UploaderName,  
  Case when isnull(PRB.Modifieddate,'')<>'' then PRB.ModifiedDate else PRB.CreatedDate end UploadedDate      
  FROM PR.ReferralBonus PRB WITH(NOLOCK)   
    INNER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK)   
    ON CONVERT(VARCHAR,AD.Associate_ID)=CONVERT(VARCHAR,PRB.RefereeAssociateID)  
    INNER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details CD WITH(NOLOCK)   
    ON CONVERT(VARCHAR,CD.Associate_ID)=CONVERT(VARCHAR,PRB.ReferrorAssociateID)  
    LEFT OUTER  JOIN Policy.PolicyMaster PPM WITH(NOLOCK) ON PPM.FK_ComponentID=2  
    LEFT OUTER JOIN CENTRALREPOSITORY.DBO.VW_CENTRALREPOSITORY_HCMLOCATION LOC_A WITH(NOLOCK)   
    ON LOC_A.HCMLocationCode=AD.PresentHCMLocationCode   
    AND LOC_A.Business_Unit=AD.Business_Unit   
    LEFT OUTER JOIN CENTRALREPOSITORY.DBO.VW_CENTRALREPOSITORY_HCMLOCATION LOC WITH(NOLOCK)  
    ON LOC.HCMLocationCode=CD.PresentHCMLocationCode   
    AND LOC.Business_Unit=CD.Business_Unit     
    LEFT OUTER JOIN CentralRepository.dbo.vw_CentralRepository_Designation REFERRERPAST WITH(NOLOCK)  
    ON CONVERT(VARCHAR,REFERRERPAST.JobCode)=PRB.ReferrorGrade    
    AND REFERRERPAST.Bussiness_unit=PRB.ReferrerSetID       
    LEFT OUTER JOIN CentralRepository.dbo.vw_CentralRepository_Designation REFERRERPRESENT WITH(NOLOCK)   
    ON REFERRERPRESENT.JobCode=CD.JobCode   
    AND REFERRERPRESENT.Bussiness_unit=CD.Business_Unit       
    LEFT OUTER JOIN CentralRepository.dbo.vw_CentralRepository_Designation REFEREE WITH(NOLOCK)   
    ON REFEREE.JobCode=AD.JobCode  
    AND REFEREE.Bussiness_unit=AD.Business_Unit         
    LEFT OUTER JOIN CentralRepository.dbo.vw_CentralRepository_Department REFERRERPASTDEP WITH(NOLOCK)  
    on CONVERT(VARCHAR,REFERRERPASTDEP.Dept_ID)=PRB.ReferrorDepartment  
    AND REFERRERPASTDEP.Business_Unit=PRB.ReferrerSetID        
    LEFT OUTER JOIN CentralRepository.dbo.vw_CentralRepository_Department REFERRERPRESENTDEP WITH(NOLOCK)  
    on CONVERT(VARCHAR,REFERRERPRESENTDEP.Dept_ID)=CD.Dept_ID  
    AND REFERRERPRESENTDEP.Business_Unit=CD.Business_Unit           
    LEFT OUTER JOIN CentralRepository.dbo.vw_CentralRepository_Department REFEREEDEP WITH(NOLOCK)   
    on CONVERT(VARCHAR,REFEREEDEP.Dept_ID)=AD.Dept_ID  
    AND REFEREEDEP.Business_Unit=AD.Business_Unit     
    LEFT OUTER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details UD WITH(NOLOCK)   
    ON CONVERT(VARCHAR,UD.Associate_ID)=CONVERT(VARCHAR,PRB.Createdby)  
    LEFT JOIN MasterCodes MCRB WITH(NOLOCK) ON MCRB.CCodeID=PRB.SpecialCaseReason  
	AND MCRB.cparentref=2 and MCRB.CUserDefined1=2 and MCRB.remarks IS NULL
	WHERE PRB.Status IN (1,4,5) AND PRB.RowStatus=1 AND ((DATEPART(MM,PRB.CreatedDate)=@Month   
    AND DATEPART(YY,PRB.CreatedDate)=@Year) OR   
    (DATEPART(MM,PRB.ModifiedDate)=@Month  AND DATEPART(YY,PRB.ModifiedDate)=@Year))  
    
  END    
   
 --Joining Bonus-payout  
  IF(@COMPONENTID=3)  
 BEGIN   
   
  SELECT PJB.PK_JoiningBonusID As UniqueID,PJB.AssociateID,  
  ISNULL(LTRIM(RTRIM(AD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(AD.Associate_LastName)),'') AS Name,  
  DESG.JobCode+' - '+DESG.JobCodeDescription AS GRADE,  
  REPLACE(CONVERT(VARCHAR(11), AD.DateOfJoining, 106), ' ', '-') AS DateOfJoining,PJB.Amount,    
  (CASE WHEN PJB.NoInstallments = '0' THEN NULL 
   ELSE PJB.NoInstallments END) as NoOfInstallments,ISNULL(PJB.RetentionPeriod,0) AS RetentionPeriod,
  (CASE WHEN PJB.BGstatus='1' THEN 'Positive'   
          WHEN PJB.BGstatus='2' THEN 'Negative'  
                      WHEN PJB.BGstatus='3' THEN 'WIP'        
                      WHEN PJB.BGstatus='4' THEN 'NA'   
                      ELSE '' END) AS BGstatus,MC_B.CDescription AS RecruitmentType,     
  LOC.City AS LOCATION,PJB.ProjectId,  
  MCJB.CDescription AS SpecialCaseReason,
  PJB.InputRemarks AS REMARKS,PJB.CompanyID,PJB.SetID AS SETID,  
  (CASE WHEN PJB.Status=1 THEN 'Valid' WHEN PJB.Status=4 THEN 'Resubmitted'   
  WHEN PJB.Status=5 THEN 'Processed' WHEN PJB.Status=10 THEN 'Resubmitted after PFSS Rejection' END) AS STATUS,  
  PJB.CreatedBy UploadedBy,ISNULL(LTRIM(RTRIM(UD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(  
  UD.Associate_LastName)),'')  
  AS UploaderName,Case when isnull(PJB.Modifieddate,'')<>''   
  then PJB.ModifiedDate else PJB.CreatedDate end UploadedDate   
   FROM PR.JoiningBonus PJB WITH(NOLOCK)   
   INNER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK)   
   ON CONVERT(VARCHAR,AD.Associate_ID)=CONVERT(VARCHAR,PJB.AssociateID)  
   INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details UD WITH(NOLOCK)   
   ON CONVERT(VARCHAR,UD.Associate_ID)=CONVERT(VARCHAR,PJB.Createdby)  
   INNER JOIN MasterCodes MC_B WITH (NOLOCK)  
   ON MC_B.CCodeId = RecruitmentType AND MC_B.CParentRef = 5   
   AND MC_B.RowStatus = 1       
   LEFT OUTER JOIN CENTRALREPOSITORY.DBO.VW_CENTRALREPOSITORY_HCMLOCATION LOC WITH(NOLOCK)   
   ON LOC.HCMLocationCode=AD.PresentHCMLocationCode   
   AND LOC.Business_Unit=AD.Business_Unit   
   LEFT OUTER JOIN CentralRepository.dbo.vw_CentralRepository_Designation DESG WITH(NOLOCK)   
   ON CONVERT(VARCHAR,DESG.JobCode)=PJB.Grade   
   AND DESG.Bussiness_unit=PJB.SetID  
   LEFT JOIN MasterCodes MCJB WITH(NOLOCK) ON MCJB.CCodeID=PJB.SpecialCaseReason  
	AND MCJB.cparentref=2 and MCJB.CUserDefined1=3
   WHERE PJB.Status IN (1,4,5) AND PJB.RowStatus=1 AND ((DATEPART(MM,PJB.CreatedDate)=@Month   
   AND DATEPART(YY,PJB.CreatedDate)=@Year) OR  
   (DATEPART(MM,PJB.ModifiedDate)=@Month  AND DATEPART(YY,PJB.ModifiedDate)=@Year))  
    
  END      
    
-- CIS 6DA,OCA,NSA  
  IF(@Componentid in (4,5,6))  
     BEGIN  
          --Project Manager  
          IF(@Componentid=6 and @RoleID in (6,5))  
            BEGIN  
             CREATE TABLE #COMPONENTS (ComponentID INT,ProjectID VARCHAR(50))    
       --Inserting Components data  
       INSERT INTO #COMPONENTS (ComponentID ,ProjectID)     
       EXEC [dbo].[usp_GetComponentsForRole] @RoleID,@LoginID,@ComponentGrpID,@CountryID    
        
            SELECT STP.PK_ShiftTimePayoutID AS UniqueID,STP.AssociateID,  
      ISNULL(LTRIM(RTRIM(AD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(  
      AD.Associate_LastName)),'') AS AssociateName ,  
      STP.ProjectID,CM.ComponentShortName AS AllowanceType,STM.ShiftTypeName AS ShiftType,  
      CONVERT(VARCHAR,STP.STARTDATE,101) AS StartDate,  
         CONVERT(VARCHAR,STP.EndDate,101) AS Enddate,  
      CONVERT(VARCHAR(5),DATEDIFF(S, STP.StartDateTime, STP.EndDateTime)/3600)+':'+CONVERT(VARCHAR(5),  
      DATEDIFF(S, STP.StartDateTime, STP.EndDateTime)%3600/60) AS TotalHours,  
      STP.Amount AS EligibleAmount, STP.CreatedBy AS UploaderID,  
      ISNULL(LTRIM(RTRIM(UD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(UD.Associate_LastName)),'') AS    
   UploaderName,  
      Case when isnull(STP.Modifieddate,'')<>'' then STP.Modifieddate else STP.Createddate end UploadedDate,  
      CPM.PROJECT_MANAGER AS PMID,  
      ISNULL(LTRIM(RTRIM(PD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(PD.Associate_LastName)),'') AS PMName,   
      (CASE WHEN STP.Status=1 THEN 'Valid' WHEN STP.Status=5 THEN 'Processed'    
      WHEN STP.Status=4 THEN 'ReSubmitted'  
      END) AS Status ,  
   STP.NSADate AS ShiftStartDate,  
      RNSA.RecalledComments, RNSA.ModifiedStartDateTime, RNSA.ModifiedEndDateTime  
      FROM PR.ShiftTimePayout STP WITH(NOLOCK)   
      INNER JOIN ShiftTypeMaster STM WITH(NOLOCK) ON STM.PK_ShiftTypeID=STP.FK_ShiftTypeID  
      INNER JOIN ComponentMaster CM WITH(NOLOCK) ON CM.PK_ComponentId=STP.Fk_ComponentID  
      INNER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK)   
      ON CONVERT(VARCHAR,AD.Associate_ID)=CONVERT(VARCHAR,STP.AssociateID)  
      INNER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details UD WITH(NOLOCK)   
      ON CONVERT(VARCHAR,UD.Associate_ID)=CONVERT(VARCHAR,STP.CreatedBy)  
      LEFT OUTER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Current_ProjectManager CPM WITH(NOLOCK)   
      ON CONVERT(VARCHAR,CPM.PROJECT_ID)=STP.ProjectID  
      INNER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details PD WITH(NOLOCK)   
      ON PD.Associate_ID=CPM.PROJECT_MANAGER  
      INNER JOIN #COMPONENTS CMTS WITH(NOLOCK) ON  CMTS.ComponentID=STP.Fk_ComponentID  
      AND CMTS.ProjectID=STP.ProjectID  
      LEFT JOIN PR.Trutime_Recalled_NSA RNSA ON RNSA.AssociateID = STP.AssociateID AND RNSA.Date = STP.NSADate  
      AND RNSA.Fk_ComponentID = STP.Fk_ComponentID AND RNSA.ProjectID = STP.ProjectID AND RNSA.RowStatus = 1  
      WHERE STP.Status IN (1,5,4) AND STP.RowStatus=1 AND ((DATEPART(MM,STP.CreatedDate)=@Month   
      AND DATEPART(YY,STP.CreatedDate)=@Year)OR  
      (DATEPART(MM,STP.ModifiedDate)=@Month  AND DATEPART(YY,STP.ModifiedDate)=@Year))  
      and CM.Pk_ComponentID=@Componentid  
        
      DROP TABLE  #COMPONENTS   
            END  
          ELSE IF(@Componentid not in (6) and @RoleID=6)  
         BEGIN  
      CREATE TABLE #COMPONENTSP (ComponentID INT,ProjectID VARCHAR(50))    
      --Inserting Components data  
      INSERT INTO #COMPONENTSP (ComponentID ,ProjectID)     
      EXEC [dbo].[usp_GetComponentsForRole] @RoleID,@LoginID,@ComponentGrpID,@CountryID    
              
        
      SELECT STP.AssociateID,ISNULL(LTRIM(RTRIM(AD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(  
      AD.Associate_LastName)),'') AS AssociateName ,  
      STP.ProjectID,CM.ComponentShortName AS AllowanceType,STM.ShiftTypeName AS ShiftType,  
      CONVERT(VARCHAR,STP.STARTDATE,101) AS StartDate,  
      STP.StartTime, CONVERT(VARCHAR,STP.EndDate,101) AS Enddate,STP.EndTime,  
   ISNULL(STP.HCMSchedule,'') AS HCMShift,  
      CONVERT(VARCHAR(5),DATEDIFF(S, STP.StartDateTime, STP.EndDateTime)/3600)+':'+CONVERT(VARCHAR(5),  
      DATEDIFF(S, STP.StartDateTime, STP.EndDateTime)%3600/60) AS TotalHours,  
      STP.Amount AS EligibleAmount, STP.CreatedBy AS UploaderID,  
      ISNULL(LTRIM(RTRIM(UD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(UD.Associate_LastName)),'')   
   AS UploaderName,  
      Case when isnull(STP.Modifieddate,'')<>'' then STP.Modifieddate else STP.Createddate end UploadedDate,  
      CPM.PROJECT_MANAGER AS PMID,  
      ISNULL(LTRIM(RTRIM(PD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(PD.Associate_LastName)),'') AS PMName,   
      (CASE WHEN STP.Status=1 THEN 'Valid' WHEN STP.Status=5 THEN 'Processed'    
      WHEN STP.Status=4 THEN 'ReSubmitted'  
      END) AS Status ,  
      STP.NSADate AS ShiftStartDate  
      FROM PR.ShiftTimePayout STP WITH(NOLOCK)   
      INNER JOIN ShiftTypeMaster STM WITH(NOLOCK) ON STM.PK_ShiftTypeID=STP.FK_ShiftTypeID  
      INNER JOIN ComponentMaster CM WITH(NOLOCK) ON CM.PK_ComponentId=STP.Fk_ComponentID  
      INNER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK)   
      ON CONVERT(VARCHAR,AD.Associate_ID)=CONVERT(VARCHAR,STP.AssociateID)  
      INNER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details UD WITH(NOLOCK)   
      ON CONVERT(VARCHAR,UD.Associate_ID)=CONVERT(VARCHAR,STP.CreatedBy)  
      LEFT OUTER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Current_ProjectManager CPM WITH(NOLOCK)   
      ON CONVERT(VARCHAR,CPM.PROJECT_ID)=STP.ProjectID  
      INNER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details PD WITH(NOLOCK)   
      ON PD.Associate_ID=CPM.PROJECT_MANAGER  
      INNER JOIN #COMPONENTSP CMTS WITH(NOLOCK) ON  CMTS.ComponentID=STP.Fk_ComponentID  
      AND CMTS.ProjectID=STP.ProjectID  
      WHERE STP.Status IN (1,5,4) AND STP.RowStatus=1 AND ((DATEPART(MM,STP.CreatedDate)=@Month   
      AND DATEPART(YY,STP.CreatedDate)=@Year)OR  
      (DATEPART(MM,STP.ModifiedDate)=@Month  AND DATEPART(YY,STP.ModifiedDate)=@Year))  
      and CM.Pk_ComponentID=@Componentid  
              --END  
        --Drops the temp table  
      DROP TABLE  #COMPONENTSP   
  
         END   
          ELSE  
         BEGIN  
         --CIS On Call Allowance  
      IF(@Componentid=5 and @RoleID in(3,2))  
        BEGIN  
     SELECT STP.PK_ShiftTimePayoutID AS UniqueID,STP.AssociateID,ISNULL(LTRIM(RTRIM(AD.Associate_FirstName)),'')+' '+  
     ISNULL(LTRIM(RTRIM(AD.Associate_LastName)),'') AS AssociateName ,  
     STP.ProjectID,CM.ComponentShortName AS AllowanceType,STM.ShiftTypeName AS ShiftType,  
     CONVERT(VARCHAR,STP.STARTDATE,101) AS StartDate,  
     STP.StartTime, CONVERT(VARCHAR,STP.EndDate,101) AS Enddate,STP.EndTime,ISNULL(STP.HCMSchedule,'') AS HCMShift,  
     CONVERT(VARCHAR(5),DATEDIFF(S, STP.StartDateTime, STP.EndDateTime)/3600)+':'+CONVERT(VARCHAR(5),  
     DATEDIFF(S, STP.StartDateTime, STP.EndDateTime)%3600/60) AS TotalHours,ISNULL(SDA_OCA_Amount,0) AS SDA_OCA_Amount1,  
     ISNULL(SDA_OCA_Amount2,0) AS SDA_OCA_Amount2,  
     STP.Amount AS TotalAmount, STP.CreatedBy AS UploaderID,  
     ISNULL(LTRIM(RTRIM(UD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(UD.Associate_LastName)),'')   
     AS UploaderName,  
     Case when isnull(STP.Modifieddate,'')<>'' then STP.Modifieddate else STP.Createddate end UploadedDate,  
     CPM.PROJECT_MANAGER AS PMID,  
     ISNULL(LTRIM(RTRIM(PD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(PD.Associate_LastName)),'') AS PMName,   
     (CASE WHEN STP.Status=1 THEN 'Valid'   
     WHEN STP.Status=5 THEN 'Processed'    
     WHEN STP.Status=4 THEN 'ReSubmitted'  
     WHEN STP.Status=20 THEN 'Resubmitted after Project Manager Rejection'   
     WHEN STP.Status=10 THEN 'Resubmitted after PFSS Rejection'   
     WHEN STP.Status=21 THEN 'Approved by Home Manager'   
     WHEN STP.Status=15 THEN 'Approved by Project Manager'   
     WHEN STP.Status=34 THEN 'Pending for D+ Approval'  
     WHEN STP.Status=35 THEN 'Approved by D+' END) AS Status ,STP.NSADate AS ShiftStartDate  
     FROM PR.ShiftTimePayout STP WITH(NOLOCK)   
     INNER JOIN ShiftTypeMaster STM WITH(NOLOCK) ON STM.PK_ShiftTypeID=STP.FK_ShiftTypeID  
     INNER JOIN ComponentMaster CM WITH(NOLOCK) ON CM.PK_ComponentId=STP.Fk_ComponentID  
     INNER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK)   
     ON CONVERT(VARCHAR,AD.Associate_ID)=CONVERT(VARCHAR,STP.AssociateID)  
     INNER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details UD WITH(NOLOCK)   
     ON CONVERT(VARCHAR,UD.Associate_ID)=CONVERT(VARCHAR,STP.CreatedBy)  
     LEFT OUTER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Current_ProjectManager CPM WITH(NOLOCK)   
     ON CONVERT(VARCHAR,CPM.PROJECT_ID)=STP.ProjectID  
     INNER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details PD WITH(NOLOCK)   
     ON PD.Associate_ID=CPM.PROJECT_MANAGER  
     WHERE STP.Status IN (4,5,15,21,34,35) AND STP.RowStatus=1 AND ((DATEPART(MM,STP.CreatedDate)=@Month   
     AND DATEPART(YY,STP.CreatedDate)=@Year) OR   
     (DATEPART(MM,STP.ModifiedDate)=@Month  AND DATEPART(YY,STP.ModifiedDate)=@Year))  
     and CM.PK_Componentid=@componentid  
    
        END  
   ELSE IF(@Componentid=5 and @RoleID!=3)  
        BEGIN  
     SELECT STP.PK_ShiftTimePayoutID AS UniqueID,STP.AssociateID,ISNULL(LTRIM(RTRIM(AD.Associate_FirstName)),'')+' '+  
     ISNULL(LTRIM(RTRIM(AD.Associate_LastName)),'') AS AssociateName ,  
     STP.ProjectID,CM.ComponentShortName AS AllowanceType,STM.ShiftTypeName AS ShiftType,  
     CONVERT(VARCHAR,STP.STARTDATE,101) AS StartDate,  
     STP.StartTime, CONVERT(VARCHAR,STP.EndDate,101) AS Enddate,STP.EndTime,ISNULL(STP.HCMSchedule,'') AS HCMShift,  
     CONVERT(VARCHAR(5),DATEDIFF(S, STP.StartDateTime, STP.EndDateTime)/3600)+':'+CONVERT(VARCHAR(5),  
     DATEDIFF(S, STP.StartDateTime, STP.EndDateTime)%3600/60) AS TotalHours,  
     STP.Amount AS EligibleAmount, STP.CreatedBy AS UploaderID,  
     ISNULL(LTRIM(RTRIM(UD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(UD.Associate_LastName)),'')   
     AS UploaderName,  
     Case when isnull(STP.Modifieddate,'')<>'' then STP.Modifieddate else STP.Createddate end UploadedDate,  
     CPM.PROJECT_MANAGER AS PMID, AD.Supervisor_ID as HMID,
     ISNULL(LTRIM(RTRIM(PD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(PD.Associate_LastName)),'') AS PMName,
	  ISNULL(LTRIM(RTRIM(HM.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(HM.Associate_LastName)),'') AS HMName,
     (CASE WHEN STP.Status=1 THEN 'Valid'   
     WHEN STP.Status=5 THEN 'Processed'    
     WHEN STP.Status=4 THEN 'ReSubmitted'  
     WHEN STP.Status=20 THEN 'Resubmitted after Project Manager Rejection'   
     WHEN STP.Status=10 THEN 'Resubmitted after PFSS Rejection'   
     WHEN STP.Status=21 THEN 'Approved by Home Manager'   
     WHEN STP.Status=15 THEN 'Approved by Project Manager'   
     WHEN STP.Status=34 THEN 'Pending for D+ Approval'  
     WHEN STP.Status=35 THEN 'Approved by D+' END) AS Status ,STP.NSADate AS ShiftStartDate  
     FROM PR.ShiftTimePayout STP WITH(NOLOCK)   
     INNER JOIN ShiftTypeMaster STM WITH(NOLOCK) ON STM.PK_ShiftTypeID=STP.FK_ShiftTypeID  
     INNER JOIN ComponentMaster CM WITH(NOLOCK) ON CM.PK_ComponentId=STP.Fk_ComponentID  
     INNER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK)   
     ON CONVERT(VARCHAR,AD.Associate_ID)=CONVERT(VARCHAR,STP.AssociateID)  
     INNER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details UD WITH(NOLOCK)   
     ON CONVERT(VARCHAR,UD.Associate_ID)=CONVERT(VARCHAR,STP.CreatedBy)  
     LEFT OUTER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Current_ProjectManager CPM WITH(NOLOCK)   
     ON CONVERT(VARCHAR,CPM.PROJECT_ID)=STP.ProjectID  
     INNER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details PD WITH(NOLOCK)   
     ON PD.Associate_ID=CPM.PROJECT_MANAGER 
	 INNER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details HM WITH(NOLOCK)   
     ON AD.Supervisor_ID=HM.Associate_ID
     WHERE STP.Status IN (1,4,5,15,21,34,35) AND STP.RowStatus=1 AND ((DATEPART(MM,STP.CreatedDate)=@Month   
     AND DATEPART(YY,STP.CreatedDate)=@Year) OR   
     (DATEPART(MM,STP.ModifiedDate)=@Month  AND DATEPART(YY,STP.ModifiedDate)=@Year))  
     and CM.PK_Componentid=@componentid and STP.Createdby=@Loginid
    
        END  
      --CIS Night Shift Allowance  
      ELSE IF(@Componentid=6)  
      BEGIN  
     IF(@RoleID =1)  
    BEGIN  
     SELECT STP.PK_ShiftTimePayoutID AS UniqueID,STP.AssociateID,ISNULL(LTRIM(RTRIM(AD.Associate_FirstName)),'')+' '+  
     ISNULL(LTRIM(RTRIM(AD.Associate_LastName)),'') AS AssociateName ,  
     STP.ProjectID,CM.ComponentShortName AS AllowanceType,STM.ShiftTypeName AS ShiftType,  
     CONVERT(VARCHAR,STP.STARTDATE,101) AS StartDate,  
     STP.StartTime, CONVERT(VARCHAR,STP.EndDate,101) AS Enddate,STP.EndTime,ISNULL(STP.HCMSchedule,'') AS HCMShift,  
     CONVERT(VARCHAR(5),DATEDIFF(S, STP.StartDateTime, STP.EndDateTime)/3600)+':'+  
     CONVERT(VARCHAR(5),DATEDIFF(S, STP.StartDateTime, STP.EndDateTime)%3600/60) AS TotalHours,  
     STP.Amount AS EligibleAmount, STP.CreatedBy AS UploaderID,  
     ISNULL(LTRIM(RTRIM(UD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(UD.Associate_LastName)),'')  
     AS UploaderName,  
     Case when isnull(STP.Modifieddate,'')<>'' then STP.Modifieddate else STP.Createddate end UploadedDate,  
     CPM.PROJECT_MANAGER AS PMID,  
     ISNULL(LTRIM(RTRIM(PD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(PD.Associate_LastName)),'') AS PMName,   
     (CASE WHEN STP.Status=1 THEN 'Valid'   
     WHEN STP.Status=5 THEN 'Processed'    
     WHEN STP.Status=4 THEN 'ReSubmitted'  
     WHEN STP.Status=20 THEN 'Resubmitted after Project Manager Rejection'   
     WHEN STP.Status=10 THEN 'Resubmitted after PFSS Rejection'   
     WHEN STP.Status=21 THEN 'Approved by Home Manager'   
     WHEN STP.Status=15 THEN 'Approved by Project Manager'   
     WHEN STP.Status=34 THEN 'Pending for D+ Approval'  
     WHEN STP.Status=35 THEN 'Approved by D+' END) AS Status ,STP.NSADate AS ShiftStartDate  
     , RNSA.RecalledComments, RNSA.ModifiedStartDateTime, RNSA.ModifiedEndDateTime  
     FROM PR.ShiftTimePayout STP WITH(NOLOCK)   
     INNER JOIN ShiftTypeMaster STM WITH(NOLOCK) ON STM.PK_ShiftTypeID=STP.FK_ShiftTypeID  
     INNER JOIN ComponentMaster CM WITH(NOLOCK) ON CM.PK_ComponentId=STP.Fk_ComponentID  
     INNER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK)   
     ON CONVERT(VARCHAR,AD.Associate_ID)=CONVERT(VARCHAR,STP.AssociateID)  
     INNER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details UD WITH(NOLOCK)   
     ON CONVERT(VARCHAR,UD.Associate_ID)=CONVERT(VARCHAR,STP.CreatedBy)  
     LEFT OUTER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Current_ProjectManager CPM WITH(NOLOCK)   
     ON CONVERT(VARCHAR,CPM.PROJECT_ID)=STP.ProjectID  
     INNER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details PD WITH(NOLOCK)   
     ON PD.Associate_ID=CPM.PROJECT_MANAGER  
     LEFT JOIN PR.Trutime_Recalled_NSA RNSA ON RNSA.AssociateID = STP.AssociateID AND RNSA.Date = STP.NSADate  
     AND RNSA.Fk_ComponentID = STP.Fk_ComponentID AND RNSA.ProjectID = STP.ProjectID AND RNSA.RowStatus = 1  
     WHERE STP.Status IN (1,4,5,15,34,35) AND STP.RowStatus=1 AND ((DATEPART(MM,STP.CreatedDate)=@Month   
     AND DATEPART(YY,STP.CreatedDate)=@Year) OR   
     (DATEPART(MM,STP.ModifiedDate)=@Month  AND DATEPART(YY,STP.ModifiedDate)=@Year))  
     and CM.PK_Componentid=@componentid  
     and STP.CreatedBy=@LOGINID  
    END         
     ELSE  
     BEGIN  
     SELECT STP.PK_ShiftTimePayoutID AS UniqueID,STP.AssociateID,ISNULL(LTRIM(RTRIM(AD.Associate_FirstName)),'')+' '+  
     ISNULL(LTRIM(RTRIM(AD.Associate_LastName)),'') AS AssociateName ,  
     STP.ProjectID,CM.ComponentShortName AS AllowanceType,STM.ShiftTypeName AS ShiftType,  
     CONVERT(VARCHAR,STP.STARTDATE,101) AS StartDate,  
     STP.StartTime, CONVERT(VARCHAR,STP.EndDate,101) AS Enddate,STP.EndTime,ISNULL(STP.HCMSchedule,'') AS HCMShift,  
     CONVERT(VARCHAR(5),DATEDIFF(S, STP.StartDateTime, STP.EndDateTime)/3600)+':'+  
     CONVERT(VARCHAR(5),DATEDIFF(S, STP.StartDateTime, STP.EndDateTime)%3600/60) AS TotalHours,  
     STP.Amount AS EligibleAmount, STP.CreatedBy AS UploaderID,  
     ISNULL(LTRIM(RTRIM(UD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(UD.Associate_LastName)),'')  
     AS UploaderName,  
     Case when isnull(STP.Modifieddate,'')<>'' then STP.Modifieddate else STP.Createddate end UploadedDate,  
     CPM.PROJECT_MANAGER AS PMID,  
     ISNULL(LTRIM(RTRIM(PD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(PD.Associate_LastName)),'') AS PMName,   
     (CASE WHEN STP.Status=1 THEN 'Valid'   
     WHEN STP.Status=5 THEN 'Processed'    
     WHEN STP.Status=4 THEN 'ReSubmitted'  
     WHEN STP.Status=20 THEN 'Resubmitted after Project Manager Rejection'   
     WHEN STP.Status=10 THEN 'Resubmitted after PFSS Rejection'   
     WHEN STP.Status=21 THEN 'Approved by Home Manager'   
     WHEN STP.Status=15 THEN 'Approved by Project Manager'   
     WHEN STP.Status=34 THEN 'Pending for D+ Approval'  
     WHEN STP.Status=35 THEN 'Approved by D+' END) AS Status ,STP.NSADate AS ShiftStartDate  
     , RNSA.RecalledComments, RNSA.ModifiedStartDateTime, RNSA.ModifiedEndDateTime  
     FROM PR.ShiftTimePayout STP WITH(NOLOCK)   
     INNER JOIN ShiftTypeMaster STM WITH(NOLOCK) ON STM.PK_ShiftTypeID=STP.FK_ShiftTypeID  
     INNER JOIN ComponentMaster CM WITH(NOLOCK) ON CM.PK_ComponentId=STP.Fk_ComponentID  
     INNER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK)   
     ON CONVERT(VARCHAR,AD.Associate_ID)=CONVERT(VARCHAR,STP.AssociateID)  
     INNER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details UD WITH(NOLOCK)   
     ON CONVERT(VARCHAR,UD.Associate_ID)=CONVERT(VARCHAR,STP.CreatedBy)  
     LEFT OUTER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Current_ProjectManager CPM WITH(NOLOCK)   
     ON CONVERT(VARCHAR,CPM.PROJECT_ID)=STP.ProjectID  
     INNER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details PD WITH(NOLOCK)   
     ON PD.Associate_ID=CPM.PROJECT_MANAGER  
     LEFT JOIN PR.Trutime_Recalled_NSA RNSA ON RNSA.AssociateID = STP.AssociateID AND RNSA.Date = STP.NSADate  
     AND RNSA.Fk_ComponentID = STP.Fk_ComponentID AND RNSA.ProjectID = STP.ProjectID AND RNSA.RowStatus = 1  
     WHERE STP.Status IN (1,4,5,15,34,35) AND STP.RowStatus=1 AND ((DATEPART(MM,STP.CreatedDate)=@Month   
     AND DATEPART(YY,STP.CreatedDate)=@Year) OR   
     (DATEPART(MM,STP.ModifiedDate)=@Month  AND DATEPART(YY,STP.ModifiedDate)=@Year))  
     and CM.PK_Componentid=@componentid  
     END  
   END  
      
         ELSE  
      --CIS 6th Day Allowance  
     IF(@RoleID=1)  
    BEGIN  
     SELECT STP.PK_ShiftTimePayoutID AS UniqueID,STP.AssociateID,  
    ISNULL(LTRIM(RTRIM(AD.Associate_FirstName)),'')+' '+  
    ISNULL(LTRIM(RTRIM(AD.Associate_LastName)),'') AS AssociateName ,  
    STP.ProjectID,CM.ComponentShortName AS AllowanceType,STM.ShiftTypeName AS ShiftType,  
    CONVERT(VARCHAR,STP.STARTDATE,101) AS StartDate,  
    STP.StartTime, CONVERT(VARCHAR,STP.EndDate,101) AS Enddate,STP.EndTime,ISNULL(STP.HCMSchedule,'') AS HCMShift,  
    CONVERT(VARCHAR(5),DATEDIFF(S, STP.StartDateTime, STP.EndDateTime)/3600)+':'+  
    CONVERT(VARCHAR(5),DATEDIFF(S, STP.StartDateTime, STP.EndDateTime)%3600/60) AS TotalHours,  
    STP.Amount AS EligibleAmount, STP.CreatedBy AS UploaderID,  
    ISNULL(LTRIM(RTRIM(UD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(UD.Associate_LastName)),'')   
    AS UploaderName,  
    Case when isnull(STP.Modifieddate,'')<>'' then STP.Modifieddate else STP.Createddate end UploadedDate,  
    CPM.PROJECT_MANAGER AS PMID,  
    ISNULL(LTRIM(RTRIM(PD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(PD.Associate_LastName)),'') AS PMName,   
    (CASE WHEN STP.Status=1 THEN 'Valid'   
    WHEN STP.Status=5 THEN 'Processed'    
    WHEN STP.Status=4 THEN 'ReSubmitted'  
    WHEN STP.Status=20 THEN 'Resubmitted after Project Manager Rejection'   
    WHEN STP.Status=10 THEN 'Resubmitted after PFSS Rejection'   
    WHEN STP.Status=21 THEN 'Approved by Home Manager'   
    WHEN STP.Status=15 THEN 'Approved by Project Manager'   
    WHEN STP.Status=34 THEN 'Pending for D+ Approval'  
    WHEN STP.Status=35 THEN 'Approved by D+' END) AS Status ,STP.NSADate AS ShiftStartDate  
    FROM PR.ShiftTimePayout STP WITH(NOLOCK)   
    INNER JOIN ShiftTypeMaster STM WITH(NOLOCK) ON STM.PK_ShiftTypeID=STP.FK_ShiftTypeID  
    INNER JOIN ComponentMaster CM WITH(NOLOCK) ON CM.PK_ComponentId=STP.Fk_ComponentID  
    INNER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK)   
    ON CONVERT(VARCHAR,AD.Associate_ID)=CONVERT(VARCHAR,STP.AssociateID)  
    INNER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details UD WITH(NOLOCK)   
    ON CONVERT(VARCHAR,UD.Associate_ID)=CONVERT(VARCHAR,STP.CreatedBy)  
    LEFT OUTER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Current_ProjectManager CPM WITH(NOLOCK)   
    ON CONVERT(VARCHAR,CPM.PROJECT_ID)=STP.ProjectID  
    INNER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details PD WITH(NOLOCK)   
    ON PD.Associate_ID=CPM.PROJECT_MANAGER  
    WHERE STP.Status IN (1,4,5,15,34,35) AND STP.RowStatus=1 AND ((DATEPART(MM,STP.CreatedDate)=@Month   
    AND DATEPART(YY,STP.CreatedDate)=@Year) OR   
    (DATEPART(MM,STP.ModifiedDate)=@Month  AND DATEPART(YY,STP.ModifiedDate)=@Year))  
    and CM.PK_Componentid=@componentid and STP.CreatedBy=@LOGINID  
     END  
     ELSE IF(@Componentid=4 and @RoleID in (3,2))  
     BEGIN  
      
     SELECT STP.PK_ShiftTimePayoutID AS UniqueID,STP.AssociateID,  
     ISNULL(LTRIM(RTRIM(AD.Associate_FirstName)),'')+' '+  
     ISNULL(LTRIM(RTRIM(AD.Associate_LastName)),'') AS AssociateName ,  
     STP.ProjectID,CM.ComponentShortName AS AllowanceType,STM.ShiftTypeName AS ShiftType,  
     CONVERT(VARCHAR,STP.STARTDATE,101) AS StartDate,  
     STP.StartTime, CONVERT(VARCHAR,STP.EndDate,101) AS Enddate,STP.EndTime,ISNULL(STP.HCMSchedule,'') AS HCMShift,  
     CONVERT(VARCHAR(5),DATEDIFF(S, STP.StartDateTime, STP.EndDateTime)/3600)+':'+  
     CONVERT(VARCHAR(5),DATEDIFF(S, STP.StartDateTime, STP.EndDateTime)%3600/60) AS TotalHours,  
     ISNULL(SDA_OCA_Amount,0) AS SDA_OCA_Amount1,  
     ISNULL(SDA_OCA_Amount2,0) AS SDA_OCA_Amount2,  
     STP.Amount AS TotalAmount, STP.CreatedBy AS UploaderID,  
     ISNULL(LTRIM(RTRIM(UD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(UD.Associate_LastName)),'')   
     AS UploaderName,  
     Case when isnull(STP.Modifieddate,'')<>'' then STP.Modifieddate else STP.Createddate end UploadedDate,  
     CPM.PROJECT_MANAGER AS PMID,  
     ISNULL(LTRIM(RTRIM(PD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(PD.Associate_LastName)),'') AS PMName,   
     (CASE WHEN STP.Status=1 THEN 'Valid'   
     WHEN STP.Status=5 THEN 'Processed'    
     WHEN STP.Status=4 THEN 'ReSubmitted'  
     WHEN STP.Status=20 THEN 'Resubmitted after Project Manager Rejection'   
     WHEN STP.Status=10 THEN 'Resubmitted after PFSS Rejection'   
     WHEN STP.Status=21 THEN 'Approved by Home Manager'   
     WHEN STP.Status=15 THEN 'Approved by Project Manager'   
     WHEN STP.Status=34 THEN 'Pending for D+ Approval'  
     WHEN STP.Status=35 THEN 'Approved by D+' END) AS Status ,STP.NSADate AS ShiftStartDate  
     FROM PR.ShiftTimePayout STP WITH(NOLOCK)   
     INNER JOIN ShiftTypeMaster STM WITH(NOLOCK) ON STM.PK_ShiftTypeID=STP.FK_ShiftTypeID  
     INNER JOIN ComponentMaster CM WITH(NOLOCK) ON CM.PK_ComponentId=STP.Fk_ComponentID  
     INNER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK)   
     ON CONVERT(VARCHAR,AD.Associate_ID)=CONVERT(VARCHAR,STP.AssociateID)  
     INNER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details UD WITH(NOLOCK)   
     ON CONVERT(VARCHAR,UD.Associate_ID)=CONVERT(VARCHAR,STP.CreatedBy)  
     LEFT OUTER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Current_ProjectManager CPM WITH(NOLOCK)   
     ON CONVERT(VARCHAR,CPM.PROJECT_ID)=STP.ProjectID  
     INNER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details PD WITH(NOLOCK)   
     ON PD.Associate_ID=CPM.PROJECT_MANAGER  
     WHERE STP.Status IN (1,4,5,15,34,35) AND STP.RowStatus=1 AND ((DATEPART(MM,STP.CreatedDate)=@Month   
     AND DATEPART(YY,STP.CreatedDate)=@Year) OR   
     (DATEPART(MM,STP.ModifiedDate)=@Month  AND DATEPART(YY,STP.ModifiedDate)=@Year))  
     and CM.PK_Componentid=@componentid  
     END  
     ELSE   
    BEGIN  
     SELECT STP.PK_ShiftTimePayoutID AS UniqueID,STP.AssociateID,  
     ISNULL(LTRIM(RTRIM(AD.Associate_FirstName)),'')+' '+  
     ISNULL(LTRIM(RTRIM(AD.Associate_LastName)),'') AS AssociateName ,  
     STP.ProjectID,CM.ComponentShortName AS AllowanceType,STM.ShiftTypeName AS ShiftType,  
     CONVERT(VARCHAR,STP.STARTDATE,101) AS StartDate,  
     STP.StartTime, CONVERT(VARCHAR,STP.EndDate,101) AS Enddate,STP.EndTime,ISNULL(STP.HCMSchedule,'') AS HCMShift,  
     CONVERT(VARCHAR(5),DATEDIFF(S, STP.StartDateTime, STP.EndDateTime)/3600)+':'+  
     CONVERT(VARCHAR(5),DATEDIFF(S, STP.StartDateTime, STP.EndDateTime)%3600/60) AS TotalHours,  
     STP.Amount AS EligibleAmount, STP.CreatedBy AS UploaderID,  
     ISNULL(LTRIM(RTRIM(UD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(UD.Associate_LastName)),'')   
     AS UploaderName,  
     Case when isnull(STP.Modifieddate,'')<>'' then STP.Modifieddate else STP.Createddate end UploadedDate,  
     CPM.PROJECT_MANAGER AS PMID,  
     ISNULL(LTRIM(RTRIM(PD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(PD.Associate_LastName)),'') AS PMName,   
     (CASE WHEN STP.Status=1 THEN 'Valid'   
     WHEN STP.Status=5 THEN 'Processed'    
     WHEN STP.Status=4 THEN 'ReSubmitted'  
     WHEN STP.Status=20 THEN 'Resubmitted after Project Manager Rejection'   
     WHEN STP.Status=10 THEN 'Resubmitted after PFSS Rejection'   
     WHEN STP.Status=21 THEN 'Approved by Home Manager'   
     WHEN STP.Status=15 THEN 'Approved by Project Manager'   
     WHEN STP.Status=34 THEN 'Pending for D+ Approval'  
     WHEN STP.Status=35 THEN 'Approved by D+' END) AS Status ,STP.NSADate AS ShiftStartDate  
     FROM PR.ShiftTimePayout STP WITH(NOLOCK)   
     INNER JOIN ShiftTypeMaster STM WITH(NOLOCK) ON STM.PK_ShiftTypeID=STP.FK_ShiftTypeID  
     INNER JOIN ComponentMaster CM WITH(NOLOCK) ON CM.PK_ComponentId=STP.Fk_ComponentID  
     INNER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK)   
     ON CONVERT(VARCHAR,AD.Associate_ID)=CONVERT(VARCHAR,STP.AssociateID)  
     INNER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details UD WITH(NOLOCK)   
     ON CONVERT(VARCHAR,UD.Associate_ID)=CONVERT(VARCHAR,STP.CreatedBy)  
     LEFT OUTER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Current_ProjectManager CPM WITH(NOLOCK)   
     ON CONVERT(VARCHAR,CPM.PROJECT_ID)=STP.ProjectID  
     INNER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details PD WITH(NOLOCK)   
     ON PD.Associate_ID=CPM.PROJECT_MANAGER  
     WHERE STP.Status IN (1,4,5,15,34,35) AND STP.RowStatus=1 AND ((DATEPART(MM,STP.CreatedDate)=@Month   
     AND DATEPART(YY,STP.CreatedDate)=@Year) OR   
     (DATEPART(MM,STP.ModifiedDate)=@Month  AND DATEPART(YY,STP.ModifiedDate)=@Year))  
     and CM.PK_Componentid=@componentid  
        END   
        END   
      END  
    
   -- IT 6DA,OCA,NSA  
  IF(@Componentid in (50,51,52))  
     BEGIN  
    
  --Project Manager  
  IF(@Componentid=52 and @RoleID in (6,5))  
  BEGIN  
         CREATE TABLE #ITCOMPONENTSP (ComponentID INT,ProjectID VARCHAR(50))  
             
     --Inserting ITcomponent data  
   INSERT INTO #ITCOMPONENTSP (ComponentID ,ProjectID)     
   EXEC [dbo].[usp_GetComponentsForRole] @RoleID,@LoginID,@ComponentGrpID,@CountryID    
            
  SELECT STP.PK_ITShiftAllowanceID AS UniqueID,STP.AssociateID,ISNULL(LTRIM(RTRIM(AD.Associate_FirstName)),'')+' '+  
  ISNULL(LTRIM(RTRIM(AD.Associate_LastName)),'') AS AssociateName ,  
  STP.ProjectID,CM.ComponentShortName AS AllowanceType,STM.ShiftTypeName AS ShiftType,  
  CONVERT(VARCHAR,STP.STARTDATE,101) AS StartDate,  
     CONVERT(VARCHAR,STP.EndDate,101) AS Enddate,  
  CONVERT(VARCHAR(5),DATEDIFF(S, STP.StartDateTime, STP.EndDateTime)/3600)+':'+CONVERT(VARCHAR(5),  
  DATEDIFF(S, STP.StartDateTime, STP.EndDateTime)%3600/60) AS TotalHours,  
  STP.Amount AS EligibleAmount,STP.TransportEligibility as TransportEligibility ,STP.CreatedBy AS UploaderID,  
  ISNULL(LTRIM(RTRIM(UD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(UD.Associate_LastName)),'') AS UploaderName,  
  Case when isnull(STP.Modifieddate,'')<>'' then STP.Modifieddate  else STP.Createddate  end UploadedDate,  
  CPM.PROJECT_MANAGER AS PMID,  
  ISNULL(LTRIM(RTRIM(PD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(PD.Associate_LastName)),'') AS PMName,   
  (CASE WHEN STP.Status=1 THEN 'Valid' WHEN STP.Status=5 THEN 'Processed'  
  WHEN STP.Status=4 THEN 'ReSubmitted' END) AS Status ,  
  STP.NSADate AS ShiftStartDate,  
  RNSA.RecalledComments, RNSA.ModifiedStartDateTime, RNSA.ModifiedEndDateTime  
  FROM PR.ITShiftAllowance STP WITH(NOLOCK)   
  INNER JOIN ShiftTypeMaster STM WITH(NOLOCK) ON STM.PK_ShiftTypeID=STP.FK_ShiftTypeID  
  INNER JOIN ComponentMaster CM WITH(NOLOCK) ON CM.PK_ComponentId=STP.Fk_ComponentID  
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK)   
  ON AD.Associate_ID=STP.AssociateID   
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details UD WITH(NOLOCK)   
  ON UD.Associate_ID=STP.CreatedBy   
  LEFT OUTER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Current_ProjectManager CPM WITH(NOLOCK)   
  ON CPM.PROJECT_ID=STP.ProjectID  
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details PD WITH(NOLOCK)  
  ON PD.Associate_ID=CPM.PROJECT_MANAGER  
  INNER JOIN #ITCOMPONENTSP CMTS WITH(NOLOCK) ON  CMTS.ComponentID=STP.Fk_ComponentID  
  AND CMTS.ProjectID=STP.ProjectID  
  LEFT JOIN PR.Trutime_Recalled_NSA RNSA ON RNSA.AssociateID = STP.AssociateID AND RNSA.Date = STP.NSADate  
        AND RNSA.Fk_ComponentID = STP.Fk_ComponentID AND RNSA.ProjectID = STP.ProjectID AND RNSA.RowStatus = 1  
  WHERE STP.Status IN (1,5,4) AND STP.RowStatus=1 AND DATEPART(MM,STP.CreatedDate)=@Month   
  AND DATEPART(YY,STP.CreatedDate)=@Year  
  and CM.Pk_ComponentID=@Componentid  
            
  DROP TABLE  #ITCOMPONENTSP   
  END  
  ELSE IF(@Componentid not in (52) and @RoleID=6)  
   BEGIN  
  
   CREATE TABLE #ITCOMPONENTS (ComponentID INT,ProjectID VARCHAR(50))  
             
     --Inserting ITcomponent data  
   INSERT INTO #ITCOMPONENTS (ComponentID ,ProjectID)     
   EXEC [dbo].[usp_GetComponentsForRole] @RoleID,@LoginID,@ComponentGrpID,@CountryID    
            
  SELECT STP.AssociateID,ISNULL(LTRIM(RTRIM(AD.Associate_FirstName)),'')+' '+  
  ISNULL(LTRIM(RTRIM(AD.Associate_LastName)),'') AS AssociateName ,  
  STP.ProjectID,CM.ComponentShortName AS AllowanceType,STM.ShiftTypeName AS ShiftType,  
  CONVERT(VARCHAR,STP.STARTDATE,101) AS StartDate,  
  STP.StartTime, CONVERT(VARCHAR,STP.EndDate,101) AS Enddate,STP.EndTime,ISNULL(STP.HCMSchedule,'') AS HCMShift,  
  CONVERT(VARCHAR(5),DATEDIFF(S, STP.StartDateTime, STP.EndDateTime)/3600)+':'+CONVERT(VARCHAR(5),  
  DATEDIFF(S, STP.StartDateTime, STP.EndDateTime)%3600/60) AS TotalHours,  
  STP.Amount AS EligibleAmount,STP.TransportEligibility as TransportEligibility ,STP.CreatedBy AS UploaderID,  
  ISNULL(LTRIM(RTRIM(UD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(UD.Associate_LastName)),'') AS UploaderName,  
  Case when isnull(STP.Modifieddate,'')<>'' then STP.Modifieddate  else STP.Createddate  end UploadedDate,  
  CPM.PROJECT_MANAGER AS PMID,  
  ISNULL(LTRIM(RTRIM(PD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(PD.Associate_LastName)),'') AS PMName,   
  (CASE WHEN STP.Status=1 THEN 'Valid' WHEN STP.Status=5 THEN 'Processed'  
  WHEN STP.Status=4 THEN 'ReSubmitted' END) AS Status ,  
  STP.NSADate AS ShiftStartDate  
  FROM PR.ITShiftAllowance STP WITH(NOLOCK)   
  INNER JOIN ShiftTypeMaster STM WITH(NOLOCK) ON STM.PK_ShiftTypeID=STP.FK_ShiftTypeID  
  INNER JOIN ComponentMaster CM WITH(NOLOCK) ON CM.PK_ComponentId=STP.Fk_ComponentID  
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK)   
  ON AD.Associate_ID=STP.AssociateID   
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details UD WITH(NOLOCK)   
  ON UD.Associate_ID=STP.CreatedBy   
  LEFT OUTER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Current_ProjectManager CPM WITH(NOLOCK)   
  ON CPM.PROJECT_ID=STP.ProjectID  
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details PD WITH(NOLOCK)  
  ON PD.Associate_ID=CPM.PROJECT_MANAGER  
  INNER JOIN #ITCOMPONENTS CMTS WITH(NOLOCK) ON  CMTS.ComponentID=STP.Fk_ComponentID  
  AND CMTS.ProjectID=STP.ProjectID  
  WHERE STP.Status IN (1,5,4) AND STP.RowStatus=1 AND DATEPART(MM,STP.CreatedDate)=@Month   
  AND DATEPART(YY,STP.CreatedDate)=@Year  
  and CM.Pk_ComponentID=@Componentid  
            
  DROP TABLE  #ITCOMPONENTS   
  
 END   
  
  ELSE  
   BEGIN  
  
    --IT On Call Allowance  
   IF(@COMPONENTID=51 and  @RoleID in (3,2))  
   BEGIN  
  SELECT STP.PK_ITShiftAllowanceID AS UniqueID,STP.AssociateID,  
  ISNULL(LTRIM(RTRIM(AD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(AD.Associate_LastName)),'') AS AssociateName,  
  STP.ProjectID,CM.ComponentShortName AS AllowanceType,STM.ShiftTypeName AS ShiftType,  
  CONVERT(VARCHAR,STP.STARTDATE,101) AS StartDate,  
  STP.StartTime, CONVERT(VARCHAR,STP.EndDate,101) AS Enddate,STP.EndTime,ISNULL(STP.HCMSchedule,'') AS HCMShift,  
  CONVERT(VARCHAR(5),DATEDIFF(S, STP.StartDateTime, STP.EndDateTime)/3600)+':'+CONVERT(VARCHAR(5),  
  DATEDIFF(S, STP.StartDateTime, STP.EndDateTime)%3600/60) AS TotalHours,ISNULL(SDA_OCA_Amount,0) AS SDA_OCA_Amount1,  
  ISNULL(SDA_OCA_Amount2,0) AS SDA_OCA_Amount2,  
  STP.Amount AS TotalAmount,STP.TransportEligibility as TransportEligibility , STP.CreatedBy AS UploaderID,  
  ISNULL(LTRIM(RTRIM(UD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(UD.Associate_LastName)),'') AS UploaderName,  
  Case when isnull(STP.Modifieddate,'')<>'' then STP.Modifieddate else STP.Createddate  end UploadedDate,  
  CPM.PROJECT_MANAGER AS PMID,  
  ISNULL(LTRIM(RTRIM(PD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(PD.Associate_LastName)),'') AS PMName,   
  (CASE WHEN STP.Status=1 THEN 'Valid'   
  WHEN STP.Status=5 THEN 'Processed'    
  WHEN STP.Status=20 THEN 'Resubmitted after Project Manager Rejection'  
  WHEN STP.Status=10 THEN 'Resubmitted after PFSS Rejection'   
  WHEN STP.Status=4 THEN 'ReSubmitted'  
  WHEN STP.Status=21 THEN 'Approved by Home Manager'   
  WHEN STP.Status=15 THEN 'Approved by Project Manager'   
  WHEN STP.Status=34 THEN 'Pending for D+ Approval'  
  WHEN STP.Status=35 THEN 'Approved by D+' END) AS Status,STP.NSADate AS ShiftStartDate   
  FROM PR.ITShiftAllowance STP WITH(NOLOCK)   
  INNER JOIN ShiftTypeMaster STM WITH(NOLOCK) ON STM.PK_ShiftTypeID=STP.FK_ShiftTypeID  
  INNER JOIN ComponentMaster CM WITH(NOLOCK) ON CM.PK_ComponentId=STP.Fk_ComponentID  
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK)   
  ON AD.Associate_ID=STP.AssociateID   
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details UD WITH(NOLOCK)   
  ON UD.Associate_ID=STP.CreatedBy   
  LEFT OUTER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Current_ProjectManager CPM WITH(NOLOCK)   
  ON CPM.PROJECT_ID=STP.ProjectID  
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details PD WITH(NOLOCK)   
  ON PD.Associate_ID=CPM.PROJECT_MANAGER  
  WHERE STP.Status IN (4,5,15,21,34,35) AND STP.RowStatus=1 AND ((DATEPART(MM,STP.CreatedDate)=@Month   
  AND DATEPART(YY,STP.CreatedDate)=@Year) OR  
  (DATEPART(MM,STP.ModifiedDate)=@Month  AND DATEPART(YY,STP.ModifiedDate)=@Year))  
  and CM.PK_Componentid=@componentid  
   END  
   ELSE IF(@COMPONENTID=51 and @RoleID!=3)  
   BEGIN  
  SELECT STP.PK_ITShiftAllowanceID AS UniqueID,STP.AssociateID,  
  ISNULL(LTRIM(RTRIM(AD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(AD.Associate_LastName)),'') AS AssociateName,  
  STP.ProjectID,CM.ComponentShortName AS AllowanceType,STM.ShiftTypeName AS ShiftType,  
  CONVERT(VARCHAR,STP.STARTDATE,101) AS StartDate,  
  STP.StartTime, CONVERT(VARCHAR,STP.EndDate,101) AS Enddate,STP.EndTime,ISNULL(STP.HCMSchedule,'') AS HCMShift,  
  CONVERT(VARCHAR(5),DATEDIFF(S, STP.StartDateTime, STP.EndDateTime)/3600)+':'+CONVERT(VARCHAR(5),  
  DATEDIFF(S, STP.StartDateTime, STP.EndDateTime)%3600/60) AS TotalHours,  
  STP.Amount AS EligibleAmount,STP.TransportEligibility as TransportEligibility , STP.CreatedBy AS UploaderID,  
  ISNULL(LTRIM(RTRIM(UD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(UD.Associate_LastName)),'') AS UploaderName,  
  Case when isnull(STP.Modifieddate,'')<>'' then STP.Modifieddate else STP.Createddate  end UploadedDate,  
  CPM.PROJECT_MANAGER AS PMID, AD.Supervisor_ID as HMID,
  ISNULL(LTRIM(RTRIM(PD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(PD.Associate_LastName)),'') AS PMName, 
  ISNULL(LTRIM(RTRIM(HM.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(HM.Associate_LastName)),'') AS HMName,
  (CASE WHEN STP.Status=1 THEN 'Valid'   
  WHEN STP.Status=5 THEN 'Processed'    
  WHEN STP.Status=20 THEN 'Resubmitted after Project Manager Rejection'  
  WHEN STP.Status=10 THEN 'Resubmitted after PFSS Rejection'   
  WHEN STP.Status=4 THEN 'ReSubmitted'  
  WHEN STP.Status=21 THEN 'Approved by Home Manager'   
  WHEN STP.Status=15 THEN 'Approved by Project Manager'   
  WHEN STP.Status=34 THEN 'Pending for D+ Approval'  
  WHEN STP.Status=35 THEN 'Approved by D+' END) AS Status,STP.NSADate AS ShiftStartDate   
  FROM PR.ITShiftAllowance STP WITH(NOLOCK)   
  INNER JOIN ShiftTypeMaster STM WITH(NOLOCK) ON STM.PK_ShiftTypeID=STP.FK_ShiftTypeID  
  INNER JOIN ComponentMaster CM WITH(NOLOCK) ON CM.PK_ComponentId=STP.Fk_ComponentID  
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK)   
  ON AD.Associate_ID=STP.AssociateID   
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details UD WITH(NOLOCK)   
  ON UD.Associate_ID=STP.CreatedBy   
  LEFT OUTER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Current_ProjectManager CPM WITH(NOLOCK)   
  ON CPM.PROJECT_ID=STP.ProjectID  
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details PD WITH(NOLOCK)   
  ON PD.Associate_ID=CPM.PROJECT_MANAGER  
  INNER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details HM WITH(NOLOCK)   
     ON AD.Supervisor_ID=HM.Associate_ID
  WHERE STP.Status IN (1,4,5,15,21,34,35) AND STP.RowStatus=1 AND ((DATEPART(MM,STP.CreatedDate)=@Month   
  AND DATEPART(YY,STP.CreatedDate)=@Year) OR  
  (DATEPART(MM,STP.ModifiedDate)=@Month  AND DATEPART(YY,STP.ModifiedDate)=@Year))  
  and CM.PK_Componentid=@componentid  and STP.Createdby=@Loginid
   END  
--IT Night Shift Allowancee  
   ELSE IF(@COMPONENTID =52)  
   BEGIN  
  IF(@RoleID=12)  
  BEGIN  
     SELECT STP.PK_ITShiftAllowanceID AS UniqueID,STP.AssociateID,  
     ISNULL(LTRIM(RTRIM(AD.Associate_FirstName)),'')+' '+  
     ISNULL(LTRIM(RTRIM(AD.Associate_LastName)),'') AS AssociateName,  
  STP.ProjectID,CM.ComponentShortName AS AllowanceType,STM.ShiftTypeName AS ShiftType,  
  CONVERT(VARCHAR,STP.STARTDATE,101) AS StartDate,  
  STP.StartTime, CONVERT(VARCHAR,STP.EndDate,101) AS Enddate,STP.EndTime,  
  ISNULL(STP.HCMSchedule,'') AS HCMShift,  
  CONVERT(VARCHAR(5),DATEDIFF(S, STP.StartDateTime, STP.EndDateTime)/3600)+':'+CONVERT(VARCHAR(5),  
  DATEDIFF(S, STP.StartDateTime, STP.EndDateTime)%3600/60) AS TotalHours,  
  STP.Amount AS EligibleAmount,STP.TransportEligibility as TransportEligibility , STP.CreatedBy AS UploaderID,  
  ISNULL(LTRIM(RTRIM(UD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(UD.Associate_LastName)),'') AS UploaderName,  
  Case when isnull(STP.Modifieddate,'')<>'' then STP.Modifieddate else STP.Createddate  end UploadedDate,  
  CPM.PROJECT_MANAGER AS PMID,  
  ISNULL(LTRIM(RTRIM(PD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(PD.Associate_LastName)),'') AS PMName,   
  (CASE WHEN STP.Status=1 THEN 'Valid'   
  WHEN STP.Status=5 THEN 'Processed'    
  WHEN STP.Status=20 THEN 'Resubmitted after Project Manager Rejection'   
  WHEN STP.Status=10 THEN 'Resubmitted after PFSS Rejection'    
  WHEN STP.Status=4 THEN 'ReSubmitted'  
  WHEN STP.Status=21 THEN 'Approved by Home Manager'   
  WHEN STP.Status=15 THEN 'Approved by Project Manager'   
  WHEN STP.Status=34 THEN 'Pending for D+ Approval'  
  WHEN STP.Status=35 THEN 'Approved by D+' END) AS Status,STP.NSADate AS ShiftStartDate   
  , RNSA.RecalledComments, RNSA.ModifiedStartDateTime, RNSA.ModifiedEndDateTime  
  FROM PR.ITShiftAllowance STP WITH(NOLOCK)   
  INNER JOIN ShiftTypeMaster STM WITH(NOLOCK) ON STM.PK_ShiftTypeID=STP.FK_ShiftTypeID  
  INNER JOIN ComponentMaster CM WITH(NOLOCK) ON CM.PK_ComponentId=STP.Fk_ComponentID  
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK)   
  ON AD.Associate_ID=STP.AssociateID   
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details UD WITH(NOLOCK)   
  ON UD.Associate_ID=STP.CreatedBy   
  LEFT OUTER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Current_ProjectManager CPM WITH(NOLOCK)   
  ON CPM.PROJECT_ID=STP.ProjectID  
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details PD WITH(NOLOCK)  
  ON PD.Associate_ID=CPM.PROJECT_MANAGER  
  LEFT JOIN PR.Trutime_Recalled_NSA RNSA ON RNSA.AssociateID = STP.AssociateID AND RNSA.Date = STP.NSADate  
           AND RNSA.Fk_ComponentID = STP.Fk_ComponentID AND RNSA.ProjectID = STP.ProjectID AND RNSA.RowStatus = 1  
  WHERE STP.Status IN (1,4,5,15,34,35) AND STP.RowStatus=1   
  AND ((DATEPART(MM,STP.CreatedDate)=@Month AND DATEPART(YY,STP.CreatedDate)=@Year) OR  
  (DATEPART(MM,STP.ModifiedDate)=@Month  AND DATEPART(YY,STP.ModifiedDate)=@Year))  
  and CM.PK_Componentid=@componentid and STP.CreatedBy=@LOGINID  
  END  
  ELSE  
  BEGIN  
     SELECT STP.PK_ITShiftAllowanceID AS UniqueID,STP.AssociateID,  
     ISNULL(LTRIM(RTRIM(AD.Associate_FirstName)),'')+' '+  
     ISNULL(LTRIM(RTRIM(AD.Associate_LastName)),'') AS AssociateName,  
  STP.ProjectID,CM.ComponentShortName AS AllowanceType,STM.ShiftTypeName AS ShiftType,  
  CONVERT(VARCHAR,STP.STARTDATE,101) AS StartDate,  
  STP.StartTime, CONVERT(VARCHAR,STP.EndDate,101) AS Enddate,STP.EndTime,  
  ISNULL(STP.HCMSchedule,'') AS HCMShift,  
  CONVERT(VARCHAR(5),DATEDIFF(S, STP.StartDateTime, STP.EndDateTime)/3600)+':'+CONVERT(VARCHAR(5),  
  DATEDIFF(S, STP.StartDateTime, STP.EndDateTime)%3600/60) AS TotalHours,  
  STP.Amount AS EligibleAmount,STP.TransportEligibility as TransportEligibility , STP.CreatedBy AS UploaderID,  
  ISNULL(LTRIM(RTRIM(UD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(UD.Associate_LastName)),'') AS UploaderName,  
  Case when isnull(STP.Modifieddate,'')<>'' then STP.Modifieddate else STP.Createddate  end UploadedDate,  
  CPM.PROJECT_MANAGER AS PMID,  
  ISNULL(LTRIM(RTRIM(PD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(PD.Associate_LastName)),'') AS PMName,   
  (CASE WHEN STP.Status=1 THEN 'Valid'   
  WHEN STP.Status=5 THEN 'Processed'    
  WHEN STP.Status=20 THEN 'Resubmitted after Project Manager Rejection'   
  WHEN STP.Status=10 THEN 'Resubmitted after PFSS Rejection'    
  WHEN STP.Status=4 THEN 'ReSubmitted'  
  WHEN STP.Status=21 THEN 'Approved by Home Manager'   
  WHEN STP.Status=15 THEN 'Approved by Project Manager'   
  WHEN STP.Status=34 THEN 'Pending for D+ Approval'  
  WHEN STP.Status=35 THEN 'Approved by D+' END) AS Status,STP.NSADate AS ShiftStartDate   
  , RNSA.RecalledComments, RNSA.ModifiedStartDateTime, RNSA.ModifiedEndDateTime  
  FROM PR.ITShiftAllowance STP WITH(NOLOCK)   
  INNER JOIN ShiftTypeMaster STM WITH(NOLOCK) ON STM.PK_ShiftTypeID=STP.FK_ShiftTypeID  
  INNER JOIN ComponentMaster CM WITH(NOLOCK) ON CM.PK_ComponentId=STP.Fk_ComponentID  
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK)   
  ON AD.Associate_ID=STP.AssociateID   
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details UD WITH(NOLOCK)   
  ON UD.Associate_ID=STP.CreatedBy   
  LEFT OUTER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Current_ProjectManager CPM WITH(NOLOCK)   
  ON CPM.PROJECT_ID=STP.ProjectID  
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details PD WITH(NOLOCK)  
  ON PD.Associate_ID=CPM.PROJECT_MANAGER  
  LEFT JOIN PR.Trutime_Recalled_NSA RNSA ON RNSA.AssociateID = STP.AssociateID AND RNSA.Date = STP.NSADate  
           AND RNSA.Fk_ComponentID = STP.Fk_ComponentID AND RNSA.ProjectID = STP.ProjectID AND RNSA.RowStatus = 1  
  WHERE STP.Status IN (1,4,5,15,34,35) AND STP.RowStatus=1   
  AND ((DATEPART(MM,STP.CreatedDate)=@Month AND DATEPART(YY,STP.CreatedDate)=@Year) OR  
  (DATEPART(MM,STP.ModifiedDate)=@Month  AND DATEPART(YY,STP.ModifiedDate)=@Year))  
  and CM.PK_Componentid=@componentid  
  END  
     
   
   END  
   ELSE  
  
   --IT 6th Day Allowance  
   BEGIN  
   IF(@RoleID=12)  
   BEGIN  
  SELECT STP.PK_ITShiftAllowanceID AS UniqueID,STP.AssociateID,  
  ISNULL(LTRIM(RTRIM(AD.Associate_FirstName)),'')+' '+  
  ISNULL(LTRIM(RTRIM(AD.Associate_LastName)),'') AS AssociateName,  
  STP.ProjectID,CM.ComponentShortName AS AllowanceType,STM.ShiftTypeName AS ShiftType,  
  CONVERT(VARCHAR,STP.STARTDATE,101) AS StartDate,  
  STP.StartTime, CONVERT(VARCHAR,STP.EndDate,101) AS Enddate,STP.EndTime,  
  ISNULL(STP.HCMSchedule,'') AS HCMShift,  
  CONVERT(VARCHAR(5),DATEDIFF(S, STP.StartDateTime, STP.EndDateTime)/3600)+':'+CONVERT(VARCHAR(5),  
  DATEDIFF(S, STP.StartDateTime, STP.EndDateTime)%3600/60) AS TotalHours,  
  STP.Amount AS EligibleAmount,STP.TransportEligibility as TransportEligibility , STP.CreatedBy AS UploaderID,  
  ISNULL(LTRIM(RTRIM(UD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(UD.Associate_LastName)),'') AS UploaderName,  
  Case when isnull(STP.Modifieddate,'')<>'' then STP.Modifieddate else STP.Createddate  end UploadedDate,  
  CPM.PROJECT_MANAGER AS PMID,  
  ISNULL(LTRIM(RTRIM(PD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(PD.Associate_LastName)),'') AS PMName,   
  (CASE WHEN STP.Status=1 THEN 'Valid'   
  WHEN STP.Status=5 THEN 'Processed'    
  WHEN STP.Status=20 THEN 'Resubmitted after Project Manager Rejection'   
  WHEN STP.Status=10 THEN 'Resubmitted after PFSS Rejection'    
  WHEN STP.Status=4 THEN 'ReSubmitted'  
  WHEN STP.Status=21 THEN 'Approved by Home Manager'   
  WHEN STP.Status=15 THEN 'Approved by Project Manager'   
  WHEN STP.Status=34 THEN 'Pending for D+ Approval'  
  WHEN STP.Status=35 THEN 'Approved by D+' END) AS Status,STP.NSADate AS ShiftStartDate   
  FROM PR.ITShiftAllowance STP WITH(NOLOCK)   
  INNER JOIN ShiftTypeMaster STM WITH(NOLOCK) ON STM.PK_ShiftTypeID=STP.FK_ShiftTypeID  
  INNER JOIN ComponentMaster CM WITH(NOLOCK) ON CM.PK_ComponentId=STP.Fk_ComponentID  
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK)   
  ON AD.Associate_ID=STP.AssociateID   
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details UD WITH(NOLOCK)   
  ON UD.Associate_ID=STP.CreatedBy   
  LEFT OUTER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Current_ProjectManager CPM WITH(NOLOCK)   
  ON CPM.PROJECT_ID=STP.ProjectID  
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details PD WITH(NOLOCK)  
  ON PD.Associate_ID=CPM.PROJECT_MANAGER  
  WHERE STP.Status IN (1,4,5,15,34,35) AND STP.RowStatus=1   
  AND ((DATEPART(MM,STP.CreatedDate)=@Month AND DATEPART(YY,STP.CreatedDate)=@Year) OR  
  (DATEPART(MM,STP.ModifiedDate)=@Month  AND DATEPART(YY,STP.ModifiedDate)=@Year))  
  and CM.PK_Componentid=@componentid and STP.CreatedBy=@LOGINID  
   END  
   ELSE IF(@COMPONENTID=50 and  @RoleID in (3,2))  
   BEGIN  
  SELECT STP.PK_ITShiftAllowanceID AS UniqueID,STP.AssociateID,  
   ISNULL(LTRIM(RTRIM(AD.Associate_FirstName)),'')+' '+  
   ISNULL(LTRIM(RTRIM(AD.Associate_LastName)),'') AS AssociateName,  
  STP.ProjectID,CM.ComponentShortName AS AllowanceType,STM.ShiftTypeName AS ShiftType,  
  CONVERT(VARCHAR,STP.STARTDATE,101) AS StartDate,  
  STP.StartTime, CONVERT(VARCHAR,STP.EndDate,101) AS Enddate,STP.EndTime,  
  ISNULL(STP.HCMSchedule,'') AS HCMShift,  
  CONVERT(VARCHAR(5),DATEDIFF(S, STP.StartDateTime, STP.EndDateTime)/3600)+':'+CONVERT(VARCHAR(5),  
  DATEDIFF(S, STP.StartDateTime, STP.EndDateTime)%3600/60) AS TotalHours,ISNULL(SDA_OCA_Amount,0) AS SDA_OCA_Amount1,  
  ISNULL(SDA_OCA_Amount2,0) AS SDA_OCA_Amount2,  
  STP.Amount AS TotalAmount,STP.TransportEligibility as TransportEligibility , STP.CreatedBy AS UploaderID,  
  ISNULL(LTRIM(RTRIM(UD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(UD.Associate_LastName)),'') AS UploaderName,  
  Case when isnull(STP.Modifieddate,'')<>'' then STP.Modifieddate else STP.Createddate  end UploadedDate,  
  CPM.PROJECT_MANAGER AS PMID,  
  ISNULL(LTRIM(RTRIM(PD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(PD.Associate_LastName)),'') AS PMName,   
  (CASE WHEN STP.Status=1 THEN 'Valid'   
  WHEN STP.Status=5 THEN 'Processed'    
  WHEN STP.Status=20 THEN 'Resubmitted after Project Manager Rejection'   
  WHEN STP.Status=10 THEN 'Resubmitted after PFSS Rejection'    
  WHEN STP.Status=4 THEN 'ReSubmitted'  
  WHEN STP.Status=21 THEN 'Approved by Home Manager'   
  WHEN STP.Status=15 THEN 'Approved by Project Manager'   
  WHEN STP.Status=34 THEN 'Pending for D+ Approval'  
  WHEN STP.Status=35 THEN 'Approved by D+' END) AS Status,STP.NSADate AS ShiftStartDate   
  FROM PR.ITShiftAllowance STP WITH(NOLOCK)   
  INNER JOIN ShiftTypeMaster STM WITH(NOLOCK) ON STM.PK_ShiftTypeID=STP.FK_ShiftTypeID  
  INNER JOIN ComponentMaster CM WITH(NOLOCK) ON CM.PK_ComponentId=STP.Fk_ComponentID  
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK)   
  ON AD.Associate_ID=STP.AssociateID   
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details UD WITH(NOLOCK)   
  ON UD.Associate_ID=STP.CreatedBy   
  LEFT OUTER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Current_ProjectManager CPM WITH(NOLOCK)   
  ON CPM.PROJECT_ID=STP.ProjectID  
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details PD WITH(NOLOCK)  
  ON PD.Associate_ID=CPM.PROJECT_MANAGER  
  WHERE STP.Status IN (1,4,5,15,34,35) AND STP.RowStatus=1   
  AND ((DATEPART(MM,STP.CreatedDate)=@Month AND DATEPART(YY,STP.CreatedDate)=@Year) OR  
  (DATEPART(MM,STP.ModifiedDate)=@Month  AND DATEPART(YY,STP.ModifiedDate)=@Year))  
  and CM.PK_Componentid=@componentid  
   END  
   ELSE  
   BEGIN  
  
   SELECT STP.PK_ITShiftAllowanceID AS UniqueID,STP.AssociateID,  
   ISNULL(LTRIM(RTRIM(AD.Associate_FirstName)),'')+' '+  
   ISNULL(LTRIM(RTRIM(AD.Associate_LastName)),'') AS AssociateName,  
  STP.ProjectID,CM.ComponentShortName AS AllowanceType,STM.ShiftTypeName AS ShiftType,  
  CONVERT(VARCHAR,STP.STARTDATE,101) AS StartDate,  
  STP.StartTime, CONVERT(VARCHAR,STP.EndDate,101) AS Enddate,STP.EndTime,  
  ISNULL(STP.HCMSchedule,'') AS HCMShift,  
  CONVERT(VARCHAR(5),DATEDIFF(S, STP.StartDateTime, STP.EndDateTime)/3600)+':'+CONVERT(VARCHAR(5),  
  DATEDIFF(S, STP.StartDateTime, STP.EndDateTime)%3600/60) AS TotalHours,  
  STP.Amount AS EligibleAmount,STP.TransportEligibility as TransportEligibility , STP.CreatedBy AS UploaderID,  
  ISNULL(LTRIM(RTRIM(UD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(UD.Associate_LastName)),'') AS UploaderName,  
  Case when isnull(STP.Modifieddate,'')<>'' then STP.Modifieddate else STP.Createddate  end UploadedDate,  
  CPM.PROJECT_MANAGER AS PMID,  
  ISNULL(LTRIM(RTRIM(PD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(PD.Associate_LastName)),'') AS PMName,   
  (CASE WHEN STP.Status=1 THEN 'Valid'   
  WHEN STP.Status=5 THEN 'Processed'    
  WHEN STP.Status=20 THEN 'Resubmitted after Project Manager Rejection'   
  WHEN STP.Status=10 THEN 'Resubmitted after PFSS Rejection'    
  WHEN STP.Status=4 THEN 'ReSubmitted'  
  WHEN STP.Status=21 THEN 'Approved by Home Manager'   
  WHEN STP.Status=15 THEN 'Approved by Project Manager'   
  WHEN STP.Status=34 THEN 'Pending for D+ Approval'  
  WHEN STP.Status=35 THEN 'Approved by D+' END) AS Status,STP.NSADate AS ShiftStartDate   
  FROM PR.ITShiftAllowance STP WITH(NOLOCK)   
  INNER JOIN ShiftTypeMaster STM WITH(NOLOCK) ON STM.PK_ShiftTypeID=STP.FK_ShiftTypeID  
  INNER JOIN ComponentMaster CM WITH(NOLOCK) ON CM.PK_ComponentId=STP.Fk_ComponentID  
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK)   
  ON AD.Associate_ID=STP.AssociateID   
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details UD WITH(NOLOCK)   
  ON UD.Associate_ID=STP.CreatedBy   
  LEFT OUTER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Current_ProjectManager CPM WITH(NOLOCK)   
  ON CPM.PROJECT_ID=STP.ProjectID  
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details PD WITH(NOLOCK)  
  ON PD.Associate_ID=CPM.PROJECT_MANAGER  
  WHERE STP.Status IN (1,4,5,15,34,35) AND STP.RowStatus=1   
  AND ((DATEPART(MM,STP.CreatedDate)=@Month AND DATEPART(YY,STP.CreatedDate)=@Year) OR  
  (DATEPART(MM,STP.ModifiedDate)=@Month  AND DATEPART(YY,STP.ModifiedDate)=@Year))  
  and CM.PK_Componentid=@componentid  
   END  
   END  
 END   
  END   
       --ADM 6DA,OCA,NSA  
  IF(@Componentid in (170,171,172))  
     BEGIN  
  --Project MAnager  
   IF(@Componentid=172 and @RoleID in (6,5))  
   BEGIN  
     CREATE TABLE #ADMCOMPONENTSP (ComponentID INT,ProjectID VARCHAR(50))  
             
   --Inserting Admcomponents data  
   INSERT INTO #ADMCOMPONENTSP (ComponentID ,ProjectID)     
   EXEC [dbo].[usp_GetComponentsForRole] @RoleID,@LoginID,@ComponentGrpID,@CountryID    
            
   --Selcting the Associate data  
  SELECT STP.PK_ADMShiftAllowanceID AS UniqueID,STP.AssociateID,  
  ISNULL(LTRIM(RTRIM(AD.Associate_FirstName)),'')+' '+  
  ISNULL(LTRIM(RTRIM(AD.Associate_LastName)),'') AS AssociateName ,  
  STP.ProjectID,CM.ComponentShortName AS AllowanceType,STM.ShiftTypeName AS ShiftType,  
  CONVERT(VARCHAR,STP.STARTDATE,101) AS StartDate,  
  CONVERT(VARCHAR,STP.EndDate,101) AS Enddate,  
  CONVERT(VARCHAR(5),DATEDIFF(S, STP.StartDateTime, STP.EndDateTime)/3600)+':'+CONVERT(VARCHAR(5),  
  DATEDIFF(S, STP.StartDateTime, STP.EndDateTime)%3600/60) AS TotalHours,  
  STP.Amount AS EligibleAmount,STP.ADM_Amount ,STP.TransportEligibility as TransportEligibility ,STP.CreatedBy   
  AS UploaderID,  
  ISNULL(LTRIM(RTRIM(UD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(UD.Associate_LastName)),'') AS UploaderName,  
  Case when isnull(STP.Modifieddate,'')<>'' then STP.Modifieddate  else STP.Createddate  end UploadedDate,  
  CPM.PROJECT_MANAGER AS PMID,  
  ISNULL(LTRIM(RTRIM(PD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(PD.Associate_LastName)),'') AS PMName,   
  (CASE WHEN STP.Status=1 THEN 'Valid' WHEN STP.Status=5 THEN 'Processed'   
  WHEN STP.Status=4 THEN 'ReSubmitted' END) AS Status,  
  STP.NSADate AS ShiftStartDate  
  , RNSA.RecalledComments, RNSA.ModifiedStartDateTime, RNSA.ModifiedEndDateTime  
  FROM PR.ADMShiftAllowance STP WITH(NOLOCK)   
  INNER JOIN ShiftTypeMaster STM WITH(NOLOCK) ON STM.PK_ShiftTypeID=STP.FK_ShiftTypeID  
  INNER JOIN ComponentMaster CM WITH(NOLOCK) ON CM.PK_ComponentId=STP.Fk_ComponentID  
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK)   
  ON AD.Associate_ID=STP.AssociateID   
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details UD WITH(NOLOCK)   
  ON UD.Associate_ID=STP.CreatedBy   
  LEFT OUTER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Current_ProjectManager CPM WITH(NOLOCK)   
  ON CPM.PROJECT_ID=STP.ProjectID  
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details PD WITH(NOLOCK)   
  ON PD.Associate_ID=CPM.PROJECT_MANAGER  
  INNER JOIN #ADMCOMPONENTSP CMTS WITH(NOLOCK) ON  CMTS.ComponentID=STP.Fk_ComponentID   
  AND CMTS.ProjectID=STP.ProjectID  
  LEFT JOIN PR.Trutime_Recalled_NSA RNSA ON RNSA.AssociateID = STP.AssociateID AND RNSA.Date = STP.NSADate  
        AND RNSA.Fk_ComponentID = STP.Fk_ComponentID AND RNSA.ProjectID = STP.ProjectID AND RNSA.RowStatus = 1  
  WHERE STP.Status IN (1,5,4) AND STP.RowStatus=1 AND DATEPART(MM,STP.CreatedDate)=@Month   
  AND DATEPART(YY,STP.CreatedDate)=@Year  
  and CM.Pk_ComponentID=@Componentid  
            
    --Drops the temp table  
  DROP TABLE  #ADMCOMPONENTSP   
   END  
  ELSE IF(@Componentid not in (172) and @RoleID=6)  
   BEGIN  
  
   CREATE TABLE #ADMCOMPONENTS (ComponentID INT,ProjectID VARCHAR(50))  
             
   --Inserting Admcomponents data  
   INSERT INTO #ADMCOMPONENTS (ComponentID ,ProjectID)     
   EXEC [dbo].[usp_GetComponentsForRole] @RoleID,@LoginID,@ComponentGrpID,@CountryID    
            
   --Selcting the Associate data  
  SELECT STP.AssociateID,  
  ISNULL(LTRIM(RTRIM(AD.Associate_FirstName)),'')+' '+  
  ISNULL(LTRIM(RTRIM(AD.Associate_LastName)),'') AS AssociateName ,  
  STP.ProjectID,CM.ComponentShortName AS AllowanceType,STM.ShiftTypeName AS ShiftType,  
  CONVERT(VARCHAR,STP.STARTDATE,101) AS StartDate,  
  STP.StartTime, CONVERT(VARCHAR,STP.EndDate,101) AS Enddate,STP.EndTime,ISNULL(STP.HCMSchedule,'') AS HCMShift,  
  CONVERT(VARCHAR(5),DATEDIFF(S, STP.StartDateTime, STP.EndDateTime)/3600)+':'+CONVERT(VARCHAR(5),  
  DATEDIFF(S, STP.StartDateTime, STP.EndDateTime)%3600/60) AS TotalHours,  
  STP.Amount AS EligibleAmount,STP.ADM_Amount ,STP.TransportEligibility as TransportEligibility ,STP.CreatedBy   
  AS UploaderID,  
  ISNULL(LTRIM(RTRIM(UD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(UD.Associate_LastName)),'') AS UploaderName,  
  Case when isnull(STP.Modifieddate,'')<>'' then STP.Modifieddate  else STP.Createddate  end UploadedDate,  
  CPM.PROJECT_MANAGER AS PMID,  
  ISNULL(LTRIM(RTRIM(PD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(PD.Associate_LastName)),'') AS PMName,   
  (CASE WHEN STP.Status=1 THEN 'Valid' WHEN STP.Status=5 THEN 'Processed'  
  WHEN STP.Status=4 THEN 'ReSubmitted' END) AS Status,  
  STP.NSADate AS ShiftStartDate   
  FROM PR.ADMShiftAllowance STP WITH(NOLOCK)   
  INNER JOIN ShiftTypeMaster STM WITH(NOLOCK) ON STM.PK_ShiftTypeID=STP.FK_ShiftTypeID  
  INNER JOIN ComponentMaster CM WITH(NOLOCK) ON CM.PK_ComponentId=STP.Fk_ComponentID  
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK)   
  ON AD.Associate_ID=STP.AssociateID   
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details UD WITH(NOLOCK)   
  ON UD.Associate_ID=STP.CreatedBy   
  LEFT OUTER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Current_ProjectManager CPM WITH(NOLOCK)   
  ON CPM.PROJECT_ID=STP.ProjectID  
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details PD WITH(NOLOCK)   
  ON PD.Associate_ID=CPM.PROJECT_MANAGER  
  INNER JOIN #ADMCOMPONENTS CMTS WITH(NOLOCK) ON  CMTS.ComponentID=STP.Fk_ComponentID   
  AND CMTS.ProjectID=STP.ProjectID  
  WHERE STP.Status IN (1,5,4) AND STP.RowStatus=1 AND DATEPART(MM,STP.CreatedDate)=@Month   
  AND DATEPART(YY,STP.CreatedDate)=@Year  
  and CM.Pk_ComponentID=@Componentid  
            
    --Drops the temp table  
  DROP TABLE  #ADMCOMPONENTS   
  
 END   
  
  ELSE  
   BEGIN  
    --ADM On Call Allowance  
   IF(@Componentid=171 and @RoleID in (3,2))  
   BEGIN  
  
  SELECT STP.PK_ADMShiftAllowanceID AS UniqueID, STP.AssociateID,  
  ISNULL(LTRIM(RTRIM(AD.Associate_FirstName)),'')+' '+  
  ISNULL(LTRIM(RTRIM(AD.Associate_LastName)),'') AS AssociateName ,  
  STP.ProjectID,CM.ComponentShortName AS AllowanceType,STM.ShiftTypeName AS ShiftType,  
  CONVERT(VARCHAR,STP.STARTDATE,101) AS StartDate,  
  STP.StartTime, CONVERT(VARCHAR,STP.EndDate,101) AS Enddate,STP.EndTime,ISNULL(STP.HCMSchedule,'') AS HCMShift,  
  CONVERT(VARCHAR(5),DATEDIFF(S, STP.StartDateTime, STP.EndDateTime)/3600)+':'+CONVERT(VARCHAR(5),  
  DATEDIFF(S, STP.StartDateTime, STP.EndDateTime)%3600/60) AS TotalHours,ISNULL(SDA_OCA_Amount,0) AS SDA_OCA_Amount1,  
  ISNULL(SDA_OCA_Amount2,0) AS SDA_OCA_Amount2,  
  STP.Amount AS TotalAmount,STP.ADM_Amount ,STP.TransportEligibility as TransportEligibility ,  
  STP.CreatedBy AS UploaderID,  
  ISNULL(LTRIM(RTRIM(UD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(UD.Associate_LastName)),'') AS UploaderName,  
  Case when isnull(STP.Modifieddate,'')<>'' then STP.Modifieddate else STP.Createddate  end UploadedDate,  
  CPM.PROJECT_MANAGER AS PMID,  
  ISNULL(LTRIM(RTRIM(PD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(PD.Associate_LastName)),'') AS PMName,   
  (CASE WHEN STP.Status=1 THEN 'Valid' WHEN STP.Status=5 THEN 'Processed'   
  WHEN STP.Status=20 THEN 'Resubmitted after Project Manager Rejection'  
  WHEN STP.Status=10 THEN 'Resubmitted after PFSS Rejection'    
  WHEN STP.Status=4 THEN 'ReSubmitted'   
  WHEN STP.Status=21 THEN 'Approved by Home Manager'   
  WHEN STP.Status=15 THEN 'Approved by Project Manager'   
  WHEN STP.Status=34 THEN 'Pending for D+ Approval'  
  WHEN STP.Status=35 THEN 'Approved by D+' END) AS Status,  
  STP.NSADate As ShiftStartDate  
  FROM PR.ADMShiftAllowance STP WITH(NOLOCK)   
  INNER JOIN ShiftTypeMaster STM WITH(NOLOCK) ON STM.PK_ShiftTypeID=STP.FK_ShiftTypeID  
  INNER JOIN ComponentMaster CM WITH(NOLOCK) ON CM.PK_ComponentId=STP.Fk_ComponentID  
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK)   
  ON AD.Associate_ID=STP.AssociateID   
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details UD WITH(NOLOCK)   
  ON UD.Associate_ID=STP.CreatedBy   
  LEFT OUTER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Current_ProjectManager CPM WITH(NOLOCK)   
  ON CPM.PROJECT_ID=STP.ProjectID  
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details PD WITH(NOLOCK)   
  ON PD.Associate_ID=CPM.PROJECT_MANAGER  
  WHERE STP.Status IN (4,5,15,21,34,35) AND STP.RowStatus=1 AND ((DATEPART(MM,STP.CreatedDate)=@Month   
  AND DATEPART(YY,STP.CreatedDate)=@Year) OR  
  (DATEPART(MM,STP.ModifiedDate)=@Month  AND DATEPART(YY,STP.ModifiedDate)=@Year))  
  and CM.PK_Componentid=@componentid  
   END  
   ELSE IF(@Componentid =171 and @RoleID!=3)  
   BEGIN  
  SELECT STP.PK_ADMShiftAllowanceID AS UniqueID, STP.AssociateID,  
  ISNULL(LTRIM(RTRIM(AD.Associate_FirstName)),'')+' '+  
  ISNULL(LTRIM(RTRIM(AD.Associate_LastName)),'') AS AssociateName ,  
  STP.ProjectID,CM.ComponentShortName AS AllowanceType,STM.ShiftTypeName AS ShiftType,  
  CONVERT(VARCHAR,STP.STARTDATE,101) AS StartDate,  
  STP.StartTime, CONVERT(VARCHAR,STP.EndDate,101) AS Enddate,STP.EndTime,ISNULL(STP.HCMSchedule,'') AS HCMShift,  
  CONVERT(VARCHAR(5),DATEDIFF(S, STP.StartDateTime, STP.EndDateTime)/3600)+':'+CONVERT(VARCHAR(5),  
  DATEDIFF(S, STP.StartDateTime, STP.EndDateTime)%3600/60) AS TotalHours,  
  STP.Amount AS EligibleAmount,STP.ADM_Amount ,STP.TransportEligibility as TransportEligibility ,  
  STP.CreatedBy AS UploaderID,  
  ISNULL(LTRIM(RTRIM(UD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(UD.Associate_LastName)),'') AS UploaderName,  
  Case when isnull(STP.Modifieddate,'')<>'' then STP.Modifieddate else STP.Createddate  end UploadedDate,  
  CPM.PROJECT_MANAGER AS PMID,AD.Supervisor_ID as HMID, 
  ISNULL(LTRIM(RTRIM(PD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(PD.Associate_LastName)),'') AS PMName,
  	  ISNULL(LTRIM(RTRIM(HM.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(HM.Associate_LastName)),'') AS HMName,
  (CASE WHEN STP.Status=1 THEN 'Valid' WHEN STP.Status=5 THEN 'Processed'   
  WHEN STP.Status=20 THEN 'Resubmitted after Project Manager Rejection'  
  WHEN STP.Status=10 THEN 'Resubmitted after PFSS Rejection'    
  WHEN STP.Status=4 THEN 'ReSubmitted'   
  WHEN STP.Status=21 THEN 'Approved by Home Manager'   
  WHEN STP.Status=15 THEN 'Approved by Project Manager'   
  WHEN STP.Status=34 THEN 'Pending for D+ Approval'  
  WHEN STP.Status=35 THEN 'Approved by D+' END) AS Status,  
  STP.NSADate As ShiftStartDate  
  FROM PR.ADMShiftAllowance STP WITH(NOLOCK)   
  INNER JOIN ShiftTypeMaster STM WITH(NOLOCK) ON STM.PK_ShiftTypeID=STP.FK_ShiftTypeID  
  INNER JOIN ComponentMaster CM WITH(NOLOCK) ON CM.PK_ComponentId=STP.Fk_ComponentID  
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK)   
  ON AD.Associate_ID=STP.AssociateID   
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details UD WITH(NOLOCK)   
  ON UD.Associate_ID=STP.CreatedBy   
  LEFT OUTER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Current_ProjectManager CPM WITH(NOLOCK)   
  ON CPM.PROJECT_ID=STP.ProjectID  
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details PD WITH(NOLOCK)   
  ON PD.Associate_ID=CPM.PROJECT_MANAGER 
  INNER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details HM WITH(NOLOCK)   
     ON AD.Supervisor_ID=HM.Associate_ID
  WHERE STP.Status IN (1,4,5,15,21,34,35) AND STP.RowStatus=1 AND ((DATEPART(MM,STP.CreatedDate)=@Month   
  AND DATEPART(YY,STP.CreatedDate)=@Year) OR  
  (DATEPART(MM,STP.ModifiedDate)=@Month  AND DATEPART(YY,STP.ModifiedDate)=@Year))  
  and CM.PK_Componentid=@componentid  and STP.Createdby=@Loginid
   END  
    --ADM Night Shift Allowance  
   ELSE IF(@Componentid=172)  
   BEGIN  
    IF(@RoleID=1)  
    BEGIN  
    SELECT STP.PK_ADMShiftAllowanceID AS UniqueID, STP.AssociateID,  
  ISNULL(LTRIM(RTRIM(AD.Associate_FirstName)),'')+' '+  
  ISNULL(LTRIM(RTRIM(AD.Associate_LastName)),'') AS AssociateName ,  
  STP.ProjectID,CM.ComponentShortName AS AllowanceType,STM.ShiftTypeName AS ShiftType,  
  CONVERT(VARCHAR,STP.STARTDATE,101) AS StartDate,  
  STP.StartTime, CONVERT(VARCHAR,STP.EndDate,101) AS Enddate,STP.EndTime,  
  ISNULL(STP.HCMSchedule,'') AS HCMShift,  
  CONVERT(VARCHAR(5),DATEDIFF(S, STP.StartDateTime, STP.EndDateTime)/3600)+':'+CONVERT(VARCHAR(5),  
  DATEDIFF(S, STP.StartDateTime, STP.EndDateTime)%3600/60) AS TotalHours,  
  STP.Amount AS EligibleAmount,STP.ADM_Amount ,STP.TransportEligibility as TransportEligibility ,   
  STP.CreatedBy AS UploaderID,  
  ISNULL(LTRIM(RTRIM(UD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(UD.Associate_LastName)),'') AS UploaderName,  
  Case when isnull(STP.Modifieddate,'')<>'' then STP.Modifieddate else STP.Createddate  end UploadedDate,  
  CPM.PROJECT_MANAGER AS PMID,  
  ISNULL(LTRIM(RTRIM(PD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(PD.Associate_LastName)),'') AS PMName,   
  (CASE WHEN STP.Status=1 THEN 'Valid'   
  WHEN STP.Status=5 THEN 'Processed'    
  WHEN STP.Status=20 THEN 'Resubmitted after Project Manager Rejection'  
  WHEN STP.Status=10 THEN 'Resubmitted after PFSS Rejection'   
  WHEN STP.Status=4 THEN 'ReSubmitted'   
  WHEN STP.Status=21 THEN 'Approved by Home Manager'  
  WHEN STP.Status=15 THEN 'Approved by Project Manager'   
  WHEN STP.Status=34 THEN 'Pending for D+ Approval'  
  WHEN STP.Status=35 THEN 'Approved by D+' END) AS Status,  
  STP.NSADate As ShiftStartDate  
  , RNSA.RecalledComments, RNSA.ModifiedStartDateTime, RNSA.ModifiedEndDateTime  
  FROM PR.ADMShiftAllowance STP WITH(NOLOCK)   
  INNER JOIN ShiftTypeMaster STM WITH(NOLOCK) ON STM.PK_ShiftTypeID=STP.FK_ShiftTypeID  
  INNER JOIN ComponentMaster CM WITH(NOLOCK) ON CM.PK_ComponentId=STP.Fk_ComponentID  
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK)   
  ON AD.Associate_ID=STP.AssociateID   
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details UD WITH(NOLOCK)   
  ON UD.Associate_ID=STP.CreatedBy   
  LEFT OUTER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Current_ProjectManager CPM WITH(NOLOCK)   
  ON CPM.PROJECT_ID=STP.ProjectID  
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details PD WITH(NOLOCK)  
  ON PD.Associate_ID=CPM.PROJECT_MANAGER  
  LEFT JOIN PR.Trutime_Recalled_NSA RNSA ON RNSA.AssociateID = STP.AssociateID AND RNSA.Date = STP.NSADate  
        AND RNSA.Fk_ComponentID = STP.Fk_ComponentID AND RNSA.ProjectID = STP.ProjectID AND RNSA.RowStatus = 1  
  WHERE STP.Status IN (1,4,5,15,34,35) AND STP.RowStatus=1 AND ((DATEPART(MM,STP.CreatedDate)=@Month   
  AND DATEPART(YY,STP.CreatedDate)=@Year) OR  
  (DATEPART(MM,STP.ModifiedDate)=@Month  AND DATEPART(YY,STP.ModifiedDate)=@Year))  
  and CM.PK_Componentid=@componentid and STP.CreatedBy=@LOGINID    
    END  
    ELSE  
    BEGIN  
   --Selcting the Associate data  
  SELECT STP.PK_ADMShiftAllowanceID AS UniqueID, STP.AssociateID,  
  ISNULL(LTRIM(RTRIM(AD.Associate_FirstName)),'')+' '+  
  ISNULL(LTRIM(RTRIM(AD.Associate_LastName)),'') AS AssociateName ,  
  STP.ProjectID,CM.ComponentShortName AS AllowanceType,STM.ShiftTypeName AS ShiftType,  
  CONVERT(VARCHAR,STP.STARTDATE,101) AS StartDate,  
  STP.StartTime, CONVERT(VARCHAR,STP.EndDate,101) AS Enddate,STP.EndTime,  
  ISNULL(STP.HCMSchedule,'') AS HCMShift,  
  CONVERT(VARCHAR(5),DATEDIFF(S, STP.StartDateTime, STP.EndDateTime)/3600)+':'+CONVERT(VARCHAR(5),  
  DATEDIFF(S, STP.StartDateTime, STP.EndDateTime)%3600/60) AS TotalHours,  
  STP.Amount AS EligibleAmount,STP.ADM_Amount ,STP.TransportEligibility as TransportEligibility ,   
  STP.CreatedBy AS UploaderID,  
  ISNULL(LTRIM(RTRIM(UD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(UD.Associate_LastName)),'') AS UploaderName,  
  Case when isnull(STP.Modifieddate,'')<>'' then STP.Modifieddate else STP.Createddate  end UploadedDate,  
  CPM.PROJECT_MANAGER AS PMID,  
  ISNULL(LTRIM(RTRIM(PD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(PD.Associate_LastName)),'') AS PMName,   
  (CASE WHEN STP.Status=1 THEN 'Valid'   
  WHEN STP.Status=5 THEN 'Processed'    
  WHEN STP.Status=20 THEN 'Resubmitted after Project Manager Rejection'  
  WHEN STP.Status=10 THEN 'Resubmitted after PFSS Rejection'   
  WHEN STP.Status=4 THEN 'ReSubmitted'   
  WHEN STP.Status=21 THEN 'Approved by Home Manager'  
  WHEN STP.Status=15 THEN 'Approved by Project Manager'   
  WHEN STP.Status=34 THEN 'Pending for D+ Approval'  
  WHEN STP.Status=35 THEN 'Approved by D+' END) AS Status,  
  STP.NSADate As ShiftStartDate  
  , RNSA.RecalledComments, RNSA.ModifiedStartDateTime, RNSA.ModifiedEndDateTime  
  FROM PR.ADMShiftAllowance STP WITH(NOLOCK)   
  INNER JOIN ShiftTypeMaster STM WITH(NOLOCK) ON STM.PK_ShiftTypeID=STP.FK_ShiftTypeID  
  INNER JOIN ComponentMaster CM WITH(NOLOCK) ON CM.PK_ComponentId=STP.Fk_ComponentID  
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK)   
  ON AD.Associate_ID=STP.AssociateID   
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details UD WITH(NOLOCK)   
  ON UD.Associate_ID=STP.CreatedBy   
  LEFT OUTER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Current_ProjectManager CPM WITH(NOLOCK)   
  ON CPM.PROJECT_ID=STP.ProjectID  
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details PD WITH(NOLOCK)  
  ON PD.Associate_ID=CPM.PROJECT_MANAGER  
  LEFT JOIN PR.Trutime_Recalled_NSA RNSA ON RNSA.AssociateID = STP.AssociateID AND RNSA.Date = STP.NSADate  
        AND RNSA.Fk_ComponentID = STP.Fk_ComponentID AND RNSA.ProjectID = STP.ProjectID AND RNSA.RowStatus = 1  
  WHERE STP.Status IN (1,4,5,15,34,35) AND STP.RowStatus=1 AND ((DATEPART(MM,STP.CreatedDate)=@Month   
  AND DATEPART(YY,STP.CreatedDate)=@Year) OR  
  (DATEPART(MM,STP.ModifiedDate)=@Month  AND DATEPART(YY,STP.ModifiedDate)=@Year))  
  and CM.PK_Componentid=@componentid  
   END  
     
   END  
   ELSE  
   BEGIN  
  IF(@RoleID=1)  
   BEGIN  
   SELECT STP.PK_ADMShiftAllowanceID AS UniqueID, STP.AssociateID,  
  ISNULL(LTRIM(RTRIM(AD.Associate_FirstName)),'')+' '+  
  ISNULL(LTRIM(RTRIM(AD.Associate_LastName)),'') AS AssociateName,  
  STP.ProjectID,CM.ComponentShortName AS AllowanceType,STM.ShiftTypeName AS ShiftType,  
  CONVERT(VARCHAR,STP.STARTDATE,101) AS StartDate,  
  STP.StartTime, CONVERT(VARCHAR,STP.EndDate,101) AS Enddate,STP.EndTime,  
  ISNULL(STP.HCMSchedule,'') AS HCMShift,  
  CONVERT(VARCHAR(5),DATEDIFF(S, STP.StartDateTime, STP.EndDateTime)/3600)+':'+CONVERT(VARCHAR(5),  
  DATEDIFF(S, STP.StartDateTime, STP.EndDateTime)%3600/60) AS TotalHours,  
  STP.Amount AS EligibleAmount,STP.ADM_Amount ,STP.TransportEligibility as TransportEligibility ,   
  STP.CreatedBy AS UploaderID,  
  ISNULL(LTRIM(RTRIM(UD.Associate_FirstName)),'')+' '+  
  ISNULL(LTRIM(RTRIM(UD.Associate_LastName)),'') AS UploaderName,  
  Case when isnull(STP.Modifieddate,'')<>'' then STP.Modifieddate else STP.Createddate  end UploadedDate,  
  CPM.PROJECT_MANAGER AS PMID,  
  ISNULL(LTRIM(RTRIM(PD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(PD.Associate_LastName)),'') AS PMName,   
  (CASE WHEN STP.Status=1 THEN 'Valid'   
  WHEN STP.Status=5 THEN 'Processed'    
  WHEN STP.Status=20 THEN 'Resubmitted after Project Manager Rejection'  
  WHEN STP.Status=10 THEN 'Resubmitted after PFSS Rejection'   
  WHEN STP.Status=4 THEN 'ReSubmitted'   
  WHEN STP.Status=21 THEN 'Approved by Home Manager'  
  WHEN STP.Status=15 THEN 'Approved by Project Manager'   
  WHEN STP.Status=34 THEN 'Pending for D+ Approval'  
  WHEN STP.Status=35 THEN 'Approved by D+' END) AS Status,  
  STP.NSADate As ShiftStartDate  
  FROM PR.ADMShiftAllowance STP WITH(NOLOCK)   
  INNER JOIN ShiftTypeMaster STM WITH(NOLOCK) ON STM.PK_ShiftTypeID=STP.FK_ShiftTypeID  
  INNER JOIN ComponentMaster CM WITH(NOLOCK) ON CM.PK_ComponentId=STP.Fk_ComponentID  
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK)   
  ON AD.Associate_ID=STP.AssociateID   
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details UD WITH(NOLOCK)   
  ON UD.Associate_ID=STP.CreatedBy   
  LEFT OUTER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Current_ProjectManager CPM WITH(NOLOCK)   
  ON CPM.PROJECT_ID=STP.ProjectID  
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details PD WITH(NOLOCK)  
  ON PD.Associate_ID=CPM.PROJECT_MANAGER  
  WHERE STP.Status IN (1,4,5,15,34,35) AND STP.RowStatus=1 AND ((DATEPART(MM,STP.CreatedDate)=@Month   
  AND DATEPART(YY,STP.CreatedDate)=@Year) OR  
  (DATEPART(MM,STP.ModifiedDate)=@Month  AND DATEPART(YY,STP.ModifiedDate)=@Year))  
  and CM.PK_Componentid=@componentid and STP.CreatedBy=@LOGINID  
  
   END  
  ELSE IF(@Componentid=170 and @RoleID in (3,2))  
  BEGIN  
   SELECT STP.PK_ADMShiftAllowanceID AS UniqueID, STP.AssociateID,  
  ISNULL(LTRIM(RTRIM(AD.Associate_FirstName)),'')+' '+  
  ISNULL(LTRIM(RTRIM(AD.Associate_LastName)),'') AS AssociateName,  
  STP.ProjectID,CM.ComponentShortName AS AllowanceType,STM.ShiftTypeName AS ShiftType,  
  CONVERT(VARCHAR,STP.STARTDATE,101) AS StartDate,  
  STP.StartTime, CONVERT(VARCHAR,STP.EndDate,101) AS Enddate,STP.EndTime,  
  ISNULL(STP.HCMSchedule,'') AS HCMShift,  
  CONVERT(VARCHAR(5),DATEDIFF(S, STP.StartDateTime, STP.EndDateTime)/3600)+':'+CONVERT(VARCHAR(5),  
  DATEDIFF(S, STP.StartDateTime, STP.EndDateTime)%3600/60) AS TotalHours,ISNULL(SDA_OCA_Amount,0) AS SDA_OCA_Amount1,  
  ISNULL(SDA_OCA_Amount2,0) AS SDA_OCA_Amount2,  
  STP.Amount AS TotalAmount,STP.ADM_Amount ,STP.TransportEligibility as TransportEligibility ,   
  STP.CreatedBy AS UploaderID,  
  ISNULL(LTRIM(RTRIM(UD.Associate_FirstName)),'')+' '+  
  ISNULL(LTRIM(RTRIM(UD.Associate_LastName)),'') AS UploaderName,  
  Case when isnull(STP.Modifieddate,'')<>'' then STP.Modifieddate else STP.Createddate  end UploadedDate,  
  CPM.PROJECT_MANAGER AS PMID,  
  ISNULL(LTRIM(RTRIM(PD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(PD.Associate_LastName)),'') AS PMName,   
  (CASE WHEN STP.Status=1 THEN 'Valid'   
  WHEN STP.Status=5 THEN 'Processed'    
  WHEN STP.Status=20 THEN 'Resubmitted after Project Manager Rejection'  
  WHEN STP.Status=10 THEN 'Resubmitted after PFSS Rejection'   
  WHEN STP.Status=4 THEN 'ReSubmitted'   
  WHEN STP.Status=21 THEN 'Approved by Home Manager'  
  WHEN STP.Status=15 THEN 'Approved by Project Manager'   
  WHEN STP.Status=34 THEN 'Pending for D+ Approval'  
  WHEN STP.Status=35 THEN 'Approved by D+' END) AS Status,  
  STP.NSADate As ShiftStartDate  
  FROM PR.ADMShiftAllowance STP WITH(NOLOCK)   
  INNER JOIN ShiftTypeMaster STM WITH(NOLOCK) ON STM.PK_ShiftTypeID=STP.FK_ShiftTypeID  
  INNER JOIN ComponentMaster CM WITH(NOLOCK) ON CM.PK_ComponentId=STP.Fk_ComponentID  
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK)   
  ON AD.Associate_ID=STP.AssociateID   
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details UD WITH(NOLOCK)   
  ON UD.Associate_ID=STP.CreatedBy   
  LEFT OUTER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Current_ProjectManager CPM WITH(NOLOCK)   
  ON CPM.PROJECT_ID=STP.ProjectID  
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details PD WITH(NOLOCK)  
  ON PD.Associate_ID=CPM.PROJECT_MANAGER  
  WHERE STP.Status IN (1,4,5,15,34,35) AND STP.RowStatus=1 AND ((DATEPART(MM,STP.CreatedDate)=@Month   
  AND DATEPART(YY,STP.CreatedDate)=@Year) OR  
  (DATEPART(MM,STP.ModifiedDate)=@Month  AND DATEPART(YY,STP.ModifiedDate)=@Year))  
  and CM.PK_Componentid=@componentid  
  END  
  ELSE  
   BEGIN  
   --ADM 6th Day Allowance  
  SELECT STP.PK_ADMShiftAllowanceID AS UniqueID, STP.AssociateID,  
  ISNULL(LTRIM(RTRIM(AD.Associate_FirstName)),'')+' '+  
  ISNULL(LTRIM(RTRIM(AD.Associate_LastName)),'') AS AssociateName,  
  STP.ProjectID,CM.ComponentShortName AS AllowanceType,STM.ShiftTypeName AS ShiftType,  
  CONVERT(VARCHAR,STP.STARTDATE,101) AS StartDate,  
  STP.StartTime, CONVERT(VARCHAR,STP.EndDate,101) AS Enddate,STP.EndTime,  
  ISNULL(STP.HCMSchedule,'') AS HCMShift,  
  CONVERT(VARCHAR(5),DATEDIFF(S, STP.StartDateTime, STP.EndDateTime)/3600)+':'+CONVERT(VARCHAR(5),  
  DATEDIFF(S, STP.StartDateTime, STP.EndDateTime)%3600/60) AS TotalHours,  
  STP.Amount AS EligibleAmount,STP.ADM_Amount ,STP.TransportEligibility as TransportEligibility ,   
  STP.CreatedBy AS UploaderID,  
  ISNULL(LTRIM(RTRIM(UD.Associate_FirstName)),'')+' '+  
  ISNULL(LTRIM(RTRIM(UD.Associate_LastName)),'') AS UploaderName,  
  Case when isnull(STP.Modifieddate,'')<>'' then STP.Modifieddate else STP.Createddate  end UploadedDate,  
  CPM.PROJECT_MANAGER AS PMID,  
  ISNULL(LTRIM(RTRIM(PD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(PD.Associate_LastName)),'') AS PMName,   
  (CASE WHEN STP.Status=1 THEN 'Valid'   
  WHEN STP.Status=5 THEN 'Processed'    
  WHEN STP.Status=20 THEN 'Resubmitted after Project Manager Rejection'  
  WHEN STP.Status=10 THEN 'Resubmitted after PFSS Rejection'   
  WHEN STP.Status=4 THEN 'ReSubmitted'   
  WHEN STP.Status=21 THEN 'Approved by Home Manager'  
  WHEN STP.Status=15 THEN 'Approved by Project Manager'   
  WHEN STP.Status=34 THEN 'Pending for D+ Approval'  
  WHEN STP.Status=35 THEN 'Approved by D+' END) AS Status,  
  STP.NSADate As ShiftStartDate  
  FROM PR.ADMShiftAllowance STP WITH(NOLOCK)   
  INNER JOIN ShiftTypeMaster STM WITH(NOLOCK) ON STM.PK_ShiftTypeID=STP.FK_ShiftTypeID  
  INNER JOIN ComponentMaster CM WITH(NOLOCK) ON CM.PK_ComponentId=STP.Fk_ComponentID  
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK)   
  ON AD.Associate_ID=STP.AssociateID   
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details UD WITH(NOLOCK)   
  ON UD.Associate_ID=STP.CreatedBy   
  LEFT OUTER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Current_ProjectManager CPM WITH(NOLOCK)   
  ON CPM.PROJECT_ID=STP.ProjectID  
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details PD WITH(NOLOCK)  
  ON PD.Associate_ID=CPM.PROJECT_MANAGER  
  WHERE STP.Status IN (1,4,5,15,34,35) AND STP.RowStatus=1 AND ((DATEPART(MM,STP.CreatedDate)=@Month   
  AND DATEPART(YY,STP.CreatedDate)=@Year) OR  
  (DATEPART(MM,STP.ModifiedDate)=@Month  AND DATEPART(YY,STP.ModifiedDate)=@Year))  
  and CM.PK_Componentid=@componentid  
   END  
  END  
  END  
    
  END  
  
  --VNM NSA--  
  IF(@Componentid in (175))  
  BEGIN  
 --Project Manager  
 IF(@Componentid=175 and @RoleID in (6))  
 BEGIN  
  CREATE TABLE #VNMCOMPONENTSP (ComponentID INT,ProjectID VARCHAR(50))  
  --Inserting VNMComponents data  
  INSERT INTO #VNMCOMPONENTSP (ComponentID ,ProjectID)     
  EXEC [dbo].[usp_GetComponentsForRole] @RoleID,@LoginID,@ComponentGrpID,@CountryID    
           
  --Selcting the Associate data  
  SELECT STP.PK_VNMShiftAllowanceID AS UniqueID,STP.AssociateID,  
  ISNULL(LTRIM(RTRIM(AD.Associate_FirstName)),'')+' '+  
  ISNULL(LTRIM(RTRIM(AD.Associate_LastName)),'') AS AssociateName ,  
  STP.ProjectID,CM.ComponentShortName AS AllowanceType,STM.ShiftTypeName AS ShiftType,  
  CONVERT(VARCHAR,STP.STARTDATE,101) AS StartDate,  
  CONVERT(VARCHAR,STP.EndDate,101) AS Enddate,  
  CONVERT(VARCHAR(5),DATEDIFF(S, STP.StartDateTime, STP.EndDateTime)/3600)+':'+CONVERT(VARCHAR(5),  
  DATEDIFF(S, STP.StartDateTime, STP.EndDateTime)%3600/60) AS TotalHours,  
  STP.Amount AS EligibleAmount,STP.VNM_Amount ,STP.TransportEligibility as TransportEligibility ,STP.CreatedBy   
  AS UploaderID,  
  ISNULL(LTRIM(RTRIM(UD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(UD.Associate_LastName)),'') AS UploaderName,  
  Case when isnull(STP.Modifieddate,'')<>'' then STP.Modifieddate  else STP.Createddate  end UploadedDate,  
  CPM.PROJECT_MANAGER AS PMID,  
  ISNULL(LTRIM(RTRIM(PD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(PD.Associate_LastName)),'') AS PMName,   
  (CASE WHEN STP.Status=1 THEN 'Valid' WHEN STP.Status=5 THEN 'Processed'   
  WHEN STP.Status=4 THEN 'ReSubmitted' END) AS Status,  
  STP.NSADate AS ShiftStartDate  
  , RNSA.RecalledComments, RNSA.ModifiedStartDateTime, RNSA.ModifiedEndDateTime  
  FROM PR.VNMShiftAllowance STP WITH(NOLOCK)   
  INNER JOIN ShiftTypeMaster STM WITH(NOLOCK) ON STM.PK_ShiftTypeID=STP.FK_ShiftTypeID  
  INNER JOIN ComponentMaster CM WITH(NOLOCK) ON CM.PK_ComponentId=STP.Fk_ComponentID  
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK)   
  ON AD.Associate_ID=STP.AssociateID   
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details UD WITH(NOLOCK)   
  ON UD.Associate_ID=STP.CreatedBy   
  LEFT OUTER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Current_ProjectManager CPM WITH(NOLOCK)   
  ON CPM.PROJECT_ID=STP.ProjectID  
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details PD WITH(NOLOCK)   
  ON PD.Associate_ID=CPM.PROJECT_MANAGER  
  INNER JOIN #VNMCOMPONENTSP CMTS WITH(NOLOCK) ON  CMTS.ComponentID=STP.Fk_ComponentID   
  AND CMTS.ProjectID=STP.ProjectID  
  LEFT JOIN PR.Trutime_Recalled_NSA RNSA ON RNSA.AssociateID = STP.AssociateID AND RNSA.Date = STP.NSADate  
        AND RNSA.Fk_ComponentID = STP.Fk_ComponentID AND RNSA.ProjectID = STP.ProjectID AND RNSA.RowStatus = 1  
  WHERE STP.Status IN (1,5,4) AND STP.RowStatus=1 AND DATEPART(MM,STP.CreatedDate)=@Month   
  AND DATEPART(YY,STP.CreatedDate)=@Year  
  and CM.Pk_ComponentID=@Componentid  
            
  --Drop the temp table  
  DROP TABLE  #VNMCOMPONENTSP   
   END  
 ELSE  
 BEGIN  
  --Selcting the Associate data  
  SELECT STP.PK_VNMShiftAllowanceID AS UniqueID, STP.AssociateID,  
  ISNULL(LTRIM(RTRIM(AD.Associate_FirstName)),'')+' '+  
  ISNULL(LTRIM(RTRIM(AD.Associate_LastName)),'') AS AssociateName ,  
  STP.ProjectID,CM.ComponentShortName AS AllowanceType,STM.ShiftTypeName AS ShiftType,  
  CONVERT(VARCHAR,STP.STARTDATE,101) AS StartDate,  
  STP.StartTime, CONVERT(VARCHAR,STP.EndDate,101) AS Enddate,STP.EndTime,  
  ISNULL(STP.HCMSchedule,'') AS HCMShift,  
  CONVERT(VARCHAR(5),DATEDIFF(S, STP.StartDateTime, STP.EndDateTime)/3600)+':'+CONVERT(VARCHAR(5),  
  DATEDIFF(S, STP.StartDateTime, STP.EndDateTime)%3600/60) AS TotalHours,  
  STP.Amount AS EligibleAmount,STP.VNM_Amount ,STP.TransportEligibility as TransportEligibility ,   
  STP.CreatedBy AS UploaderID,  
  ISNULL(LTRIM(RTRIM(UD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(UD.Associate_LastName)),'') AS UploaderName,  
  Case when isnull(STP.Modifieddate,'')<>'' then STP.Modifieddate else STP.Createddate  end UploadedDate,  
  CPM.PROJECT_MANAGER AS PMID,  
  ISNULL(LTRIM(RTRIM(PD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(PD.Associate_LastName)),'') AS PMName,   
  (CASE WHEN STP.Status=1 THEN 'Valid'   
  WHEN STP.Status=5 THEN 'Processed'    
  WHEN STP.Status=20 THEN 'Resubmitted after Project Manager Rejection'  
  WHEN STP.Status=10 THEN 'Resubmitted after PFSS Rejection'   
  WHEN STP.Status=4 THEN 'ReSubmitted'   
  WHEN STP.Status=21 THEN 'Approved by Home Manager'  
  WHEN STP.Status=15 THEN 'Approved by Project Manager'   
  WHEN STP.Status=34 THEN 'Pending for D+ Approval'  
  WHEN STP.Status=35 THEN 'Approved by D+' END) AS Status,  
  STP.NSADate As ShiftStartDate  
  , RNSA.RecalledComments, RNSA.ModifiedStartDateTime, RNSA.ModifiedEndDateTime  
  FROM PR.VNMShiftAllowance STP WITH(NOLOCK)   
  INNER JOIN ShiftTypeMaster STM WITH(NOLOCK) ON STM.PK_ShiftTypeID=STP.FK_ShiftTypeID  
  INNER JOIN ComponentMaster CM WITH(NOLOCK) ON CM.PK_ComponentId=STP.Fk_ComponentID  
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK)   
  ON AD.Associate_ID=STP.AssociateID   
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details UD WITH(NOLOCK)   
  ON UD.Associate_ID=STP.CreatedBy   
  LEFT OUTER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Current_ProjectManager CPM WITH(NOLOCK)   
  ON CPM.PROJECT_ID=STP.ProjectID  
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details PD WITH(NOLOCK)  
  ON PD.Associate_ID=CPM.PROJECT_MANAGER  
  LEFT JOIN PR.Trutime_Recalled_NSA RNSA ON RNSA.AssociateID = STP.AssociateID AND RNSA.Date = STP.NSADate  
        AND RNSA.Fk_ComponentID = STP.Fk_ComponentID AND RNSA.ProjectID = STP.ProjectID AND RNSA.RowStatus = 1  
  WHERE STP.Status IN (1,4,5,15,34,35) AND STP.RowStatus=1 AND ((DATEPART(MM,STP.CreatedDate)=@Month   
  AND DATEPART(YY,STP.CreatedDate)=@Year) OR  
  (DATEPART(MM,STP.ModifiedDate)=@Month  AND DATEPART(YY,STP.ModifiedDate)=@Year))  
  and CM.PK_Componentid=@componentid  
    
   END  
    
  END   
  
   --TRT Special Inputs  
  IF(@ComponentGrpID=5)   
 BEGIN   
 INSERT INTO #RoleTable(Fk_RoleID )  
    SELECT CRM.FK_RoleID from Userrolemapping URM with (nolock)  
    INNER join ComponentRoleMapping CRM with (nolock) ON URM.FK_ComponentRoleID=CRM.PK_ComponentRoleID and   
 URM.RowStatus=1  
    INNER JOIN COMPONENTCOUNTRYMAPPING CCM WITH(NOLOCK) ON   
 CCM.PK_COMPONENTCOUNTRYMAPPINGID=CRM.FK_COMPONENTCOUNTRYMAPPINGID  
    INNER JOIN COMPONENTMASTER CM WITH(NOLOCK) ON CM.PK_COMPONENTID=CCM.FK_COMPONENTID  
    INNER JOIN ComponentGroupMaster  DCM WITH(NOLOCK) ON CM.PK_COMPONENTID=CCM.FK_COMPONENTID and   
 DCM.PK_ComponentGroupID = @ComponentGrpID  
    WHERE associateid=@LOGINID and CRM.RowStatus=1  and CM.RowStatus=1   
    AND CCM.Rowstatus=1 and CCM.FK_ComponentCountryID=1  
  
select @RolePriority=0 from #RoleTable where Fk_RoleID not in (8,3,2) and Fk_Roleid in (7,9) and Fk_RoleID = @RoleID
select @RolePriority =1 from #RoleTable where Fk_RoleID in (8,3,2) and Fk_RoleID = @RoleID  
  
 ---To get all component data at a time for TRT  
 IF OBJECT_ID('tempdb..#ComponentTable') IS NOT NULL  
        BEGIN  
            DROP TABLE #ComponentTable  
        END  
 Create table #ComponentTable(Fk_ComponentID int)  
 Insert into #ComponentTable(Fk_ComponentID)  
 SELECT value    
 FROM STRING_SPLIT(@Componentgrp, ',')    
 WHERE RTRIM(value) <> '';  
  --Drops the table  
 DROP TABLE #RoleTable  
 if(@RolePriority=1)  
 BEGIN  
  SELECT TRT.PK_TRTSpecialInputsID AS UniqueID,CM.ComponentName,TRT.AssociateID,ISNULL(LTRIM(RTRIM(  
  AD.Associate_FirstName)),'')  
  +' '+ISNULL(LTRIM(RTRIM(AD.Associate_LastName)),'') AS AssociateName,ProjectID,CUM.CurrencyCode,PCUD.CurrencyValue,  
  TRT.Amount,convert(BIGINT,currencyvalue*AMOUNT)ConvertedAmount,  
  LTRIM(RTRIM(REPLACE(TRT.InvoiceNumber, CHAR(10),' ')))   
  InvoiceNumber,TRT.RewardName, COALESCE( ApproverID , '' )  ApproverID,ISNULL(LTRIM(RTRIM(  
  CD.Associate_FirstName)),'')+' '+  
  ISNULL(LTRIM(RTRIM(CD.Associate_LastName)),'') AS ApproverName,  
  CASE WHEN ISNULL(TRT.OtherMailUploadID,'0') <> '0' THEN 'Yes' ELSE 'No'   
  END ApprovalMail,  
  isnull(TRT.Vertical,'') Vertical,Case When TRT.Funded='1' then 'Project' when TRT.Funded='2'   
  then 'Client' else '' end Funded,  TRT.UploaderID,   
  ISNULL(LTRIM(RTRIM(UD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(UD.Associate_LastName)),'') AS UploaderName,  
  Case when isnull(TRT.Modifieddate,'')<>'' then TRT.Modifieddate else TRT.Createddate end UploadedDate,  
  isnull(MC.Cdescription,'') SpecialCaseReason,  
  isnull(TRT.InputRemarks,'') InputRemarks, isnull(MC_A.Cdescription,'') AS Status   
  FROM PR.TRTSPECIALINPUTS TRT WITH(NOLOCK)  
  INNER JOIN dbo.ComponentMaster CM WITH(NOLOCK) ON TRT.FK_ComponentID = CM.Pk_ComponentID and CM.Rowstatus = 1  
  Left JOIN #ComponentTable CT WITH(NOLOCK) ON CT.Fk_ComponentID=TRT.Fk_ComponentID  
  INNER JOIN CurrencyMaster Cum WITH (NOLOCK) ON TRT.FK_CurrencyID=Cum.PK_CurrencyID and CUM.Rowstatus=1  
  INNER JOIN PR.CurrencyUpdatedata PCUD WITH (NOLOCK) on TRT.Fk_CurrencyID=PCUD.Fk_CurrencyID and PCUD.Rowstatus=1  
  INNER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK)   
  ON AD.Associate_ID=CONVERT(VARCHAR,TRT.AssociateID)  
  LEFT OUTER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details CD WITH(NOLOCK)   
  ON CD.Associate_ID=isnull(TRT.ApproverID,'')  
  LEFT OUTER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details UD WITH(NOLOCK)   
  ON UD.Associate_ID=TRT.UploaderID    
  LEFT OUTER JOIN mastercodes MC on MC.CParentref=2 and MC.CUserdefined1='5' and MC.Rowstatus=1 and  
  MC.CCodeid=TRT.SpecialCaseReason  
  LEFT Outer Join MasterCodes MC_A on MC_A.CParentRef=3 and TRT.Status=MC_A.CCodeId and MC_A.RowStatus=1 and   
  MC_A.Cuserdefined1='PR'  
  WHERE TRT.Status IN (1,5,10,11) AND TRT.RowStatus=1 AND  ((DATEPART(MM,TRT.CreatedDate)=@month AND  
  DATEPART(YY,TRT.CreatedDate)=@year) OR   
  (DATEPART(MM,TRT.ModifiedDate)=@Month  AND DATEPART(YY,TRT.ModifiedDate)=@Year))  
  --and Fk_Componentid=@COMPONENTID    
  and PCUD.FK_ComponentCountryID=@CountryId option (recompile)  
 END  
 ELSE  
 BEGIN  
 IF(@RoleID=9)  
 BEGIN  
   SELECT CM.ComponentName,TRT.AssociateID,  
  ISNULL(LTRIM(RTRIM(AD.Associate_FirstName)),'')+' '+  
  ISNULL(LTRIM(RTRIM(AD.Associate_LastName)),'') AS AssociateName,  
  ProjectID,CUM.CurrencyCode,PCUD.CurrencyValue,  
  TRT.Amount,convert(BIGINT,currencyvalue*AMOUNT) ConvertedAmount,  
  LTRIM(RTRIM(REPLACE(TRT.InvoiceNumber,CHAR(10),' ')))  
  InvoiceNumber,  
  TRT.RewardName, COALESCE( ApproverID , '' )  ApproverID,ISNULL(LTRIM(RTRIM(CD.Associate_FirstName)),'')+' '+ISNULL(  
  LTRIM(RTRIM(CD.Associate_LastName)),'') AS ApproverName,  
  CASE WHEN ISNULL(TRT.OtherMailUploadID,'0') <> '0' THEN 'Yes'   
  ELSE 'No' END ApprovalMail,  
  isnull(TRT.Vertical,'') Vertical,Case When TRT.Funded='1' then 'Project' when TRT.Funded='2' then 'Client'   
  else '' end Funded,TRT.UploaderID,   
  ISNULL(LTRIM(RTRIM(UD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(UD.Associate_LastName)),'') AS UploaderName,  
  Case when isnull(TRT.Modifieddate,'')<>'' then TRT.Modifieddate else TRT.Createddate end UploadedDate,  
  isnull(MC.Cdescription,'') SpecialCaseReason,  
  isnull(TRT.InputRemarks,'') InputRemarks, isnull(MC_A.Cdescription,'') AS Status   
  FROM PR.TRTSPECIALINPUTS TRT WITH(NOLOCK)  
  INNER JOIN dbo.ComponentMaster CM WITH(NOLOCK) ON TRT.FK_ComponentID =  CM.Pk_ComponentID and CM.Rowstatus = 1  
  LEFT JOIN #ComponentTable CT WITH(NOLOCK) ON CT.Fk_ComponentID=TRT.Fk_ComponentID  
  INNER JOIN CurrencyMaster Cum WITH (NOLOCK) ON TRT.FK_CurrencyID=Cum.PK_CurrencyID and CUM.Rowstatus=1  
  INNER JOIN PR.CurrencyUpdatedata PCUD WITH (NOLOCK) on TRT.Fk_CurrencyID=PCUD.Fk_CurrencyID and PCUD.Rowstatus=1  
  LEFT OUTER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK)   
  ON CONVERT(VARCHAR,AD.Associate_ID)=CONVERT(VARCHAR,TRT.AssociateID)   
  LEFT OUTER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details CD WITH(NOLOCK)   
  ON CONVERT(VARCHAR,CD.Associate_ID)=isnull(TRT.ApproverID,'')  
  LEFT OUTER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details UD WITH(NOLOCK)   
  ON CONVERT(VARCHAR,UD.Associate_ID)=TRT.UploaderID    
  LEFT OUTER JOIN mastercodes MC on MC.CParentref=2 and MC.CUserdefined1='5' and MC.Rowstatus=1 and   
  MC.CCodeid=TRT.SpecialCaseReason  
  LEFT Outer Join MasterCodes MC_A on MC_A.CParentRef=3 and TRT.Status=MC_A.CCodeId and MC_A.RowStatus=1 and   
  MC_A.Cuserdefined1='PR'  
  WHERE TRT.Status IN (1,5,10,11) AND TRT.RowStatus=1 AND ((DATEPART(MM,TRT.CreatedDate)=@month AND   
  DATEPART(YY,TRT.CreatedDate)=@year) OR   
  (DATEPART(MM,TRT.ModifiedDate)=@Month  AND DATEPART(YY,TRT.ModifiedDate)=@Year))  
  and TRT.CreatedBy=@LOGINID and PCUD.FK_ComponentCountryID=@CountryId option (recompile)  
 END  
 ELSE  
 BEGIN  
  
  --Selecting Component data  
  SELECT CM.ComponentName,TRT.AssociateID,  
  ISNULL(LTRIM(RTRIM(AD.Associate_FirstName)),'')+' '+  
  ISNULL(LTRIM(RTRIM(AD.Associate_LastName)),'') AS AssociateName,  
  ProjectID,CUM.CurrencyCode,PCUD.CurrencyValue,  
  TRT.Amount,convert(BIGINT,currencyvalue*AMOUNT) ConvertedAmount,  
  LTRIM(RTRIM(REPLACE(TRT.InvoiceNumber,CHAR(10),' ')))  
  InvoiceNumber,  
  TRT.RewardName, COALESCE( ApproverID , '' )  ApproverID,ISNULL(LTRIM(RTRIM(CD.Associate_FirstName)),'')+' '+ISNULL(  
  LTRIM(RTRIM(CD.Associate_LastName)),'') AS ApproverName,  
  CASE WHEN  ISNULL(TRT.OtherMailUploadID,'0') <> '0' THEN 'Yes'   
  ELSE 'No' END ApprovalMail,  
  isnull(TRT.Vertical,'') Vertical,Case When TRT.Funded='1' then 'Project' when TRT.Funded='2' then 'Client'   
  else '' end Funded,TRT.UploaderID,   
  ISNULL(LTRIM(RTRIM(UD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(UD.Associate_LastName)),'') AS UploaderName,  
  Case when isnull(TRT.Modifieddate,'')<>'' then TRT.Modifieddate else TRT.Createddate end UploadedDate,  
  isnull(MC.Cdescription,'') SpecialCaseReason,  
  isnull(TRT.InputRemarks,'') InputRemarks, isnull(MC_A.Cdescription,'') AS Status   
  FROM PR.TRTSPECIALINPUTS TRT WITH(NOLOCK)  
  INNER JOIN dbo.ComponentMaster CM WITH(NOLOCK) ON TRT.FK_ComponentID =  CM.Pk_ComponentID and CM.Rowstatus = 1  
  LEFT JOIN #ComponentTable CT WITH(NOLOCK) ON CT.Fk_ComponentID=TRT.Fk_ComponentID  
  INNER JOIN CurrencyMaster Cum WITH (NOLOCK) ON TRT.FK_CurrencyID=Cum.PK_CurrencyID and CUM.Rowstatus=1  
  INNER JOIN PR.CurrencyUpdatedata PCUD WITH (NOLOCK) on TRT.Fk_CurrencyID=PCUD.Fk_CurrencyID and PCUD.Rowstatus=1  
  LEFT OUTER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK)   
  ON CONVERT(VARCHAR,AD.Associate_ID)=CONVERT(VARCHAR,TRT.AssociateID)   
  LEFT OUTER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details CD WITH(NOLOCK)   
  ON CONVERT(VARCHAR,CD.Associate_ID)=isnull(TRT.ApproverID,'')  
  LEFT OUTER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details UD WITH(NOLOCK)   
  ON CONVERT(VARCHAR,UD.Associate_ID)=TRT.UploaderID    
  LEFT OUTER JOIN mastercodes MC on MC.CParentref=2 and MC.CUserdefined1='5' and MC.Rowstatus=1 and   
  MC.CCodeid=TRT.SpecialCaseReason  
  LEFT Outer Join MasterCodes MC_A on MC_A.CParentRef=3 and TRT.Status=MC_A.CCodeId and MC_A.RowStatus=1 and   
  MC_A.Cuserdefined1='PR'  
  WHERE TRT.Status IN (1,5,10,11) AND TRT.RowStatus=1 AND ((DATEPART(MM,TRT.CreatedDate)=@month AND   
  DATEPART(YY,TRT.CreatedDate)=@year) OR   
  (DATEPART(MM,TRT.ModifiedDate)=@Month  AND DATEPART(YY,TRT.ModifiedDate)=@Year))  
  and PCUD.FK_ComponentCountryID=@CountryId AND trt.CreatedBy = @LOGINID option (recompile)  
 END  
 END  
 DROP TABLE #ComponentTable  
  END  
    
  --Cognizant business Allowance-payout  
 IF (@COMPONENTID=7)   
 BEGIN  
  SELECT PCBA.PK_CognizantBusinessAllowanceID AS UniqueID,PCBA.AssociateID,  
  ISNULL(LTRIM(RTRIM(AD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(AD.Associate_LastName)),'') AS AssociateName,  
  Level,isnull(BUProposedCBAAmount,'') BUProposedCBAAmount,isnull(PreviousCBAAmountProposed,'')   
  PreviousCBAAmountProposed,  
  isnull(Amount,'') FinalCBAAmount,  
  isnull(MC.CDescription,'') SpecialCaseReason,isnull(PCBA.CreatedBy, '' )  TalentManagerID,  
  Case when isnull(PCBA.Modifieddate,'')<>'' then PCBA.Modifieddate else PCBA.Createddate end UploadedDate,  
  isnull(PCBA.InputRemarks,'') InputRemarks,   
  isnull(MC_A.Cdescription,'') AS Status   
  FROM PR.CognizantBusinessAllowance PCBA WITH (NOLOCK)  
 LEFT OUTER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK)   
 ON CONVERT(VARCHAR,AD.Associate_ID)=CONVERT(VARCHAR,PCBA.AssociateID)  
  LEFT OUTER JOIN mastercodes MC on MC.CParentref=2 and MC.CUserdefined1='6' and MC.Rowstatus=1 and   
  MC.CCodeid=PCBA.SpecialCaseReason  
  LEFT Outer Join MasterCodes MC_A on MC_A.CParentRef=3 and PCBA.Status=MC_A.CCodeId and MC_A.RowStatus=1 and   
  MC_A.Cuserdefined1='PR'  
  WHERE PCBA.Status IN (1,5) AND PCBA.RowStatus=1 AND (month(PCBA.ModifiedDate)=@month)   
  AND year(PCBA.CreatedDate)=@year   
 END   
   
  --BPS 6th Day Allowance  
IF(@ComponentGrpID=7 and @COMPONENTID=0)  
BEGIN  
  
--Project Manager  
IF(@RoleID=6)  
BEGIN  
  
INSERT INTO @Project(ProjectID)  
Select P.Project_ID FROM CentralRepository.DBO.VW_Centralrepository_Project P WITH (NOLOCK)   
INNER JOIN Approval_MonthlyYearlyApprovals AMA WITH (NOLOCK) ON P.Project_ID=AMA.ProjectID  
INNER JOIN Centralrepository.dbo.vw_centralrepository_Current_ProjectManager PM WITH (NOLOCK)   
ON AMA.ProjectID=PM.Project_ID and Project_Manager=@LOGINID       
WHERE AMA.VerificationStatus=2 AND AMA.Rowstatus=1  and AMA.Fk_ComponentId=36   
and Project_Manager=@loginid             
   
--Selcting the Associate data  
SELECT PCBA.ShiftType,PCBA.AssociateID,  
ISNULL(LTRIM(RTRIM(AD.Associate_FirstName)),'')+' '+  
ISNULL(LTRIM(RTRIM(AD.Associate_LastName)),'') AS AssociateName,  
convert(varchar,StartDate,101) StartDate,Convert(varchar,EndDate,101) EndDate,  
Convert(varchar(5),StartTime) StartTime,Convert(Varchar(5),EndTime) EndTime,PCBA.ProjectID,Amount,  
isnull(TransportEligibility,'') TransportEligibility,BillingDetails,Grade,SetID,  
isnull(PCBA.CreatedBy, '' )  CreatedBy,  
Case when isnull(PCBA.Modifieddate,'')<>'' then Convert(varchar,PCBA.Modifieddate,107)  
else Convert(varchar,PCBA.Createddate,107) end UploadedDate,  
isnull(MC_A.Cdescription,'') Status   
FROM PR.BPSSDA PCBA WITH (NOLOCK)  
INNER JOIN @Project C   
ON PCBA.ProjectID=C.ProjectID  
LEFT OUTER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK)   
ON CONVERT(VARCHAR,AD.Associate_ID)=CONVERT(VARCHAR,PCBA.AssociateID)  
LEFT OUTER JOIN MasterCodes MC_A on MC_A.CParentRef=3 and PCBA.Status=MC_A.CCodeId   
and MC_A.RowStatus=1 and MC_A.Cuserdefined1='PR'  
WHERE (PCBA.Status IN (1,5,15,16,34,35) AND PCBA.RowStatus=1)   
 AND (((month(PCBA.CreatedDate)=@month) AND year(PCBA.CreatedDate)=@year)    
 OR ((month(PCBA.CreatedDate)=@month) AND year(PCBA.CreatedDate)=@year))  
       
END  
 --BPS Approver  
ELSE IF(@RoleID=10)  
BEGIN  
 insert into @CustomerBPS(CustomerID)  
 Select Customer_ID from CentralRepository.dbo.vw_centralrepository_Project CRP WITH (NOLOCK)  
 INNER JOIN UserRoleMapping URM With (nolock)   
 on Convert(varchar,CRP.Customer_ID)=URM.CustomerID  
 INNER JOIN ComponentRoleMapping CRM with (NOLOCK)   
 ON URM.FK_ComponentRoleID=CRM.PK_ComponentRoleID  
 INNER JOIN ComponentCountryMapping CCM WITH (NOLOCK)  
 ON CCM.PK_ComponentCountryMappingID=CRM.FK_ComponentCountryMappingID  
 INNER JOIN ComponentMaster CM WITH (NOLOCK) ON CM.PK_COmponentID=CCM.FK_ComponentID  
 WHERE URM.RowStatus=1 and URM.AssociateID=@Loginid and CRM.RowStatus=1   
 and CM.FK_ComponentGroupID=@ComponentGrpID and CRM.FK_RoleID=10  
 and CCM.FK_ComponentCountryID=1 and CCM.RowStatus=1 and CM.RowStatus=1  
 GROUP BY Customer_ID   
   
 --Inserting Project data  
 INSERT INTO @Project(CustomerID,ProjectID)  
 Select P.Customer_ID,P.Project_ID from Approval_MonthlyYearlyApprovals AMY with (nolock)      
 INNER JOIN Centralrepository.dbo.vw_centralrepository_project P with (nolock) ON AMY.ProjectID=P.Project_ID   
 INNER JOIN @CustomerBPS C ON P.Customer_ID=C.CustomerID  
 WHERE AMY.Rowstatus=1 and AMY.Fk_ComponentID=36 and AMY.VerificationStatus=2  
     
 --Selcting the Associate data  
 SELECT PCBA.ShiftType,PCBA.AssociateID,ISNULL(LTRIM(RTRIM(AD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(  
 RTRIM(AD.Associate_LastName)),'') AS AssociateName,  
 convert(varchar,StartDate,101) StartDate,  
 Convert(varchar,EndDate,101) EndDate,Convert(varchar(5),StartTime) StartTime,  
 Convert(Varchar(5),EndTime) EndTime,PCBA.ProjectID,Amount,isnull(TransportEligibility,'') TransportEligibility,  
 BillingDetails,Grade,SetID,  
 isnull(PCBA.CreatedBy, '' )  CreatedBy,Case when isnull(PCBA.Modifieddate,'')<>''   
 then convert(datetime,PCBA.Modifieddate)   
 else convert(datetime,PCBA.Createddate) end UploadedDate,  
 isnull(MC_A.Cdescription,'') Status    
 FROM PR.BPSSDA PCBA WITH (NOLOCK)  
 INNER JOIN @Project C ON PCBA.ProjectID=C.ProjectID  
 LEFT OUTER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK) ON CONVERT(  
 VARCHAR,AD.Associate_ID)=CONVERT(VARCHAR,PCBA.AssociateID)  
 LEFT OUTER JOIN MasterCodes MC_A on MC_A.CParentRef=3 and PCBA.Status=MC_A.CCodeId and MC_A.RowStatus=1 and   
 MC_A.Cuserdefined1='PR'  
 WHERE PCBA.Status IN (1,5,15,16,34,35) and PCBA.Rowstatus=1   
 AND (month(PCBA.CreatedDate)=@month) AND year(PCBA.CreatedDate)=@year   
END  
  
 --BPS Uploader  
ELSE IF(@RoleID=11)  
BEGIN  
 insert into @Project(ProjectID)  
 Select URM.ProjectID from Approval_MonthlyYearlyApprovals MYA WITH (NOLOCK)          
 INNER JOIN UserRoleMapping URM WITH (NOLOCK) ON URM.ProjectID=MYA.ProjectID and MYA.Fk_ComponentID=36
 INNER JOIN ComponentRoleMapping CRM WITH (NOLOCK) ON   
 URM.Fk_ComponentRoleID=CRM.PK_ComponentRoleID and CRM.FK_RoleID=11  
 INNER JOIN ComponentCOuntryMapping CCM WITH (NOLOCK)   
 ON CCM.PK_ComponentCountryMappingID=CRM.FK_ComponentCountryMappingID  
 INNER JOIN ComponentMaster CM WITH (NOLOCK) ON CM.PK_COmponentID=CCM.FK_ComponentID  
 WHERE  URM.AssociateID=@LoginID and URM.RowStatus=1 and CRM.RowStatus=1  and   
 CCM.FK_ComponentCountryID=1 and MYA.Rowstatus=1 and CM.FK_ComponentGroupID=7
 and CM.RowStatus=1 and CCM.Rowstatus=1  
  
 ----Inseriting Project data  
 --INSERT INTO @Project(CustomerID,ProjectID)  
 --Select P.Customer_ID,P.Project_ID from Approval_MonthlyYearlyApprovals AMY with (nolock)      
 --INNER JOIN Centralrepository.dbo.vw_centralrepository_project P with (nolock) ON AMY.ProjectID=P.Project_ID   
 --INNER JOIN @CustomerBPS C ON P.Customer_ID=C.CustomerID  
 --WHERE AMY.Rowstatus=1 and AMY.Fk_ComponentID=36 and AMY.VerificationStatus=2  
  
 --Selcting the Associate data  
 SELECT PCBA.ShiftType,PCBA.AssociateID,ISNULL(LTRIM(RTRIM(AD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(  
 RTRIM(AD.Associate_LastName)),'') AS AssociateName,  
 convert(varchar,StartDate,101) StartDate,Convert(varchar,EndDate,101) EndDate,Convert(varchar(5),StartTime)   
 StartTime,  
 Convert(Varchar(5),EndTime) EndTime,C.ProjectID,Amount,isnull(TransportEligibility,'') TransportEligibility,  
 BillingDetails,Grade,SetID,  
 isnull(PCBA.CreatedBy, '' )  CreatedBy,  
 Case when isnull(PCBA.Modifieddate,'')<>'' then Convert(varchar,PCBA.ModifiedDate,107)   
 else Convert(varchar,PCBA.Createddate,107) end UploadedDate,isnull(MC_A.Cdescription,'')  Status   
 FROM PR.BPSSDA PCBA WITH (NOLOCK)  
 INNER JOIN @Project C ON PCBA.ProjectID=C.ProjectID  
 LEFT OUTER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK)   
 ON CONVERT(VARCHAR,AD.Associate_ID)=CONVERT(VARCHAR,PCBA.AssociateID)  
 LEFT OUTER JOIN MasterCodes MC_A on MC_A.CParentRef=3 and PCBA.Status=MC_A.CCodeId   
 and MC_A.RowStatus=1 and MC_A.Cuserdefined1='PR'  
 WHERE (PCBA.Status IN (1,5,15,16,34,35) AND PCBA.RowStatus=1) AND (month(PCBA.CreatedDate)=@month)   
 AND year(PCBA.CreatedDate)=@year --and PCBA.CreatedBy=@LOGINID  
 END  
ELSE IF(@RoleID in (3,2))  
 BEGIN  
  SELECT PCBA.Pk_BPSSDAID As UniqueID,PCBA.ShiftType,PCBA.AssociateID,  
  ISNULL(LTRIM(RTRIM(AD.Associate_FirstName)),'')+' '+  
  ISNULL(LTRIM(RTRIM(AD.Associate_LastName)),'') AS AssociateName,  
  convert(varchar,StartDate,101) StartDate,Convert(varchar,EndDate,101) EndDate,  
  Convert(varchar(5),StartTime) StartTime,Convert(Varchar(5),EndTime) EndTime,PCBA.ProjectID,  
  ISNULL(SDA_OCA_Amount,0) AS SDA_OCA_Amount1,  
  ISNULL(SDA_OCA_Amount2,0) AS SDA_OCA_Amount2,  
  Amount as TotalAmount,  
  isnull(TransportEligibility,'') TransportEligibility,BillingDetails,Grade,SetID,  
  isnull(PCBA.CreatedBy, '' )  CreatedBy,  
  Case when isnull(PCBA.Modifieddate,'')<>'' then convert(varchar,PCBA.Modifieddate,107)  
  else Convert(varchar,PCBA.Createddate,107) end UploadedDate,isnull(MC_A.Cdescription,'')  Status   
  FROM PR.BPSSDA PCBA WITH (NOLOCK)  
  LEFT OUTER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK)   
  ON CONVERT(VARCHAR,AD.Associate_ID)=CONVERT(VARCHAR,PCBA.AssociateID)  
  LEFT OUTER JOIN MasterCodes MC_A on MC_A.CParentRef=3 and PCBA.Status=MC_A.CCodeId   
  and MC_A.RowStatus=1 and MC_A.Cuserdefined1='PR'  
  WHERE PCBA.Status IN (1,5,15,16,34,35) AND PCBA.RowStatus=1 AND (((month(PCBA.CreatedDate)=@month)   
  AND year(PCBA.CreatedDate)=@year)  OR  
  ((month(PCBA.CreatedDate)=@month) AND year(PCBA.CreatedDate)=@year))  
 END  
  
ELSE  
 BEGIN  
    
  --Selecting the data  
  SELECT PCBA.Pk_BPSSDAID As UniqueID,PCBA.ShiftType,PCBA.AssociateID,  
  ISNULL(LTRIM(RTRIM(AD.Associate_FirstName)),'')+' '+  
  ISNULL(LTRIM(RTRIM(AD.Associate_LastName)),'') AS AssociateName,  
  convert(varchar,StartDate,101) StartDate,Convert(varchar,EndDate,101) EndDate,  
  Convert(varchar(5),StartTime) StartTime,Convert(Varchar(5),EndTime) EndTime,PCBA.ProjectID,Amount,  
  isnull(TransportEligibility,'') TransportEligibility,BillingDetails,Grade,SetID,  
  isnull(PCBA.CreatedBy, '' )  CreatedBy,  
  Case when isnull(PCBA.Modifieddate,'')<>'' then convert(varchar,PCBA.Modifieddate,107)  
  else Convert(varchar,PCBA.Createddate,107) end UploadedDate,isnull(MC_A.Cdescription,'')  Status   
  FROM PR.BPSSDA PCBA WITH (NOLOCK)  
  LEFT OUTER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK)   
  ON CONVERT(VARCHAR,AD.Associate_ID)=CONVERT(VARCHAR,PCBA.AssociateID)  
  LEFT OUTER JOIN MasterCodes MC_A on MC_A.CParentRef=3 and PCBA.Status=MC_A.CCodeId   
  and MC_A.RowStatus=1 and MC_A.Cuserdefined1='PR'  
  WHERE PCBA.Status IN (1,5,15,16,34,35) AND PCBA.RowStatus=1 AND (((month(PCBA.CreatedDate)=@month)   
  AND year(PCBA.CreatedDate)=@year)  OR  
  ((month(PCBA.CreatedDate)=@month) AND year(PCBA.CreatedDate)=@year))  
 END  
END  
  
--BPS Night Shift Allowance  
 IF(@ComponentGrpID=10 and @COMPONENTID=0)     
BEGIN  
     
   --Project Manager  
 IF(@RoleID =6)  
 BEGIN  
 INSERT INTO @Project(ProjectID)  
 Select P.Project_ID FROM CentralRepository.DBO.VW_Centralrepository_Project P WITH (NOLOCK)   
 INNER JOIN Approval_MonthlyYearlyApprovals AMA WITH (NOLOCK) ON P.Project_ID=AMA.ProjectID  
 INNER JOIN Centralrepository.dbo.vw_centralrepository_Current_ProjectManager PM WITH (NOLOCK)   
 ON AMA.ProjectID=PM.Project_ID and Project_Manager=@loginid  
 WHERE AMA.VerificationStatus=2 AND AMA.Rowstatus=1  and AMA.Fk_ComponentId in(39)   
 and Project_Manager=@loginid  
  
  
 --Selcting the Associate data  
 SELECT PCBA.ShiftType,PCBA.AssociateID,ISNULL(LTRIM(RTRIM(AD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(  
 RTRIM(AD.Associate_LastName)),'') AS AssociateName,  
 convert(varchar,StartDate,101) StartDate,Convert(varchar,EndDate,101) EndDate  
 ,PCBA.ProjectID,Amount,Grade,SetID,  
 isnull(PCBA.CreatedBy, '' )  CreatedBy,Case when isnull(PCBA.Modifieddate,'')<>'' then convert(varchar,  
 PCBA.Modifieddate,107) else Convert(varchar,PCBA.Createddate,107) end UploadedDate,isnull(MC_A.Cdescription,'')  
 Status , PCBA.MonthAmount,PCBA.MonthlyWorkedDays, PCBA.NSADate as  ShiftStartDate  
 FROM PR.BPSNSA PCBA WITH (NOLOCK)  
 INNER JOIN @Project C ON PCBA.ProjectID=C.ProjectID  
 INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK)   
 ON CONVERT(VARCHAR,AD.Associate_ID)=CONVERT(VARCHAR,PCBA.AssociateID)  
 INNER JOIN MasterCodes MC_A on MC_A.CParentRef=3 and PCBA.Status=MC_A.CCodeId   
 and MC_A.RowStatus=1 and MC_A.Cuserdefined1='PR'  
 WHERE (PCBA.Status IN (1,5,15,16,34,35) AND PCBA.RowStatus=1) AND (month(PCBA.CreatedDate)=@month)   
 AND year(PCBA.CreatedDate)=@year   
  END  
  
  --BPS Approver  
  ELSE IF(@RoleID=10)  
  BEGIN  
  
  --Select the customer ID  
  Select @CustomerID=Customer_ID FROM   
  CentralRepository.DBO.VW_Centralrepository_Project P WITH (NOLOCK)   
  INNER JOIN UserRoleMapping URM WITH (NOLOCK) ON P.Customer_ID=URM.CustomerID and URM.AssociateID=@LoginID  
  INNER JOIN ComponentRoleMapping CRM WITH (NOLOCK)   
  on URM.Fk_ComponentRoleID=CRM.PK_ComponentRoleID and CRM.FK_RoleID=10  
  INNER JOIN ComponentCOuntryMapping CCM WITH (NOLOCK)  
  ON CCM.PK_ComponentCountryMappingID=CRM.FK_ComponentCountryMappingID  
  INNER JOIN ComponentMaster CM WITH (NOLOCK)   
  ON CM.PK_COmponentID=CCM.FK_ComponentID  
  WHERE  URM.AssociateID=@LoginID and URM.RowStatus=1 and CRM.RowStatus=1   
  and CM.FK_ComponentGroupID=10 and CCM.FK_ComponentCountryID=1  
  and CM.RowStatus=1 and CCM.Rowstatus=1  
    
  --Inserting customer data  
  INSERT INTO @Customer(CustomerID,ProjectID)  
  Select P.Customer_ID,P.Project_ID FROM CentralRepository.DBO.VW_Centralrepository_Project P WITH (NOLOCK)   
  INNER JOIN Approval_MonthlyYearlyApprovals AMA WITH (NOLOCK) ON CONVERT(VARCHAR,P.Project_ID)=AMA.ProjectID  
  WHERE AMA.VerificationStatus=2 AND P.Customer_ID=@CustomerID AND AMA.Rowstatus=1   and AMA.Fk_ComponentId in(39)  
    
  
  --Selcting the Associate data  
  SELECT PCBA.ShiftType,PCBA.AssociateID,  
  ISNULL(LTRIM(RTRIM(AD.Associate_FirstName)),'')+' '+  
  ISNULL(LTRIM(RTRIM(AD.Associate_LastName)),'') AS AssociateName,  
  convert(varchar,StartDate,101) StartDate,Convert(varchar,EndDate,101) EndDate,  
  C.ProjectID,Amount,Grade,SetID,  
  isnull(PCBA.CreatedBy, '' )  CreatedBy,  
  Case when isnull(PCBA.Modifieddate,'')<>'' then convert(varchar,PCBA.Modifieddate,107)   
  else Convert(varchar,PCBA.Createddate,107) end UploadedDate,isnull(MC_A.Cdescription,'')  Status ,  
  PCBA.MonthAmount,PCBA.MonthlyWorkedDays,PCBA.NSADate as  ShiftStartDate  
  FROM PR.BPSNSA PCBA WITH (NOLOCK)  
  INNER JOIN @Customer C ON PCBA.ProjectID=C.ProjectID  
  INNER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK)   
  ON CONVERT(VARCHAR,AD.Associate_ID)=CONVERT(VARCHAR,PCBA.AssociateID)   
  INNER JOIN MasterCodes MC_A on MC_A.CParentRef=3 and PCBA.Status=MC_A.CCodeId   
  and MC_A.RowStatus=1 and MC_A.Cuserdefined1='PR'  
  WHERE (PCBA.Status IN (1,5,15,16,34,35) AND PCBA.RowStatus=1)   
  AND (month(PCBA.CreatedDate)=@month) AND year(PCBA.CreatedDate)=@year   
  
  END  
  --Report Viewer  
  ELSE IF(@RoleID=5)  
   BEGIN   
  SELECT PCBA.PK_BPSNSAId As UniqueID, PCBA.ShiftType,PCBA.AssociateID,  
  ISNULL(LTRIM(RTRIM(AD.Associate_FirstName)),'')+' '+  
  ISNULL(LTRIM(RTRIM(AD.Associate_LastName)),'') AS AssociateName,  
  NSADate,PCBA.ProjectID,PCBA.Amount RoundAmount, ROUND(PCBA.RoughAmount,2) Amount,  
  PB.TotalEligibleHours TotalMinutes ,Grade,SetID,  
  isnull(PCBA.CreatedBy, '' )  CreatedBy,Case when isnull(PCBA.Modifieddate,'')<>''  
  then convert(varchar,PCBA.Modifieddate,107)   
  else Convert(varchar,PCBA.Createddate,107) end UploadedDate,   
  isnull(MC_A.Cdescription,'')  Status, PCBA.MonthAmount,PCBA.MonthlyWorkedDays,  
  RNSA.RecalledComments, RNSA.ModifiedStartDateTime, RNSA.ModifiedEndDateTime,PCBA.NSADate as  ShiftStartDate  
  FROM PR.BPSNSA PCBA WITH (NOLOCK) INNER JOIN PR.BPS_NSA PB WITH(NOLOCK)   
  ON PCBA.AssociateID = PB.AssociateID AND PCBA.NSADate = PB.Date   
  AND PCBA.ProjectId = PB.ProjectID AND PB.Rowstatus =1  
  INNER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK)   
  ON CONVERT(VARCHAR,AD.Associate_ID)=CONVERT(VARCHAR,PCBA.AssociateID)   
  INNER JOIN MasterCodes MC_A on MC_A.CParentRef=3 and PCBA.Status=MC_A.CCodeId   
  and MC_A.RowStatus=1 and MC_A.Cuserdefined1='PR'  
  LEFT JOIN PR.Trutime_Recalled_NSA RNSA ON RNSA.AssociateID = PCBA.AssociateID AND RNSA.Date = PCBA.NSADate  
        AND RNSA.Fk_ComponentID in(39) AND RNSA.ProjectID = PCBA.ProjectID AND RNSA.RowStatus = 1  
  WHERE (PCBA.Status IN (1,5,15,16,14,34,35) AND PCBA.RowStatus=1)  AND (((month(PCBA.CreatedDate)=@month)   
  AND year(PCBA.CreatedDate)=@year)  OR  
  ((month(PCBA.CreatedDate)=@month) AND year(PCBA.CreatedDate)=@year))  
   END  
  --BPS Uploader  
  ELSE IF(@RoleID=11)  
  BEGIN  
  insert into @Project(ProjectID)  
   Select URM.ProjectID from Approval_MonthlyYearlyApprovals MYA WITH (NOLOCK)          
 INNER JOIN UserRoleMapping URM WITH (NOLOCK) ON URM.ProjectID=MYA.ProjectID and MYA.Fk_ComponentID=39
 INNER JOIN ComponentRoleMapping CRM WITH (NOLOCK) ON   
 URM.Fk_ComponentRoleID=CRM.PK_ComponentRoleID and CRM.FK_RoleID=11  
 INNER JOIN ComponentCOuntryMapping CCM WITH (NOLOCK)   
 ON CCM.PK_ComponentCountryMappingID=CRM.FK_ComponentCountryMappingID  
 INNER JOIN ComponentMaster CM WITH (NOLOCK) ON CM.PK_COmponentID=CCM.FK_ComponentID  
 WHERE URM.AssociateID=@LOGINID and URM.RowStatus=1 and CRM.RowStatus=1 and CM.FK_ComponentGroupID=10
 and CCM.FK_ComponentCountryID=1 and CM.RowStatus=1 and CCM.Rowstatus=1  
  
 ----Inserting Uploader data  
 --INSERT INTO @Uploader(CustomerID,ProjectID)  
 --SELECT P.Customer_ID,P.Project_ID FROM CentralRepository.DBO.VW_Centralrepository_Project P WITH (NOLOCK)   
 --INNER JOIN Approval_MonthlyYearlyApprovals AMA WITH (NOLOCK) ON CONVERT(VARCHAR,P.Project_ID)=AMA.ProjectID  
 --WHERE AMA.VerificationStatus=2 AND P.Customer_ID=@CustomerID AND AMA.Rowstatus=1 and   
 --AMA.Fk_ComponentId=39  
  
 --Selcting the Associate data  
   SELECT PCBA.ShiftType,PCBA.AssociateID,ISNULL(LTRIM(RTRIM(AD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(  
   RTRIM(AD.Associate_LastName)),'') AS AssociateName,  
   convert(varchar,StartDate,101) StartDate,Convert(varchar,EndDate,101) EndDate,  
   C.ProjectID,Amount,Grade,SetID,  
   isnull(PCBA.CreatedBy, '' )  CreatedBy,Case when isnull(PCBA.Modifieddate,'')<>'' then convert(varchar,  
   PCBA.Modifieddate,107)   
   else Convert(varchar,PCBA.Createddate,107) end UploadedDate, isnull(MC_A.Cdescription,'')  Status ,  
   PCBA.MonthAmount,PCBA.MonthlyWorkedDays,PCBA.NSADate as  ShiftStartDate  
   FROM PR.BPSNSA PCBA WITH (NOLOCK)  
   INNER JOIN @Project C ON PCBA.ProjectID=C.ProjectID  
   INNER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK)   
   ON CONVERT(VARCHAR,AD.Associate_ID)=CONVERT(VARCHAR,PCBA.AssociateID)   
   INNER  JOIN  MasterCodes MC_A on MC_A.CParentRef=3 and PCBA.Status=MC_A.CCodeId and MC_A.RowStatus=1 and   
   MC_A.Cuserdefined1='PR'  
   WHERE (PCBA.Status IN (1,5,15,16) AND PCBA.RowStatus=1)  AND (month(PCBA.CreatedDate)=@month) AND   
   year(PCBA.CreatedDate)=@year   and PCBA.CreatedBy=@LOGINID  
   END  
   ELSE  
   BEGIN   
   --/*Role id not in 10,11,5,6*/  
  SELECT PCBA.PK_BPSNSAId As UniqueID, PCBA.ShiftType,PCBA.AssociateID,  
  ISNULL(LTRIM(RTRIM(AD.Associate_FirstName)),'')+' '+  
  ISNULL(LTRIM(RTRIM(AD.Associate_LastName)),'') AS AssociateName,  
  NSADate,PB.HCMSchedule,PB.SwipeInTime, PB.SwipeOutTime,  
  PCBA.ProjectID,PCBA.Amount RoundAmount, ROUND(PCBA.RoughAmount,2) Amount,  
  PB.TotalEligibleHours TotalMinutes ,Grade,SetID,  
  isnull(PCBA.CreatedBy, '' )  CreatedBy,Case when isnull(PCBA.Modifieddate,'')<>''  
  then convert(varchar,PCBA.Modifieddate,107)   
  else Convert(varchar,PCBA.Createddate,107) end UploadedDate,   
  isnull(MC_A.Cdescription,'')  Status, PCBA.MonthAmount,PCBA.MonthlyWorkedDays,  
  PB.TopUpInTime_1, PB.TopUpOutTime_1, PB.TopUpReason_1, PB.TopUpInTime_2, PB.TopUpOutTime_2, PB.TopUpReason_2,   
  PB.TopUpInTime_3, PB.TopUpOutTime_3, PB.TopUpReason_3,  
  PB.TopUpInTime_4, PB.TopUpOutTime_4, PB.TopUpReason_4, PB.TopUpInTime_5, PB.TopUpOutTime_5, PB.TopUpReason_5,  
  PB.TopUpInTime_6, PB.TopUpOutTime_6, PB.TopUpReason_6  
  , RNSA.RecalledComments, RNSA.ModifiedStartDateTime, RNSA.ModifiedEndDateTime,PCBA.NSADate as  ShiftStartDate  
  FROM PR.BPSNSA PCBA WITH (NOLOCK) INNER JOIN PR.BPS_NSA PB WITH(NOLOCK)   
  ON PCBA.AssociateID = PB.AssociateID AND PCBA.NSADate = PB.Date   
  AND PCBA.ProjectId = PB.ProjectID AND PB.Rowstatus =1  
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK)   
  ON CONVERT(VARCHAR,AD.Associate_ID)=CONVERT(VARCHAR,PCBA.AssociateID)   
  INNER JOIN MasterCodes MC_A on MC_A.CParentRef=3 and PCBA.Status=MC_A.CCodeId   
  and MC_A.RowStatus=1 and MC_A.Cuserdefined1='PR'  
  LEFT JOIN PR.Trutime_Recalled_NSA RNSA ON RNSA.AssociateID = PCBA.AssociateID AND RNSA.Date = PCBA.NSADate  
        AND RNSA.Fk_ComponentID in(39) AND RNSA.ProjectID = PCBA.ProjectID AND RNSA.RowStatus = 1  
  WHERE (PCBA.Status IN (1,5,15,16,14,34,35) AND PCBA.RowStatus=1)  AND (((month(PCBA.CreatedDate)=@month)   
  AND year(PCBA.CreatedDate)=@year)  OR  
  ((month(PCBA.CreatedDate)=@month) AND year(PCBA.CreatedDate)=@year))  
   END  
END    
  
 --BPS Transport Allowance  
 IF(@ComponentGrpID=11 and @COMPONENTID=0)     
BEGIN  
 --/*Check RoleID is 6*/  
 IF(@RoleID=6)  
 BEGIN  
  
  DECLARE @LOGIN VARCHAR(11) = CAST(@loginid AS VARCHAR) 
 --Inserting Project Ddata  
  INSERT INTO @Project(ProjectID)  
  Select ProjectID FROM Approval_MonthlyYearlyApprovals AMA
  LEFT OUTER JOIN Centralrepository.dbo.vw_centralrepository_Current_ProjectManager PM  
  ON AMA.ProjectID=PM.Project_ID and Project_Manager=@LOGIN
  WHERE AMA.VerificationStatus=2 AND AMA.Rowstatus=1 and AMA.Fk_ComponentId=40 
  and PM.Project_Manager=@LOGIN 
  
  --Selcting the Associate data  
  SELECT PCBA.AssociateID,ISNULL(LTRIM(RTRIM(AD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(  
  AD.Associate_LastName)),'') AS AssociateName,  
  OfficeType,TravelType,StartDate,EndDate,StartTime,EndTime,C.ProjectID,Amount,Grade,SetID,  
  isnull(PCBA.CreatedBy, '' )  CreatedBy,Case when isnull(PCBA.Modifieddate,'')<>'' then convert(varchar,  
  PCBA.Modifieddate,107)   
  else Convert(varchar,PCBA.Createddate,107) end UploadedDate,isnull(MC_A.Cdescription,'')  Status ,  
  PCBA.City  
  FROM PR.BPSTransportAllowance PCBA WITH (NOLOCK)  
  INNER JOIN @Project C ON PCBA.ProjectID=C.ProjectID  
  LEFT OUTER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK)   
  ON CONVERT(VARCHAR,AD.Associate_ID)=CONVERT(VARCHAR,PCBA.AssociateID)  
  LEFT OUTER JOIN MasterCodes MC_A on MC_A.CParentRef=3 and PCBA.Status=MC_A.CCodeId and MC_A.RowStatus=1 and  
  MC_A.Cuserdefined1='PR'  
  WHERE (PCBA.Status IN (1,5,10,19,20) AND PCBA.RowStatus=1)
  --AND (month(PCBA.CreatedDate)=@month) AND year(PCBA.CreatedDate)=@year 
  AND ((DATEPART(MM,PCBA.CreatedDate)=@Month    AND DATEPART(YY,PCBA.CreatedDate)=@Year)OR  
      (DATEPART(MM,PCBA.ModifiedDate)=@Month  AND DATEPART(YY,PCBA.ModifiedDate)=@Year))   
  END  
  
  --BPS Approver  
  ELSE IF(@RoleID=10)  
  BEGIN  
  
 --Selecing CustomerID  
 Select @CustomerID=Customer_ID FROM   
 CentralRepository.DBO.VW_Centralrepository_Project P WITH (NOLOCK)   
 INNER JOIN UserRoleMapping URM WITH (NOLOCK) ON P.Customer_ID=URM.CustomerID and URM.AssociateID=@LoginID  
 INNER JOIN ComponentRoleMapping CRM WITH (NOLOCK) on   
 URM.Fk_ComponentRoleID=CRM.PK_ComponentRoleID and CRM.FK_RoleID=10  
 INNER JOIN ComponentCOuntryMapping CCM WITH (NOLOCK) ON   
 CCM.PK_ComponentCountryMappingID=CRM.FK_ComponentCountryMappingID  
 INNER JOIN ComponentMaster CM WITH (NOLOCK) ON CM.PK_COmponentID=CCM.FK_ComponentID  
 WHERE  URM.AssociateID=@LoginID and URM.RowStatus=1 and CRM.RowStatus=1 and CM.FK_ComponentGroupID=11 and   
 CCM.FK_ComponentCountryID=1  
 and CM.RowStatus=1 and CCM.Rowstatus=1  
  
 --Inserting Customer data  
 INSERT INTO @Customer(CustomerID,ProjectID)  
 Select P.Customer_ID,P.Project_ID FROM CentralRepository.DBO.VW_Centralrepository_Project P WITH (NOLOCK)   
 INNER JOIN Approval_MonthlyYearlyApprovals AMA WITH (NOLOCK) ON CONVERT(VARCHAR,P.Project_ID)=AMA.ProjectID  
 WHERE AMA.VerificationStatus=2 AND P.Customer_ID=@CustomerID AND AMA.Rowstatus=1   and AMA.Fk_ComponentId=40  
  
 --Selcting the Associate data  
 SELECT PCBA.AssociateID,ISNULL(LTRIM(RTRIM(AD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(  
 RTRIM(AD.Associate_LastName)),'') AS AssociateName,  
 OfficeType,TravelType,StartDate,EndDate,StartTime,EndTime,C.ProjectID,Amount,Grade,SetID,  
 isnull(PCBA.CreatedBy, '' )  CreatedBy,Case when isnull(PCBA.Modifieddate,'')<>'' then convert(varchar,  
 PCBA.Modifieddate,107) else Convert(varchar,PCBA.Createddate,107) end UploadedDate,isnull(MC_A.Cdescription,'')   
 Status,PCBA.City  
 FROM PR.BPSTransportAllowance PCBA WITH (NOLOCK)  
 INNER JOIN @Customer C ON PCBA.ProjectID=C.ProjectID  
 LEFT OUTER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK)   
 ON CONVERT(VARCHAR,AD.Associate_ID)=CONVERT(VARCHAR,PCBA.AssociateID)  
 LEFT OUTER JOIN MasterCodes MC_A on MC_A.CParentRef=3 and PCBA.Status=MC_A.CCodeId and MC_A.RowStatus=1   
 and MC_A.Cuserdefined1='PR'  
 WHERE (PCBA.Status IN (1,15,17,10,19,20,34,35) AND PCBA.RowStatus=1)   
 AND (month(PCBA.CreatedDate)=@month) AND year(PCBA.CreatedDate)=@year   
  
  END  
  
   --BPS Uploader  
  ELSE IF(@RoleID=11)  
  BEGIN  
 Select @CustomerID=Customer_ID FROM   
 CentralRepository.DBO.VW_Centralrepository_Project P WITH (NOLOCK)   
 INNER JOIN UserRoleMapping URM WITH (NOLOCK) ON P.Customer_ID=URM.CustomerID and URM.AssociateID=@LoginID  
 INNER JOIN ComponentRoleMapping CRM WITH (NOLOCK) on URM.Fk_ComponentRoleID=CRM.PK_ComponentRoleID and   
 CRM.FK_RoleID=11   
 INNER JOIN ComponentCOuntryMapping CCM WITH (NOLOCK) ON   
 CCM.PK_ComponentCountryMappingID=CRM.FK_ComponentCountryMappingID  
 INNER JOIN ComponentMaster CM WITH (NOLOCK) ON CM.PK_COmponentID=CCM.FK_ComponentID  
 WHERE  URM.AssociateID=@LoginID and URM.RowStatus=1 and CRM.RowStatus=1 and CM.FK_ComponentGroupID=11 and   
 CCM.FK_ComponentCountryID=1  
 and CM.RowStatus=1 and CCM.Rowstatus=1  
   
 --Inserting Uploader data  
 INSERT INTO @Uploader(CustomerID,ProjectID)  
 SELECT P.Customer_ID,P.Project_ID FROM CentralRepository.DBO.VW_Centralrepository_Project P WITH (NOLOCK)   
 INNER JOIN Approval_MonthlyYearlyApprovals AMA WITH (NOLOCK) ON CONVERT(VARCHAR,P.Project_ID)=AMA.ProjectID  
 WHERE AMA.VerificationStatus=2 AND P.Customer_ID=@CustomerID AND AMA.Rowstatus=1 and  
 AMA.Fk_ComponentId=40  
  
 --Selcting the Associate data  
 SELECT PCBA.AssociateID,ISNULL(LTRIM(RTRIM(AD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(  
 AD.Associate_LastName)),'') AS AssociateName,  
 OfficeType,TravelType,StartDate,EndDate,StartTime,EndTime,C.ProjectID,Amount,Grade,SetID,  
 isnull(PCBA.CreatedBy, '' )  CreatedBy,Case when isnull(PCBA.Modifieddate,'')<>'' then convert(varchar,  
 PCBA.Modifieddate,107) else Convert(varchar,PCBA.Createddate,107) end UploadedDate, isnull(MC_A.Cdescription,'')  
 Status ,PCBA.City  
 FROM PR.BPSTransportAllowance PCBA WITH (NOLOCK)  
 INNER JOIN @Uploader C ON PCBA.ProjectID=C.ProjectID  
 LEFT OUTER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK)  
 ON CONVERT(VARCHAR,AD.Associate_ID)=CONVERT(VARCHAR,PCBA.AssociateID)  
 LEFT OUTER JOIN MasterCodes MC_A on MC_A.CParentRef=3 and PCBA.Status=MC_A.CCodeId and MC_A.RowStatus=1   
 and MC_A.Cuserdefined1='PR'  
 WHERE (PCBA.Status IN (1,10,19,20,5,15,34,35) AND PCBA.RowStatus=1) AND (month(PCBA.CreatedDate)=@month) AND  
 year(PCBA.CreatedDate)=@year  and PCBA.CreatedBy=@LOGINID  
   END  
   ELSE  
   BEGIN   
   --Selcting the Associate data  
    SELECT PCBA.PK_BPStransportID As UniqueID,PCBA.AssociateID,ISNULL(LTRIM(RTRIM(AD.Associate_FirstName)),'')+' '+  
    ISNULL(LTRIM(RTRIM(AD.Associate_LastName)),'') AS AssociateName,  
  OfficeType,TravelType,StartDate,EndDate,StartTime,EndTime,ProjectID,Amount,Grade,SetID,  
  isnull(PCBA.CreatedBy, '' )  CreatedBy,  
  Case when isnull(PCBA.Modifieddate,'')<>'' then convert(varchar,PCBA.Modifieddate,107) else Convert(  
  varchar,PCBA.Createddate,107) end UploadedDate,   
  isnull(MC_A.Cdescription,'') Status ,  
  PCBA.City  
  FROM PR.BPSTRansportAllowance PCBA WITH (NOLOCK)  
  LEFT OUTER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK)   
  ON CONVERT(VARCHAR,AD.Associate_ID)=CONVERT(VARCHAR,PCBA.AssociateID)  
  LEFT OUTER JOIN MasterCodes MC_A on MC_A.CParentRef=3 and PCBA.Status=MC_A.CCodeId and MC_A.RowStatus=1   
  and MC_A.Cuserdefined1='PR'  
  WHERE (PCBA.Status IN (1,10,19,20,5,15,16,34,35) AND PCBA.RowStatus=1) AND (((month(PCBA.CreatedDate)=@month) AND   
  year(PCBA.CreatedDate)=@year)  OR   
  ((month(PCBA.CreatedDate)=@month) AND year(PCBA.CreatedDate)=@year))
   END  
END    
  
 --Gym Recovery  
IF(@COMPONENTID = 115)    
 BEGIN   
  
   --selecting the Associate data  
  SELECT GR.PK_GRID As UniqueID,GR.AssociateID,  
  ISNULL(LTRIM(RTRIM(AD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(AD.Associate_LastName)),'') AS AssociateName,  
  GR.Location,GR.Facility,GR.ProjectID,GR.Amount,GR.DeductionMonth,GR.RegisteredDate,isnull(MC_A.Cdescription,'')  
  AS Status , GR.CreatedBy UploaderID,  
  ISNULL(LTRIM(RTRIM(UD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(UD.Associate_LastName)),'') AS UploaderName,  
  GR.CreatedDate,GR.ModifiedBy,GR.ModifiedDate  
  FROM PR.GymRecovery GR  
  INNER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK)   
  ON CONVERT(VARCHAR,AD.Associate_ID)=CONVERT(VARCHAR,GR.AssociateID)  
  INNER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details UD WITH(NOLOCK)   
  ON CONVERT(VARCHAR,UD.Associate_ID)=GR.CreatedBy    
  LEFT Outer Join MasterCodes MC_A on MC_A.CParentRef=3 and GR.Status=MC_A.CCodeId and MC_A.RowStatus=1   
  and MC_A.Cuserdefined1='PR'  
  WHERE GR.Status IN (1,5,10,11) AND GR.RowStatus=1 AND  ((DATEPART(MM,GR.CreatedDate)=@month   
  AND DATEPART(YY,GR.CreatedDate)=@year) OR   
  (DATEPART(MM,GR.ModifiedDate)=@Month  AND DATEPART(YY,GR.ModifiedDate)=@Year))  
       
   END  
  
  --Outreach Recovery*/   
   IF(@COMPONENTID = 116)    
   BEGIN   
   --Selcting the Associate data  
  SELECT GR.UniqueID,GR.AssociateID,  
  ISNULL(LTRIM(RTRIM(AD.Associate_FirstName)),'')+' '+  
  ISNULL(LTRIM(RTRIM(AD.Associate_LastName)),'') AS AssociateName,  
  GR.Location,GR.ProjectID,GR.Amount,GR.DeductionMonth,isnull(MC_A.Cdescription,'') AS Status ,  
  GR.CreatedBy UploaderID,  
  GR.CreatedDate,GR.ModifiedBy,GR.ModifiedDate  
 FROM PR.OutreachRecovery GR  
  INNER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK)   
  ON CONVERT(VARCHAR,AD.Associate_ID)=CONVERT(VARCHAR,GR.AssociateID)  
  LEFT Outer Join MasterCodes MC_A on MC_A.CParentRef=3 and GR.Status=MC_A.CCodeId and MC_A.RowStatus=1   
  and MC_A.Cuserdefined1='PR'  
  WHERE GR.Status IN (1,5,10,11) AND GR.RowStatus=1 AND  ((DATEPART(MM,GR.CreatedDate)=@month   
  AND DATEPART(YY,GR.CreatedDate)=@year) OR   
  (DATEPART(MM,GR.ModifiedDate)=@Month  AND DATEPART(YY,GR.ModifiedDate)=@Year))  
       
   END  
  
   IF(@COMPONENTID=177)    
   BEGIN  
    IF(@RoleID in (6,23))  
 BEGIN  
   CREATE TABLE #INDCOMPONENTS (ComponentID INT,ProjectID VARCHAR(50))  
             
     --Inserting component data  
   INSERT INTO #INDCOMPONENTS (ComponentID ,ProjectID)     
   EXEC [dbo].[usp_GetComponentsForRole] @RoleID,@LoginID,@ComponentGrpID,@CountryID    
            
  SELECT STP.AssociateID,ISNULL(LTRIM(RTRIM(AD.Associate_FirstName)),'')+' '+  
  ISNULL(LTRIM(RTRIM(AD.Associate_LastName)),'') AS AssociateName ,  
  STP.ProjectID,STP.Department,CM.ComponentShortName AS AllowanceType,STM.ShiftTypeName AS ShiftType,  
  CONVERT(VARCHAR,STP.STARTDATE,101) AS AllowanceDate,STP.Capacity,  
  STP.TransportEligibility,STP.Amount AS AllowanceAmount, STP.CreatedBy AS UploadedBy,  
  ISNULL(LTRIM(RTRIM(UD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(UD.Associate_LastName)),'') AS UploaderName,  
  Case when isnull(STP.Modifieddate,'')<>'' then STP.Modifieddate  else STP.Createddate  end UploadedDate,  
  CPM.PROJECT_MANAGER AS PMID,  
  ISNULL(LTRIM(RTRIM(PD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(PD.Associate_LastName)),'') AS PMName,   
  STP.ApprovedDate as PMApprovedDate,  
  (CASE WHEN STP.Status=1 THEN 'Valid' WHEN STP.Status=5 THEN 'Processed'  
  WHEN STP.Status=4 THEN 'ReSubmitted' END) AS Status  
  FROM PR.INDShiftComponents STP WITH(NOLOCK)   
  INNER JOIN ShiftTypeMaster STM WITH(NOLOCK) ON STM.PK_ShiftTypeID=STP.FK_ShiftTypeID  
  INNER JOIN ComponentMaster CM WITH(NOLOCK) ON CM.PK_ComponentId=STP.Fk_ComponentID  
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK)   
  ON AD.Associate_ID=STP.AssociateID   
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details UD WITH(NOLOCK)   
  ON UD.Associate_ID=STP.CreatedBy   
  LEFT OUTER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Current_ProjectManager CPM WITH(NOLOCK)   
  ON CPM.PROJECT_ID=STP.ProjectID  
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details PD WITH(NOLOCK)  
  ON PD.Associate_ID=CPM.PROJECT_MANAGER  
  INNER JOIN #INDCOMPONENTS CMTS WITH(NOLOCK) ON  CMTS.ComponentID=STP.Fk_ComponentID  
  AND CMTS.ProjectID=STP.ProjectID  
  WHERE STP.Status IN (1,5,4) AND STP.RowStatus=1 AND DATEPART(MM,STP.CreatedDate)=@Month   
  AND DATEPART(YY,STP.CreatedDate)=@Year  
  and CM.Pk_ComponentID=@Componentid  
            
  DROP TABLE  #INDCOMPONENTS  
 END   
 ELSE IF(@RoleID=24)  
 BEGIN  
  SELECT STP.PK_INDShiftComponentID AS UniqueID,STP.AssociateID,  
     ISNULL(LTRIM(RTRIM(AD.Associate_FirstName)),'')+' '+  
     ISNULL(LTRIM(RTRIM(AD.Associate_LastName)),'') AS AssociateName ,  
     STP.ProjectID,STP.Department,CM.ComponentShortName AS AllowanceType,STM.ShiftTypeName AS ShiftType,  
     CONVERT(VARCHAR,STP.STARTDATE,101) AS AllowanceDate,STP.Capacity,STP.TransportEligibility,  
     STP.Amount AS AllowanceAmount,STP.CreatedBy AS UploadedBy,  
     ISNULL(LTRIM(RTRIM(UD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(UD.Associate_LastName)),'')   
     AS UploaderName,  
     Case when isnull(STP.Modifieddate,'')<>'' then STP.Modifieddate else STP.Createddate end UploadedDate,  
     CPM.PROJECT_MANAGER AS PMID,  
     ISNULL(LTRIM(RTRIM(PD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(PD.Associate_LastName)),'') AS PMName,   
     STP.ApprovedDate as PMApprovedDate,  
     (CASE WHEN STP.Status=1 THEN 'Valid'   
     WHEN STP.Status=5 THEN 'Processed'    
     WHEN STP.Status=4 THEN 'ReSubmitted'   
     WHEN STP.Status=15 THEN 'Approved by PM'   
     WHEN STP.Status=35 THEN 'Approved by D+'  END) AS Status   
     FROM PR.INDShiftComponents STP WITH(NOLOCK)   
     INNER JOIN ShiftTypeMaster STM WITH(NOLOCK) ON STM.PK_ShiftTypeID=STP.FK_ShiftTypeID  
     INNER JOIN ComponentMaster CM WITH(NOLOCK) ON CM.PK_ComponentId=STP.Fk_ComponentID  
     INNER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK)   
     ON CONVERT(VARCHAR,AD.Associate_ID)=CONVERT(VARCHAR,STP.AssociateID)  
     INNER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details UD WITH(NOLOCK)   
     ON CONVERT(VARCHAR,UD.Associate_ID)=CONVERT(VARCHAR,STP.CreatedBy)  
     LEFT OUTER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Current_ProjectManager CPM WITH(NOLOCK)   
     ON CONVERT(VARCHAR,CPM.PROJECT_ID)=STP.ProjectID  
     INNER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details PD WITH(NOLOCK)   
     ON PD.Associate_ID=CPM.PROJECT_MANAGER  
     WHERE STP.Status IN (1,4,5,15,35) AND STP.RowStatus=1 AND ((DATEPART(MM,STP.CreatedDate)=@Month   
     AND DATEPART(YY,STP.CreatedDate)=@Year) OR   
     (DATEPART(MM,STP.ModifiedDate)=@Month  AND DATEPART(YY,STP.ModifiedDate)=@Year))  
     and CM.PK_Componentid=@componentid and STP.CreatedBy=@LOGINID  
 END  
 ELSE   
 BEGIN  
    SELECT STP.PK_INDShiftComponentID AS UniqueID,STP.AssociateID,  
     ISNULL(LTRIM(RTRIM(AD.Associate_FirstName)),'')+' '+  
     ISNULL(LTRIM(RTRIM(AD.Associate_LastName)),'') AS AssociateName ,  
     STP.ProjectID,STP.Department,CM.ComponentShortName AS AllowanceType,STM.ShiftTypeName AS ShiftType,  
     CONVERT(VARCHAR,STP.STARTDATE,101) AS AllowanceDate,STP.Capacity,STP.TransportEligibility,  
     STP.Amount AS AllowanceAmount,STP.CreatedBy AS UploadedBy,  
     ISNULL(LTRIM(RTRIM(UD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(UD.Associate_LastName)),'')   
     AS UploaderName,  
     Case when isnull(STP.Modifieddate,'')<>'' then STP.Modifieddate else STP.Createddate end UploadedDate,  
     CPM.PROJECT_MANAGER AS PMID,  
     ISNULL(LTRIM(RTRIM(PD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(PD.Associate_LastName)),'') AS PMName,   
     STP.ApprovedDate as PMApprovedDate,  
     (CASE WHEN STP.Status=1 THEN 'Valid'   
     WHEN STP.Status=5 THEN 'Processed'    
     WHEN STP.Status=4 THEN 'ReSubmitted'   
     WHEN STP.Status=15 THEN 'Approved by PM'   
     WHEN STP.Status=35 THEN 'Approved by D+'  END) AS Status   
     FROM PR.INDShiftComponents STP WITH(NOLOCK)   
     INNER JOIN ShiftTypeMaster STM WITH(NOLOCK) ON STM.PK_ShiftTypeID=STP.FK_ShiftTypeID  
     INNER JOIN ComponentMaster CM WITH(NOLOCK) ON CM.PK_ComponentId=STP.Fk_ComponentID  
     INNER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK)   
     ON CONVERT(VARCHAR,AD.Associate_ID)=CONVERT(VARCHAR,STP.AssociateID)  
     INNER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details UD WITH(NOLOCK)   
     ON CONVERT(VARCHAR,UD.Associate_ID)=CONVERT(VARCHAR,STP.CreatedBy)  
     LEFT OUTER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Current_ProjectManager CPM WITH(NOLOCK)   
     ON CONVERT(VARCHAR,CPM.PROJECT_ID)=STP.ProjectID  
     INNER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details PD WITH(NOLOCK)   
     ON PD.Associate_ID=CPM.PROJECT_MANAGER  
     WHERE STP.Status IN (1,4,5,15,35) AND STP.RowStatus=1 AND ((DATEPART(MM,STP.CreatedDate)=@Month   
     AND DATEPART(YY,STP.CreatedDate)=@Year) OR   
     (DATEPART(MM,STP.ModifiedDate)=@Month  AND DATEPART(YY,STP.ModifiedDate)=@Year))  
     and CM.PK_Componentid=@componentid  
  END  
   END   
  
    IF(@COMPONENTID=178)    
   BEGIN  
   IF(@RoleID in (6,23))  
 BEGIN  
   CREATE TABLE #INDCOMPONENTSBI (ComponentID INT,ProjectID VARCHAR(50))  
             
     --Inserting component data  
   INSERT INTO #INDCOMPONENTSBI (ComponentID ,ProjectID)     
   EXEC [dbo].[usp_GetComponentsForRole] @RoleID,@LoginID,@ComponentGrpID,@CountryID    
            
  SELECT STP.AssociateID,ISNULL(LTRIM(RTRIM(AD.Associate_FirstName)),'')+' '+  
  ISNULL(LTRIM(RTRIM(AD.Associate_LastName)),'') AS AssociateName ,  
  STP.ProjectID,STP.Department,CM.ComponentShortName AS AllowanceType,STM.ShiftTypeName AS ShiftType,  
  CONVERT(VARCHAR,STP.STARTDATE,101) AS AllowanceDate,  
  STP.Amount AS AllowanceAmount, STP.CreatedBy AS UploadedBy,  
  ISNULL(LTRIM(RTRIM(UD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(UD.Associate_LastName)),'') AS UploaderName,  
  Case when isnull(STP.Modifieddate,'')<>'' then STP.Modifieddate  else STP.Createddate  end UploadedDate,  
  CPM.PROJECT_MANAGER AS PMID,  
  ISNULL(LTRIM(RTRIM(PD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(PD.Associate_LastName)),'') AS PMName,   
  STP.ApprovedDate as PMApprovedDate,  
  (CASE WHEN STP.Status=1 THEN 'Valid' WHEN STP.Status=5 THEN 'Processed'  
  WHEN STP.Status=4 THEN 'ReSubmitted' END) AS Status  
  FROM PR.INDShiftComponents STP WITH(NOLOCK)   
  INNER JOIN ShiftTypeMaster STM WITH(NOLOCK) ON STM.PK_ShiftTypeID=STP.FK_ShiftTypeID  
  INNER JOIN ComponentMaster CM WITH(NOLOCK) ON CM.PK_ComponentId=STP.Fk_ComponentID  
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK)   
  ON AD.Associate_ID=STP.AssociateID   
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details UD WITH(NOLOCK)   
  ON UD.Associate_ID=STP.CreatedBy   
  LEFT OUTER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Current_ProjectManager CPM WITH(NOLOCK)   
  ON CPM.PROJECT_ID=STP.ProjectID  
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details PD WITH(NOLOCK)  
  ON PD.Associate_ID=CPM.PROJECT_MANAGER  
  INNER JOIN #INDCOMPONENTSBI CMTS WITH(NOLOCK) ON  CMTS.ComponentID=STP.Fk_ComponentID  
  AND CMTS.ProjectID=STP.ProjectID  
  WHERE STP.Status IN (1,5,4) AND STP.RowStatus=1 AND DATEPART(MM,STP.CreatedDate)=@Month   
  AND DATEPART(YY,STP.CreatedDate)=@Year  
  and CM.Pk_ComponentID=@Componentid  
            
  DROP TABLE  #INDCOMPONENTSBI  
 END   
 ELSE IF(@RoleID=24)  
 BEGIN  
   SELECT STP.PK_INDShiftComponentID AS UniqueID,STP.AssociateID,  
     ISNULL(LTRIM(RTRIM(AD.Associate_FirstName)),'')+' '+  
     ISNULL(LTRIM(RTRIM(AD.Associate_LastName)),'') AS AssociateName ,  
     STP.ProjectID,STP.Department,CM.ComponentShortName AS AllowanceType,STM.ShiftTypeName AS ShiftType,  
     CONVERT(VARCHAR,STP.STARTDATE,101) AS AllowanceDate,  
     STP.Amount AS AllowanceAmount,STP.CreatedBy AS UploadedBy,  
     ISNULL(LTRIM(RTRIM(UD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(UD.Associate_LastName)),'')   
     AS UploaderName,  
     Case when isnull(STP.Modifieddate,'')<>'' then STP.Modifieddate else STP.Createddate end UploadedDate,  
     CPM.PROJECT_MANAGER AS PMID,  
     ISNULL(LTRIM(RTRIM(PD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(PD.Associate_LastName)),'') AS PMName,   
     STP.ApprovedDate as PMApprovedDate,  
     (CASE WHEN STP.Status=1 THEN 'Valid'   
     WHEN STP.Status=5 THEN 'Processed'    
     WHEN STP.Status=4 THEN 'ReSubmitted'   
     WHEN STP.Status=15 THEN 'Approved by PM'   
     WHEN STP.Status=35 THEN 'Approved by D+'  END) AS Status   
     FROM PR.INDShiftComponents STP WITH(NOLOCK)   
     INNER JOIN ShiftTypeMaster STM WITH(NOLOCK) ON STM.PK_ShiftTypeID=STP.FK_ShiftTypeID  
     INNER JOIN ComponentMaster CM WITH(NOLOCK) ON CM.PK_ComponentId=STP.Fk_ComponentID  
     INNER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK)   
     ON CONVERT(VARCHAR,AD.Associate_ID)=CONVERT(VARCHAR,STP.AssociateID)  
     INNER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details UD WITH(NOLOCK)   
     ON CONVERT(VARCHAR,UD.Associate_ID)=CONVERT(VARCHAR,STP.CreatedBy)  
     LEFT OUTER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Current_ProjectManager CPM WITH(NOLOCK)   
     ON CONVERT(VARCHAR,CPM.PROJECT_ID)=STP.ProjectID  
     INNER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details PD WITH(NOLOCK)   
     ON PD.Associate_ID=CPM.PROJECT_MANAGER  
     WHERE STP.Status IN (1,4,5,15,35) AND STP.RowStatus=1 AND ((DATEPART(MM,STP.CreatedDate)=@Month   
     AND DATEPART(YY,STP.CreatedDate)=@Year) OR   
     (DATEPART(MM,STP.ModifiedDate)=@Month  AND DATEPART(YY,STP.ModifiedDate)=@Year))  
     and CM.PK_Componentid=@componentid and STP.CreatedBy=@LOGINID  
 END  
 ELSE   
 BEGIN  
    SELECT STP.PK_INDShiftComponentID AS UniqueID,STP.AssociateID,  
     ISNULL(LTRIM(RTRIM(AD.Associate_FirstName)),'')+' '+  
     ISNULL(LTRIM(RTRIM(AD.Associate_LastName)),'') AS AssociateName ,  
     STP.ProjectID,STP.Department,CM.ComponentShortName AS AllowanceType,STM.ShiftTypeName AS ShiftType,  
     CONVERT(VARCHAR,STP.STARTDATE,101) AS AllowanceDate,  
     STP.Amount AS AllowanceAmount,STP.CreatedBy AS UploadedBy,  
     ISNULL(LTRIM(RTRIM(UD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(UD.Associate_LastName)),'')   
     AS UploaderName,  
     Case when isnull(STP.Modifieddate,'')<>'' then STP.Modifieddate else STP.Createddate end UploadedDate,  
     CPM.PROJECT_MANAGER AS PMID,  
     ISNULL(LTRIM(RTRIM(PD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(PD.Associate_LastName)),'') AS PMName,   
     STP.ApprovedDate as PMApprovedDate,  
     (CASE WHEN STP.Status=1 THEN 'Valid'   
     WHEN STP.Status=5 THEN 'Processed'    
     WHEN STP.Status=4 THEN 'ReSubmitted'   
     WHEN STP.Status=15 THEN 'Approved by PM'   
     WHEN STP.Status=35 THEN 'Approved by D+'  END) AS Status   
     FROM PR.INDShiftComponents STP WITH(NOLOCK)   
     INNER JOIN ShiftTypeMaster STM WITH(NOLOCK) ON STM.PK_ShiftTypeID=STP.FK_ShiftTypeID  
     INNER JOIN ComponentMaster CM WITH(NOLOCK) ON CM.PK_ComponentId=STP.Fk_ComponentID  
     INNER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK)   
     ON CONVERT(VARCHAR,AD.Associate_ID)=CONVERT(VARCHAR,STP.AssociateID)  
     INNER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details UD WITH(NOLOCK)   
     ON CONVERT(VARCHAR,UD.Associate_ID)=CONVERT(VARCHAR,STP.CreatedBy)  
     LEFT OUTER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Current_ProjectManager CPM WITH(NOLOCK)   
     ON CONVERT(VARCHAR,CPM.PROJECT_ID)=STP.ProjectID  
     INNER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details PD WITH(NOLOCK)   
     ON PD.Associate_ID=CPM.PROJECT_MANAGER  
     WHERE STP.Status IN (1,4,5,15,35) AND STP.RowStatus=1 AND ((DATEPART(MM,STP.CreatedDate)=@Month   
     AND DATEPART(YY,STP.CreatedDate)=@Year) OR   
     (DATEPART(MM,STP.ModifiedDate)=@Month  AND DATEPART(YY,STP.ModifiedDate)=@Year))  
     and CM.PK_Componentid=@componentid  
 END  
   END  
  
    IF(@COMPONENTID=179)    
   BEGIN  
   IF(@RoleID in (6,23))  
 BEGIN  
   CREATE TABLE #INDCOMPONENTSDBO (ComponentID INT,ProjectID VARCHAR(50))  
             
     --Inserting component data  
   INSERT INTO #INDCOMPONENTSDBO (ComponentID ,ProjectID)     
   EXEC [dbo].[usp_GetComponentsForRole] @RoleID,@LoginID,@ComponentGrpID,@CountryID    
            
  SELECT STP.AssociateID,ISNULL(LTRIM(RTRIM(AD.Associate_FirstName)),'')+' '+  
  ISNULL(LTRIM(RTRIM(AD.Associate_LastName)),'') AS AssociateName ,  
  STP.ProjectID,STP.Department,CM.ComponentShortName AS AllowanceType,  
  CONVERT(VARCHAR,STP.StartDate,101) AS StartDate,  
  CONVERT(VARCHAR,STP.EndDate,101) AS Enddate,STP.Capacity,  
  STP.Amount, STP.CreatedBy AS UploaderID,  
  ISNULL(LTRIM(RTRIM(UD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(UD.Associate_LastName)),'') AS UploaderName,  
  Case when isnull(STP.Modifieddate,'')<>'' then STP.Modifieddate  else STP.Createddate  end UploadedDate,  
  CPM.PROJECT_MANAGER AS PMID,  
  ISNULL(LTRIM(RTRIM(PD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(PD.Associate_LastName)),'') AS PMName,   
  STP.ApprovedDate as PMApprovedDate,  
  (CASE WHEN STP.Status=1 THEN 'Valid' WHEN STP.Status=5 THEN 'Processed'  
  WHEN STP.Status=4 THEN 'ReSubmitted' END) AS Status  
  FROM PR.INDShiftComponents STP WITH(NOLOCK)   
  --INNER JOIN ShiftTypeMaster STM WITH(NOLOCK) ON STM.PK_ShiftTypeID=STP.FK_ShiftTypeID  
  INNER JOIN ComponentMaster CM WITH(NOLOCK) ON CM.PK_ComponentId=STP.Fk_ComponentID  
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK)   
  ON AD.Associate_ID=STP.AssociateID   
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details UD WITH(NOLOCK)   
  ON UD.Associate_ID=STP.CreatedBy   
  LEFT OUTER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Current_ProjectManager CPM WITH(NOLOCK)   
  ON CPM.PROJECT_ID=STP.ProjectID  
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details PD WITH(NOLOCK)  
  ON PD.Associate_ID=CPM.PROJECT_MANAGER  
  INNER JOIN #INDCOMPONENTSDBO CMTS WITH(NOLOCK) ON  CMTS.ComponentID=STP.Fk_ComponentID  
  AND CMTS.ProjectID=STP.ProjectID  
  WHERE STP.Status IN (1,5,4) AND STP.RowStatus=1 AND DATEPART(MM,STP.CreatedDate)=@Month   
  AND DATEPART(YY,STP.CreatedDate)=@Year  
  and CM.Pk_ComponentID=@Componentid  
            
  DROP TABLE  #INDCOMPONENTSDBO  
 END   
 ELSE IF(@RoleID=24)  
 BEGIN  
    SELECT STP.PK_INDShiftComponentID AS UniqueID,STP.AssociateID,  
     ISNULL(LTRIM(RTRIM(AD.Associate_FirstName)),'')+' '+  
     ISNULL(LTRIM(RTRIM(AD.Associate_LastName)),'') AS AssociateName ,  
     STP.ProjectID,STP.Department,CM.ComponentShortName AS AllowanceType,  
     CONVERT(VARCHAR,STP.StartDate,101) AS StartDate,  
        CONVERT(VARCHAR,STP.EndDate,101) AS Enddate,STP.Capacity,  
     STP.Amount ,STP.CreatedBy AS UploaderID,  
     ISNULL(LTRIM(RTRIM(UD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(UD.Associate_LastName)),'')   
     AS UploaderName,  
     Case when isnull(STP.Modifieddate,'')<>'' then STP.Modifieddate else STP.Createddate end UploadedDate,  
     CPM.PROJECT_MANAGER AS PMID,  
     ISNULL(LTRIM(RTRIM(PD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(PD.Associate_LastName)),'') AS PMName,   
     STP.ApprovedDate as PMApprovedDate,  
     (CASE WHEN STP.Status=1 THEN 'Valid'   
     WHEN STP.Status=5 THEN 'Processed'    
     WHEN STP.Status=4 THEN 'ReSubmitted'   
     WHEN STP.Status=15 THEN 'Approved by PM'   
     WHEN STP.Status=35 THEN 'Approved by D+'  END) AS Status   
     FROM PR.INDShiftComponents STP WITH(NOLOCK)   
     --INNER JOIN ShiftTypeMaster STM WITH(NOLOCK) ON STM.PK_ShiftTypeID=STP.FK_ShiftTypeID  
     INNER JOIN ComponentMaster CM WITH(NOLOCK) ON CM.PK_ComponentId=STP.Fk_ComponentID  
     INNER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK)   
     ON CONVERT(VARCHAR,AD.Associate_ID)=CONVERT(VARCHAR,STP.AssociateID)  
     INNER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details UD WITH(NOLOCK)   
     ON CONVERT(VARCHAR,UD.Associate_ID)=CONVERT(VARCHAR,STP.CreatedBy)  
     LEFT OUTER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Current_ProjectManager CPM WITH(NOLOCK)   
     ON CONVERT(VARCHAR,CPM.PROJECT_ID)=STP.ProjectID  
     INNER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details PD WITH(NOLOCK)   
     ON PD.Associate_ID=CPM.PROJECT_MANAGER  
     WHERE STP.Status IN (1,4,5,15,35) AND STP.RowStatus=1 AND ((DATEPART(MM,STP.CreatedDate)=@Month   
     AND DATEPART(YY,STP.CreatedDate)=@Year) OR   
     (DATEPART(MM,STP.ModifiedDate)=@Month  AND DATEPART(YY,STP.ModifiedDate)=@Year))  
     and CM.PK_Componentid=@componentid and STP.CreatedBy=@LOGINID  
 END  
 ELSE   
 BEGIN  
    SELECT STP.PK_INDShiftComponentID AS UniqueID,STP.AssociateID,  
     ISNULL(LTRIM(RTRIM(AD.Associate_FirstName)),'')+' '+  
     ISNULL(LTRIM(RTRIM(AD.Associate_LastName)),'') AS AssociateName ,  
     STP.ProjectID,STP.Department,CM.ComponentShortName AS AllowanceType,  
     CONVERT(VARCHAR,STP.StartDate,101) AS StartDate,  
        CONVERT(VARCHAR,STP.EndDate,101) AS Enddate,STP.Capacity,  
     STP.Amount ,STP.CreatedBy AS UploaderID,  
     ISNULL(LTRIM(RTRIM(UD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(UD.Associate_LastName)),'')   
     AS UploaderName,  
     Case when isnull(STP.Modifieddate,'')<>'' then STP.Modifieddate else STP.Createddate end UploadedDate,  
     CPM.PROJECT_MANAGER AS PMID,  
     ISNULL(LTRIM(RTRIM(PD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(PD.Associate_LastName)),'') AS PMName,   
     STP.ApprovedDate as PMApprovedDate,  
     (CASE WHEN STP.Status=1 THEN 'Valid'   
     WHEN STP.Status=5 THEN 'Processed'    
     WHEN STP.Status=4 THEN 'ReSubmitted'   
     WHEN STP.Status=15 THEN 'Approved by PM'   
     WHEN STP.Status=35 THEN 'Approved by D+'  END) AS Status   
     FROM PR.INDShiftComponents STP WITH(NOLOCK)   
     --INNER JOIN ShiftTypeMaster STM WITH(NOLOCK) ON STM.PK_ShiftTypeID=STP.FK_ShiftTypeID  
     INNER JOIN ComponentMaster CM WITH(NOLOCK) ON CM.PK_ComponentId=STP.Fk_ComponentID  
     INNER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK)   
     ON CONVERT(VARCHAR,AD.Associate_ID)=CONVERT(VARCHAR,STP.AssociateID)  
     INNER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details UD WITH(NOLOCK)   
     ON CONVERT(VARCHAR,UD.Associate_ID)=CONVERT(VARCHAR,STP.CreatedBy)  
     LEFT OUTER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Current_ProjectManager CPM WITH(NOLOCK)   
     ON CONVERT(VARCHAR,CPM.PROJECT_ID)=STP.ProjectID  
     INNER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details PD WITH(NOLOCK)   
     ON PD.Associate_ID=CPM.PROJECT_MANAGER  
     WHERE STP.Status IN (1,4,5,15,35) AND STP.RowStatus=1 AND ((DATEPART(MM,STP.CreatedDate)=@Month   
     AND DATEPART(YY,STP.CreatedDate)=@Year) OR   
     (DATEPART(MM,STP.ModifiedDate)=@Month  AND DATEPART(YY,STP.ModifiedDate)=@Year))  
     and CM.PK_Componentid=@componentid  
  END  
   END  
  
   IF(@COMPONENTID=180)    
   BEGIN  
   IF(@RoleID in (6,23))  
 BEGIN  
   CREATE TABLE #INDCOMPONENTSNSA2 (ComponentID INT,ProjectID VARCHAR(50))  
             
     --Inserting component data  
   INSERT INTO #INDCOMPONENTSNSA2 (ComponentID ,ProjectID)     
   EXEC [dbo].[usp_GetComponentsForRole] @RoleID,@LoginID,@ComponentGrpID,@CountryID    
            
  SELECT STP.AssociateID,ISNULL(LTRIM(RTRIM(AD.Associate_FirstName)),'')+' '+  
  ISNULL(LTRIM(RTRIM(AD.Associate_LastName)),'') AS AssociateName ,  
  STP.ProjectID,CM.ComponentName AS AllowanceType,  
  CONVERT(VARCHAR,STP.StartDate,101) AS StartDate,  
  CONVERT(VARCHAR,STP.EndDate,101) AS Enddate,  
  STP.Amount AS AllowanceAmount, STP.CreatedBy AS UploaderID,  
  ISNULL(LTRIM(RTRIM(UD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(UD.Associate_LastName)),'') AS UploaderName,  
  Case when isnull(STP.Modifieddate,'')<>'' then STP.Modifieddate  else STP.Createddate  end UploadedDate,  
  CPM.PROJECT_MANAGER AS PMID,  
  ISNULL(LTRIM(RTRIM(PD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(PD.Associate_LastName)),'') AS PMName,   
  STP.ApprovedDate as PMApprovedDate,  
  (CASE WHEN STP.Status=1 THEN 'Valid' WHEN STP.Status=5 THEN 'Processed'  
  WHEN STP.Status=4 THEN 'ReSubmitted' END) AS Status  
  FROM PR.INDShiftNSAComponents STP WITH(NOLOCK)   
  INNER JOIN ComponentMaster CM WITH(NOLOCK) ON CM.PK_ComponentId=STP.Fk_ComponentID  
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK)   
  ON AD.Associate_ID=STP.AssociateID   
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details UD WITH(NOLOCK)   
  ON UD.Associate_ID=STP.CreatedBy   
  LEFT OUTER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Current_ProjectManager CPM WITH(NOLOCK)   
  ON CPM.PROJECT_ID=STP.ProjectID  
  INNER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details PD WITH(NOLOCK)  
  ON PD.Associate_ID=CPM.PROJECT_MANAGER  
  INNER JOIN #INDCOMPONENTSNSA2 CMTS WITH(NOLOCK) ON  CMTS.ComponentID=STP.Fk_ComponentID  
  AND CMTS.ProjectID=STP.ProjectID  
  WHERE STP.Status IN (1,5,4) AND STP.RowStatus=1 AND DATEPART(MM,STP.CreatedDate)=@Month   
  AND DATEPART(YY,STP.CreatedDate)=@Year  
  and CM.Pk_ComponentID=@Componentid  
            
  DROP TABLE  #INDCOMPONENTSNSA2  
 END   
 ELSE IF(@RoleID=18)  
 BEGIN  
    SELECT STP.AssociateID,  
     ISNULL(LTRIM(RTRIM(AD.Associate_FirstName)),'')+' '+  
     ISNULL(LTRIM(RTRIM(AD.Associate_LastName)),'') AS AssociateName ,  
     STP.ProjectID,CM.ComponentName AS AllowanceType,  
     CONVERT(VARCHAR,STP.StartDate,101) AS StartDate,  
        CONVERT(VARCHAR,STP.EndDate,101) AS Enddate,  
     STP.Amount AS [Allowance Amount],STP.CreatedBy AS UploaderID,  
     ISNULL(LTRIM(RTRIM(UD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(UD.Associate_LastName)),'')   
     AS UploaderName,  
     Case when isnull(STP.Modifieddate,'')<>'' then STP.Modifieddate else STP.Createddate end UploadedDate,  
     CPM.PROJECT_MANAGER AS PMID,  
     ISNULL(LTRIM(RTRIM(PD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(PD.Associate_LastName)),'') AS PMName,   
     STP.ApprovedDate as PMApprovedDate,  
     (CASE WHEN STP.Status=1 THEN 'Valid'   
     WHEN STP.Status=5 THEN 'Processed'    
     WHEN STP.Status=4 THEN 'ReSubmitted'   
     WHEN STP.Status=15 THEN 'Approved by PM'   
     WHEN STP.Status=35 THEN 'Approved by D+'  END) AS Status   
     FROM PR.INDShiftNSAComponents STP WITH(NOLOCK)   
     --INNER JOIN ShiftTypeMaster STM WITH(NOLOCK) ON STM.PK_ShiftTypeID=STP.FK_ShiftTypeID  
     INNER JOIN ComponentMaster CM WITH(NOLOCK) ON CM.PK_ComponentId=STP.Fk_ComponentID  
     INNER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK)   
     ON CONVERT(VARCHAR,AD.Associate_ID)=CONVERT(VARCHAR,STP.AssociateID)  
     INNER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details UD WITH(NOLOCK)   
     ON CONVERT(VARCHAR,UD.Associate_ID)=CONVERT(VARCHAR,STP.CreatedBy)  
     LEFT OUTER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Current_ProjectManager CPM WITH(NOLOCK)   
     ON CONVERT(VARCHAR,CPM.PROJECT_ID)=STP.ProjectID  
     INNER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details PD WITH(NOLOCK)   
     ON PD.Associate_ID=CPM.PROJECT_MANAGER  
     WHERE STP.Status IN (1,4,5,15,35) AND STP.RowStatus=1 AND ((DATEPART(MM,STP.CreatedDate)=@Month   
     AND DATEPART(YY,STP.CreatedDate)=@Year) OR   
     (DATEPART(MM,STP.ModifiedDate)=@Month  AND DATEPART(YY,STP.ModifiedDate)=@Year))  
     and CM.PK_Componentid=@componentid and STP.CreatedBy=@LOGINID  
 END  
 ELSE   
 BEGIN  
    SELECT STP.PK_INDShiftNSAComponentID AS UniqueID,STP.AssociateID,  
     ISNULL(LTRIM(RTRIM(AD.Associate_FirstName)),'')+' '+  
     ISNULL(LTRIM(RTRIM(AD.Associate_LastName)),'') AS AssociateName ,  
     STP.ProjectID,CM.ComponentName AS AllowanceType,  
     CONVERT(VARCHAR,STP.StartDate,101) AS StartDate,  
        CONVERT(VARCHAR,STP.EndDate,101) AS Enddate,  
     STP.Amount AS [AllowanceAmount],STP.CreatedBy AS UploaderID,  
     ISNULL(LTRIM(RTRIM(UD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(UD.Associate_LastName)),'')   
     AS UploaderName,  
     Case when isnull(STP.Modifieddate,'')<>'' then STP.Modifieddate else STP.Createddate end UploadedDate,  
     CPM.PROJECT_MANAGER AS PMID,  
     ISNULL(LTRIM(RTRIM(PD.Associate_FirstName)),'')+' '+ISNULL(LTRIM(RTRIM(PD.Associate_LastName)),'') AS PMName,   
     STP.ApprovedDate as PMApprovedDate,  
     (CASE WHEN STP.Status=1 THEN 'Valid'   
     WHEN STP.Status=5 THEN 'Processed'    
     WHEN STP.Status=4 THEN 'ReSubmitted'   
     WHEN STP.Status=15 THEN 'Approved by PM'   
     WHEN STP.Status=35 THEN 'Approved by D+'  END) AS Status   
     FROM PR.INDShiftNSAComponents STP WITH(NOLOCK)   
     INNER JOIN ComponentMaster CM WITH(NOLOCK) ON CM.PK_ComponentId=STP.Fk_ComponentID  
     INNER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details AD WITH(NOLOCK)   
     ON CONVERT(VARCHAR,AD.Associate_ID)=CONVERT(VARCHAR,STP.AssociateID)  
     INNER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details UD WITH(NOLOCK)   
     ON CONVERT(VARCHAR,UD.Associate_ID)=CONVERT(VARCHAR,STP.CreatedBy)  
     LEFT OUTER JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Current_ProjectManager CPM WITH(NOLOCK)   
     ON CONVERT(VARCHAR,CPM.PROJECT_ID)=STP.ProjectID  
     INNER  JOIN CENTRALREPOSITORY.DBO.vw_CentralRepository_Associate_Details PD WITH(NOLOCK)   
     ON PD.Associate_ID=CPM.PROJECT_MANAGER  
     WHERE STP.Status IN (1,4,5,15,35) AND STP.RowStatus=1 AND ((DATEPART(MM,STP.CreatedDate)=@Month   
     AND DATEPART(YY,STP.CreatedDate)=@Year) OR   
     (DATEPART(MM,STP.ModifiedDate)=@Month  AND DATEPART(YY,STP.ModifiedDate)=@Year))  
     and CM.PK_Componentid=@componentid  
  END  
   END  
 
