 UNION ALL  
                
     SELECT DISTINCT CASE WHEN PK_ShiftTimePayoutID<>@KeyID AND STATUS in (1,34)  
     THEN 'Data already uploaded' WHEN PK_ShiftTimePayoutID<>@KeyID AND STATUS=5   
     THEN 'Data already processed' ELSE '' END FROM pr.ShiftTimePayout WITH (NOLOCK)  
     WHERE RowStatus=1 AND Fk_componentid=@ComponentID AND   
     (StartDateTime BETWEEN @StartDateTime AND @EndDateTime   
     OR EndDateTime BETWEEN @StartDateTime AND @EndDateTime)  
     AND AssociateID=@AssociateID and Fk_componentid<>5  
  
     UNION ALL  
                                  
     SELECT DISTINCT 'Allowance claim date doesn''t lie between Project validity date '  
     FROM  #PROJ P WITH (NOLOCK)  
     WHERE  ((convert(date,@StartDate) NOT BETWEEN Convert(date,P.ProjectStartdate)  
     AND Convert(date,P.MINEXPIRYDATE)) OR (convert(date,@EndDate)  
     NOT BETWEEN convert(date,P.ProjectStartdate) AND convert(date,P.MINEXPIRYDATE))  
     or p.VerificationStatus=1)  
     AND P.ComponentID= @ComponentID AND P.ProjectID=@ProjectID  
  
     UNION ALL  
------------------- fetch data --------------  
    SELECT DISTINCT  
    (CASE WHEN B.Status in (1,4,12,21,15,34,35) AND B.ProjectID=@ProjectId  
    THEN 'Difference between the allowance data uploaded for the associate and '+   
    'the current claim date is less than 5 days'   
    WHEN B.STATUS=5  AND B.ProjectID=@ProjectId  
    THEN 'Difference between the allowance data processed for the associate and '+   
    'the current claim date is less than 5 days'   
    WHEN B.Status in (1,4,12,21,15,34,35) AND B.ProjectID <> @ProjectId  
    THEN 'Data already uploaded in another project with less than 5 days gap'  
    WHEN B.STATUS=5  AND B.ProjectID <> @ProjectId  
    THEN 'Data already processed in another project with less than 5 days gap' END)  
    FROM PR.ShiftTimePayout B WITH(NOLOCK)  
    WHERE ((CONVERT(DATE,@startDate) BETWEEN CONVERT(DATE,B.StartDate) AND DATEADD(DD,5,B.StartDate))  
    OR (CONVERT(DATE,@startDate) BETWEEN  DATEADD(DD,-5,B.StartDate) AND CONVERT(DATE,B.StartDate)))   
    AND CONVERT(DATE,B.StartDate)<> CONVERT(DATE,@StartDate) AND B.RowStatus=1   
    AND b.Fk_ComponentID=@ComponentID AND b.AssociateID=@associateid AND PK_ShiftTimePayoutID<>@KeyID  
    AND @ComponentId=4  
  
  UNION ALL  
------------------- fetch data--------------IT  
    SELECT DISTINCT  
    (CASE WHEN B.Status in (1,4,12,21,15,34,35) AND B.ProjectID=@ProjectId  
    THEN 'Data already uploaded for IT 6th DA with less than 5 days gap'   
    WHEN B.Status =5 AND B.ProjectID=@ProjectId  
    THEN 'Data already processed for IT 6th DA with less than 5 days gap'   
    WHEN B.Status in (1,4,12,21,15,34,35) AND B.ProjectID <> @ProjectId  
    THEN 'Data already uploaded in another project with less than 5 days gap'  
    WHEN B.STATUS=5  AND B.ProjectID <> @ProjectId  
    THEN 'Data already processed in another project with less than 5 days gap' END)  
    FROM PR.ITShiftAllowance B WITH(NOLOCK)  
    WHERE ((CONVERT(DATE,@startDate) BETWEEN CONVERT(DATE,B.StartDate) AND DATEADD(DD,5,B.StartDate))  
    OR (CONVERT(DATE,@startDate) BETWEEN  DATEADD(DD,-5,B.StartDate) AND CONVERT(DATE,B.StartDate)))   
    AND CONVERT(DATE,B.StartDate)<> CONVERT(DATE,@StartDate) AND B.RowStatus=1  
    AND b.Fk_ComponentID=50 AND b.AssociateID=@associateid AND @ComponentId=4  
  
  UNION ALL  
------------------- fetch data--------------ADM  
    SELECT DISTINCT  
    (CASE WHEN B.Status in (1,4,12,21,15,34,35) AND B.ProjectID=@ProjectId  
    THEN 'Data already uploaded for ADM 6th DA with less than 5 days gap'   
    WHEN B.Status =5 AND B.ProjectID=@ProjectId  
    THEN 'Data already processed for ADM 6th DA with less than 5 days gap'   
    WHEN B.Status in (1,4,12,21,15,34,35) AND B.ProjectID <> @ProjectId  
    THEN 'Data already uploaded in another project with less than 5 days gap'  
    WHEN B.STATUS=5  AND B.ProjectID <> @ProjectId  
    THEN 'Data already processed in another project with less than 5 days gap' END)  
    FROM PR.ADMShiftAllowance B WITH(NOLOCK)  
    WHERE ((CONVERT(DATE,@startDate) BETWEEN CONVERT(DATE,B.StartDate) AND DATEADD(DD,5,B.StartDate))  
    OR (CONVERT(DATE,@startDate) BETWEEN  DATEADD(DD,-5,B.StartDate) AND CONVERT(DATE,B.StartDate)))   
    AND CONVERT(DATE,B.StartDate)<> CONVERT(DATE,@StartDate) AND B.RowStatus=1   
    AND b.Fk_ComponentID=170 AND b.AssociateID=@associateid AND @ComponentId=4  
  
  UNION ALL  
------------------- fetch data--------------BPS  
    SELECT DISTINCT  
    (CASE WHEN B.Status in (1,4,12,21,15,34,35) AND B.ProjectID=@ProjectId  
    THEN 'Data already uploaded for BPS 6th DA with less than 5 days gap'   
    WHEN B.Status =5 AND B.ProjectID=@ProjectId  
    THEN 'Data already processed for BPS 6th DA with less than 5 days gap'   
    WHEN B.Status in (1,4,12,21,15,34,35) AND B.ProjectID <> @ProjectId  
    THEN 'Data already uploaded in another project with less than 5 days gap'  
    WHEN B.STATUS=5  AND B.ProjectID <> @ProjectId  
    THEN 'Data already processed in another project with less than 5 days gap' END)  
    FROM PR.BPSSDA B WITH(NOLOCK)  
    WHERE ((CONVERT(DATE,@startDate) BETWEEN CONVERT(DATE,B.StartDate) AND DATEADD(DD,5,B.StartDate))  
    OR (CONVERT(DATE,@startDate) BETWEEN  DATEADD(DD,-5,B.StartDate)AND CONVERT(DATE,B.StartDate)))   
    AND CONVERT(DATE,B.StartDate)<> CONVERT(DATE,@StartDate) AND B.RowStatus=1   
    AND b.AssociateID=@associateid AND @ComponentId=4  
  
  UNION ALL  
  
   SELECT DISTINCT  
   (CASE WHEN B.Status in (1,4,12,21,15,34,35) AND B.ProjectID=@ProjectId  
   THEN 'Data was already uploaded for Same date'   
   WHEN B.STATUS=5 AND B.ProjectID=@ProjectId THEN 'Data was already processed for Same date'  
   WHEN B.Status in (1,4,12,21,15,34,35) AND B.ProjectID <> @ProjectId  
   THEN 'Allowance has already been uploaded under another project'   
   WHEN B.Status =5 AND B.ProjectID <> @ProjectId  
   THEN 'Allowance has already been processed under another project' END)  
   FROM PR.ShiftTimePayout B    
   WHERE CONVERT(DATE,B.StartDate) = CONVERT(DATE,@startDate) and B.rowstatus = 1  
   AND B.AssociateID=@associateid AND B.Fk_ComponentID=@ComponentId  
   AND PK_ShiftTimePayoutID<>@KeyID AND @ComponentId=4  
  
  UNION ALL  
  
   SELECT DISTINCT  
   (CASE WHEN B.Status in (1,4,12,21,15,34,35) AND B.ProjectID=@ProjectId  
   THEN 'Allowance has already been uploaded for the same day under IT component'   
   WHEN B.STATUS=5 AND B.ProjectID=@ProjectId THEN 'Allowance already processed in IT component'  
   WHEN B.Status in (1,4,12,21,15,34,35) AND B.ProjectID <> @ProjectId  
   THEN 'Allowance has already been uploaded under another project'   
   WHEN B.Status =5 AND B.ProjectID <> @ProjectId  
   THEN 'Allowance has already been processed under another project' END)  
   FROM PR.ITShiftAllowance B    
   WHERE CONVERT(DATE,B.StartDate) = CONVERT(DATE,@startDate) and B.rowstatus = 1  
   AND B.AssociateID=@associateid AND B.Fk_ComponentID=50  AND @ComponentId=4  
  
  UNION ALL  
  
   SELECT DISTINCT  
   (CASE WHEN B.Status in (1,4,12,21,15,34,35) AND B.ProjectID=@ProjectId  
   THEN 'Allowance has already been uploaded for the same day under ADM component'   
   WHEN B.STATUS=5 AND B.ProjectID=@ProjectId THEN 'Allowance already processed in ADM component'  
   WHEN B.Status in (1,4,12,21,15,34,35) AND B.ProjectID <> @ProjectId  
   THEN 'Allowance has already been uploaded under another project'   
   WHEN B.Status =5 AND B.ProjectID <> @ProjectId  
   THEN 'Allowance has already been processed under another project' END)  
   FROM PR.ADMShiftAllowance B    
   WHERE CONVERT(DATE,B.StartDate) = CONVERT(DATE,@startDate) and B.rowstatus = 1  
   AND B.AssociateID=@associateid AND B.Fk_ComponentID=170 AND @ComponentId=4  
  
  UNION ALL  
  
   SELECT DISTINCT  
   (CASE WHEN B.Status in (1,4,12,21,15,34,35) AND B.ProjectID=@ProjectId  
   THEN 'Allowance has already been uploaded for the same day under BPS component'   
   WHEN B.STATUS=5 AND B.ProjectID=@ProjectId THEN 'Allowance already processed in BPS component'  
   WHEN B.Status in (1,4,12,21,15,34,35) AND B.ProjectID <> @ProjectId  
   THEN 'Allowance has already been uploaded under another project'   
   WHEN B.Status =5 AND B.ProjectID <> @ProjectId  
   THEN 'Allowance has already been processed under another project' END)  
   FROM PR.BPSSDA B    
   WHERE CONVERT(DATE,B.StartDate) = CONVERT(DATE,@startDate) and B.rowstatus = 1  
   AND B.AssociateID=@associateid AND @ComponentId=4  
  
  UNION ALL  
------------------- fetch data--------------  
    SELECT DISTINCT COALESCE((CASE WHEN  PGAM.FixedAmount IS NULL   
    THEN 'Amount is not configured for the Grade,'  ELSE NULL END), '')  
    FROM CentralRepository.dbo.vw_CentralRepository_Designation AD WITH(NOLOCK)   
    LEFT OUTER JOIN Policy.GradeMaster PGM WITH(NOLOCK) ON PGM.GradeLevelId=AD.Job_Family   
    AND PGM.RowStatus=1 AND PGM.FK_ComponentCountryMappingID=@ComponentCountryMappingID  
    LEFT OUTER JOIN Policy.GradeAmountMaster PGAM WITH(NOLOCK)   
    ON PGAM.GradeLevelId=AD.Job_Family AND PGAM.RowStatus=1   
    AND PGAM.FK_ComponentCountryMappingID=@ComponentCountryMappingID   
    WHERE Convert(varchar,AD.JobCode)=@Grade AND AD.Bussiness_unit=@BU   
    and PGAM.SixDayAllowanceEffDate  = @sixthdayEffDAte  ---- V1.0  
                    
              drop table #PROJ  
  
    END  
  
     CREATE TABLE #UptoShiftHour(ID INT IDENTITY(1,1),UptoShiftHour varchar(5))  
     ---- V1.0  
  IF (@StartDate < @EffectiveDate OR @City IN ('CITYNAME'))   
  begin   
  set @sixthdayEffDAte = '1900-01-01'      
  end  
  else  
  begin  
  set @sixthdayEffDAte = @EffectiveDate   
  end  
  ------------------- fetch data--------------  
    INSERT INTO #UptoShiftHour(UptoShiftHour)  
    SELECT DISTINCT UptoShiftHour FROM Policy.GradeAmountMaster GAM WITH(NOLOCK)   
    INNER JOIN ComponentCountryMapping CCM WITH (NOLOCK)   
    ON CCM.PK_ComponentCountryMappingID=GAM.FK_ComponentCountryMappingID  
    WHERE CCM.FK_ComponentID=4 and CCM.FK_ComponentCountryID=1 AND CCM.RowStatus=1   
    AND GAM.RowStatus=1 AND GAM.SixDayAllowanceEffDate  = @sixthdayEffDAte  ---- V1.0  
    ORDER BY UptoShiftHour   
  
    DECLARE @MINHOURS FLOAT  
    DECLARE @MAXHOURS FLOAT  
  
    SELECT @MINHOURS=convert(float,UptoShiftHour) FROM #UptoShiftHour WHERE ID=1   
    SELECT @MAXHOURS=convert(float,UptoShiftHour) FROM #UptoShiftHour WHERE ID=2  
                               
    DECLARE @count INT  
    SELECT @count= COUNT(1)  FROM #STPEXCEPTION WITH (NOLOCK)  
      
      
   IF EXISTS(SELECT ExceptionReason FROM #STPEXCEPTION WITH (NOLOCK)   
   WHERE ISNULL(ExceptionReason,'')='' OR @count=0)   
   
    BEGIN  
    ---------------------------VALIDATION FOR SIXTH DAY ALLOWANCE------------  
    IF(@ComponentId=4)       
    BEGIN  
                  
            ------------------- fetch data--------------    
      INSERT INTO #STPEXCEPTION(EXCEPTIONREASON)  
        SELECT DISTINCT  COALESCE((CASE WHEN  GM.GradeLevelId IS NULL   
        THEN 'Ineligible Grade for 6th Day Allowance,' ELSE NULL END), '')  
        +  
        COALESCE((CASE WHEN  (DATEDIFF(minute,@STARTDATETIME,@ENDDATETIME) < 120   
        AND GM.GradeLevelId IS NOT NULL)   
         THEN 'Associate should be in office for atleast 2 Hours for 6DA,'   
         ELSE NULL END), '')   
        AS ExceptionReason  
  
        FROM CentralRepository.dbo.vw_CentralRepository_Designation AD WITH(NOLOCK)  
        LEFT OUTER JOIN Policy.GradeMaster GM WITH(NOLOCK)   
        ON GM.FK_ComponentCountryMappingID=@ComponentCountryMappingID  
        AND GM.GradeLevelId=AD.Job_Family AND GM.RowStatus=1  
        LEFT OUTER JOIN Policy.GradeAmountMaster GAM WITH(NOLOCK)   
        ON GAM.FK_ComponentCountryMappingID=@ComponentCountryMappingID   
        AND GM.GradeLevelId=AD.Job_Family AND GAM.RowStatus=1  
        WHERE Convert(varchar,AD.JobCode)=@Grade AND AD.Bussiness_unit=@BU   
        and GAM.SixDayAllowanceEffDate  = @sixthdayEffDAte  ---- V1.0  
                           
       UNION ALL  
     ------------------- fetch data--------------  
     SELECT DISTINCT   
   'This ProjectID is not configured for 6DA ' where @ProjectID not in   
  (select Projectid FROM Approval_Projects AP WITH(NOLOCK)   
  where  AP.ROWSTATUS=1 AND AP.FK_ComponentID=4)  
       
                       
  UNION ALL  
------------------- fetch data--------------  
    SELECT DISTINCT 'Comp off proceeds 6th Day Allowance'  
    FROM CompOffDetails COD WITH (NOLOCK)  
    WHERE ((CONVERT(DATE,COD.HolidayWorked)=CONVERT(DATE,@StartDate))   
    OR (CONVERT(DATE,COD.HolidayWorked) =CONVERT(DATE,@EndDate)))  
    AND COD.AssociateID=@AssociateID AND COD.CompOffStatus IN ('A','S')   
    AND COD.RowStatus=1   
  UNION ALL  
------------------- fetch data--------------  
          SELECT DISTINCT 'Weekend shift should be normal'  
         WHERE DATEPART(DW,@StartDate) IN (1,7) AND @ShiftType=2  
               
        UNION ALL  
------------------- fetch data--------------          
SELECT DISTINCT 'WeekDay shift should be rotational'    
WHERE DATEPART(DW,@StartDate) IN (2,3,4,5,6) AND @ShiftType=1  
------------------- fetch data--------------  
  
     SELECT  @Amount=  (CASE WHEN (DATEDIFF(MINUTE,@StartDateTime,@EndDateTime)   
     BETWEEN 0 AND @MINHOURS *60) AND GM.GradeLevelId IS NOT NULL   
      THEN (SELECT GAM.FixedAmount FROM Policy.GradeAmountMaster GAM WITH(NOLOCK)   
      WHERE GAM.RowStatus=1 AND GAM.FK_ComponentCountryMappingID=@ComponentCountryMappingID   
      AND GAM.UptoShiftHour =@MINHOURS   
      AND GAM.GradeLevelId=@GradeLevelID and GAM.SixDayAllowanceEffDate  = @sixthdayEffDAte   
      GROUP BY GAM.FixedAmount)   ---- V1.0   
      WHEN   
      DATEDIFF(MINUTE,@StartDateTime,@EndDateTime)>(@MINHOURS *60)   
      AND GM.GradeLevelId IS NOT NULL THEN  
      (SELECT GAM.FixedAmount FROM Policy.GradeAmountMaster GAM WITH(NOLOCK)   
      WHERE GAM.RowStatus=1 AND GAM.FK_ComponentCountryMappingID=@ComponentCountryMappingID   
      AND GAM.UptoShiftHour =@MAXHOURS   
      AND GAM.GradeLevelId=@GradeLevelID and GAM.SixDayAllowanceEffDate  = @sixthdayEffDAte   
      GROUP BY GAM.FixedAmount)      ---- V1.0  
      END )   
      FROM  CentralRepository.dbo.vw_CentralRepository_Designation AD WITH(NOLOCK)  
      LEFT OUTER JOIN Policy.GradeMaster GM WITH(NOLOCK)  
      ON GM.FK_ComponentCountryMappingID=@ComponentCountryMappingID AND GM.GradeLevelId=AD.Job_Family   
      AND GM.RowStatus=1  
      LEFT OUTER JOIN Policy.GradeAmountMaster GAM WITH(NOLOCK)  
      ON GAM.FK_ComponentCountryMappingID=@ComponentCountryMappingID   
      AND GM.GradeLevelId=Convert(varchar,AD.Job_Family )  
      AND GAM.RowStatus=1  
      WHERE Convert(varchar,AD.JobCode)=@Grade  AND AD.Bussiness_unit=@BU   
      and GAM.SixDayAllowanceEffDate  = @sixthdayEffDAte  ---- V1.0  
      ------------------- fetch data--------------  
    
   Select PST.PK_ShiftTimePayoutID as PRPkID,@AssociateID as AssociateID,@ComponentID as ComponentID,  
   @Amount as newAmount,PST.Amount as PRAmount  
   INTO #ProcessedDataCheck1  
   from PR.ShiftTimePayout PST WITH(NOLOCK)   
   WHERE PST.AssociateID=@AssociateID AND PST.FK_ComponentID<>@ComponentID AND  
   (((PST.StartDateTime BETWEEN @StartDateTime and @EndDateTime)  
   OR (PST.EndDateTime BETWEEN @StartDateTime and @EndDateTime)  
   OR (@StartDateTime BETWEEN PST.StartDateTime and PST.EndDateTime)   
   OR (@EndDateTime BETWEEN PST.StartDateTime and PST.EndDateTime) OR (PST.StartDate=@StartDate))   
   AND ((@StartTime<>PST.StartTime AND @EndTime=PST.EndTime)  
   OR (@StartTime=PST.StartTime AND @EndTime<>PST.EndTime) OR   
   (@StartTime<>PST.StartTime AND @EndTime<>PST.EndTime)))   
   AND @ComponentID=4 AND PST.Fk_ComponentID=6 AND PST.RowStatus=1 AND  
   PST.Status Not in (2,3,8,9,18,17,23,24,36)  
  
   ------------------- fetch data--------------  
   Insert into Pr.ShiftTimePayout_log(Fk_Shifttimepayoutid,Associateid,Fk_ComponentID,Fk_ShifttypeID,  
   ProjectID,Startdate,Starttime,Startdatetime,Enddate,  
   Endtime,Enddatetime,Amount,Grade,SpecialCaseReason,inputremarks,RejectReason,RejectedBy,  
   Fk_RejectedRoleID,Status,Setid,Createdby,Createddate,Modifiedby,Modifieddate,Remarks,  
   Rowstatus,LogCreatedby,LogCreateddate,HCMSchedule)  
   ------------------- fetch data--------------  
   select PK_ShiftTimePayoutID,PD.AssociateID,Fk_ComponentID,Fk_ShifttypeID,ProjectID,Startdate,Starttime,  
   Startdatetime,Enddate,Endtime,Enddatetime,Amount,Grade,  
   SpecialCaseReason,inputremarks,RejectionReason,RejectedBy,Fk_RejectedRoleID,Status,Setid,  
   Createdby,Createddate,Modifiedby,Modifieddate,Remarks,Rowstatus,@LoginID,getdate(),HCMSchedule  
   from PR.ShiftTimePayout PD WITH(NOLOCK)  
   INNER JOIN #ProcessedDataCheck1 PTB WITH(NOLOCK) on PD.PK_ShiftTimePayoutID=PTB.PRPkID  
   where PD.Amount<PTB.newAmount and PD.RowStatus=1  
   ------------------- fetch data--------------  
   INSERT INTO EXP.ShiftTimePayout (AssociateID, Fk_ComponentID, FK_ShiftTypeID, ProjectID,  
   StartDate, StartTime,   
   EndDate, EndTime,SpecialCaseReason, InputRemarks, ExceptionReason, CreatedBy, CreatedDate,  
   RowStatus,HCMSchedule)  
   SELECT PD.AssociateID,Fk_ComponentID, FK_ShiftTypeID,ProjectID,Startdate,Starttime,Enddate,  
   Endtime,SpecialCaseReason,  
   InputRemarks,'Allowance with higher amount processed as per policy',CreatedBy,CreatedDate,1 ,  
   HCMSchedule  
   FROM PR.ShiftTimePayout PD WITH(NOLOCK)  
   INNER JOIN #ProcessedDataCheck1 PTB WITH(NOLOCK) on PD.PK_ShiftTimePayoutID=PTB.PRPkID  
   where PD.Amount<PTB.newAmount and PD.RowStatus=1  
   ------------------- fetch data--------------  
   Update PD set PD.RowStatus=0  
   FROM PR.ShiftTimePayout PD WITH(NOLOCK)   
   INNER JOIN #ProcessedDataCheck1 PTB WITH(NOLOCK) on PD.PK_ShiftTimePayoutID=PTB.PRPkID  
   where PD.Amount<PTB.newAmount and PD.RowStatus=1  
  
   INSERT INTO #STPEXCEPTION(EXCEPTIONREASON)  
------------------- fetch data--------------  
Select 'Overlapping allowance with higher amount available in valid tab' AS ExceptionReason  
   FROM PR.ShiftTimePayout PD WITH(NOLOCK)   
   INNER JOIN #ProcessedDataCheck1 PTB WITH(NOLOCK) on PD.PK_ShiftTimePayoutID=PTB.PRPkID  
   where PD.Amount>PTB.newAmount and PD.RowStatus=1  
------------------- fetch data--------------  
   Select PST.PK_ShiftTimePayoutID as PRPkID,@AssociateID as AssociateID,  
   @ComponentID as ComponentID,@Amount as newAmount,PST.Amount as PRAmount  
   INTO #ProcessedDataCheck8  
   from PR.ShiftTimePayout PST WITH(NOLOCK)   
   WHERE PST.AssociateID=@AssociateID AND PST.FK_ComponentID<>@ComponentID AND  
   (((PST.StartDateTime BETWEEN @StartDateTime and @EndDateTime)  
   OR (PST.EndDateTime BETWEEN @StartDateTime and @EndDateTime)  
   OR (@StartDateTime BETWEEN PST.StartDateTime and PST.EndDateTime)   
   OR (@EndDateTime BETWEEN PST.StartDateTime and PST.EndDateTime)   
   OR (PST.StartDate=@StartDate)) AND   
   ((@StartTime<>PST.StartTime AND @EndTime=PST.EndTime)   
   OR (@StartTime=PST.StartTime AND @EndTime<>PST.EndTime) OR   
   (@StartTime<>PST.StartTime AND @EndTime<>PST.EndTime)))   
   AND @ComponentID=4 AND PST.Fk_ComponentID=6 AND PST.RowStatus=1 AND PST.Status=5   
  
   INSERT INTO #STPEXCEPTION(EXCEPTIONREASON)  
------------------- fetch data--------------  
   Select CASE WHEN PTB.PRAmount>PTB.newAmount  
   THEN 'Overlapping allowance with higher amount processed previously'  
   ELSE 'Overlapping allowance processed previously' END   
   AS ExceptionReason  
   FROM #ProcessedDataCheck8 PTB WITH(NOLOCK)  
  
------------------------------SDA and OCA overlaps----------  
     
   Select PST.PK_ShiftTimePayoutID as PRPkID,@AssociateID as AssociateID,  
   @ComponentID as ComponentID,@Amount as newAmount,PST.Amount as PRAmount  
   INTO #ProcessedDataCheck2  
   FROM PR.ShiftTimePayout PST WITH(NOLOCK)  
   WHERE PST.AssociateID=@AssociateID AND PST.FK_ComponentID<>@ComponentID AND  
   (((PST.StartDateTime BETWEEN @StartDateTime and @EndDateTime)  
   OR (PST.EndDateTime BETWEEN @StartDateTime and @EndDateTime)  
   OR (@StartDateTime BETWEEN PST.StartDateTime and PST.EndDateTime)  
   OR (@EndDateTime BETWEEN PST.StartDateTime and PST.EndDateTime)) AND   
   ((@StartTime BETWEEN PST.StartTime AND '23:59' OR @StartTime BETWEEN '00:00' AND PST.EndTime)   
   OR (@EndTime BETWEEN PST.StartTime AND '23:59' OR @EndTime BETWEEN '00:00' AND PST.EndTime)  
   OR (PST.StartTime BETWEEN @StartTime AND '23:59' OR PST.StartTime BETWEEN '00:00' AND @EndTime)   
   OR (PST.EndTime BETWEEN @StartTime AND '23:59' OR PST.EndTime BETWEEN '00:00' AND @EndTime)))   
   AND @ComponentID=4 AND PST.Fk_ComponentID=5  
   AND PST.RowStatus=1 AND PST.Status Not in (2,3,8,9,18,17,23,24,36)  
------------------- fetch data--------------  
   Insert into Pr.ShiftTimePayout_log(Fk_Shifttimepayoutid,Associateid,Fk_ComponentID,Fk_ShifttypeID,  
   ProjectID,Startdate,Starttime,Startdatetime,Enddate,  
   Endtime,Enddatetime,Amount,Grade,SpecialCaseReason,inputremarks,RejectReason,RejectedBy,  
   Fk_RejectedRoleID,Status,  
   Setid,Createdby,Createddate,Modifiedby,Modifieddate,Remarks,Rowstatus,LogCreatedby,  
   LogCreateddate,HCMSchedule)  
------------------- fetch data--------------  
   select PK_ShiftTimePayoutID,PD.AssociateID,Fk_ComponentID,Fk_ShifttypeID,ProjectID,Startdate,Starttime,  
   Startdatetime,Enddate,Endtime,Enddatetime,Amount,Grade,  
   SpecialCaseReason,inputremarks,RejectionReason,RejectedBy,Fk_RejectedRoleID,Status,Setid,  
   Createdby,Createddate,Modifiedby,Modifieddate,Remarks,Rowstatus,@LoginID,getdate(),HCMSchedule  
   FROM PR.ShiftTimePayout PD WITH(NOLOCK)  
   INNER JOIN #ProcessedDataCheck2 PTB WITH(NOLOCK) on PD.PK_ShiftTimePayoutID=PTB.PRPkID  
   where PD.Amount<PTB.newAmount and PD.RowStatus=1  
------------------- fetch data--------------  
   INSERT INTO EXP.ShiftTimePayout (AssociateID, Fk_ComponentID, FK_ShiftTypeID, ProjectID,  
   StartDate, StartTime,   
   EndDate, EndTime,SpecialCaseReason, InputRemarks, ExceptionReason, CreatedBy, CreatedDate,  
   RowStatus,HCMSchedule)  
   SELECT PD.AssociateID,Fk_ComponentID, FK_ShiftTypeID,ProjectID,Startdate,Starttime,Enddate,  
   Endtime,SpecialCaseReason,  
   InputRemarks,'Allowance with higher amount processed as per policy',CreatedBy,CreatedDate,1 ,  
   HCMSchedule  
   FROM PR.ShiftTimePayout PD WITH(NOLOCK)  
   INNER JOIN #ProcessedDataCheck2 PTB WITH(NOLOCK) on PD.PK_ShiftTimePayoutID=PTB.PRPkID  
   where PD.Amount<PTB.newAmount and PD.RowStatus=1  
------------------- Update data--------------  
   Update PD set PD.RowStatus=0  
   FROM PR.ShiftTimePayout PD WITH(NOLOCK)   
   INNER JOIN #ProcessedDataCheck2 PTB WITH(NOLOCK) on PD.PK_ShiftTimePayoutID=PTB.PRPkID  
   where PD.Amount<PTB.newAmount and PD.RowStatus=1  
------------------- fetch data--------------  
   INSERT INTO #STPEXCEPTION(EXCEPTIONREASON)  
  
   Select 'Overlapping allowance with higher amount available in valid tab' AS ExceptionReason  
   FROM PR.ShiftTimePayout PD WITH(NOLOCK)   
   INNER JOIN #ProcessedDataCheck2 PTB WITH(NOLOCK) on PD.PK_ShiftTimePayoutID=PTB.PRPkID  
   where PD.Amount>PTB.newAmount and PD.RowStatus=1  
   ------------------- fetch data--------------  
   Select PST.PK_ShiftTimePayoutID as PRPkID,@AssociateID as AssociateID,  
   @ComponentID as ComponentID,@Amount as newAmount,PST.Amount as PRAmount  
   INTO #ProcessedDataCheck9  
   FROM PR.ShiftTimePayout PST WITH(NOLOCK)  
   WHERE PST.AssociateID=@AssociateID AND PST.FK_ComponentID<>@ComponentID AND  
   (((PST.StartDateTime BETWEEN @StartDateTime and @EndDateTime)  
   OR (PST.EndDateTime BETWEEN @StartDateTime and @EndDateTime)  
   OR (@StartDateTime BETWEEN PST.StartDateTime and PST.EndDateTime)   
   OR (@EndDateTime BETWEEN PST.StartDateTime and PST.EndDateTime) ) AND   
   ((@StartTime BETWEEN PST.StartTime AND '23:59'   
   OR @StartTime BETWEEN '00:00' AND PST.EndTime)   
   OR (@EndTime BETWEEN PST.StartTime AND '23:59'   
   OR @EndTime BETWEEN '00:00' AND PST.EndTime)  
   OR (PST.StartTime BETWEEN @StartTime AND '23:59'   
   OR PST.StartTime BETWEEN '00:00' AND @EndTime)   
   OR (PST.EndTime BETWEEN @StartTime AND '23:59'   
   OR PST.EndTime BETWEEN '00:00' AND @EndTime)) )   
   AND @ComponentID=4 AND PST.Fk_ComponentID=5  
   AND PST.RowStatus=1 AND PST.Status=5  
  
   INSERT INTO #STPEXCEPTION(EXCEPTIONREASON)  
------------------- fetch data--------------  
   Select CASE WHEN PTB.PRAmount>PTB.newAmount  
   THEN 'Overlapping allowance with higher amount processed previously'  
   ELSE 'Overlapping allowance processed previously' END   
   AS ExceptionReason  
   FROM #ProcessedDataCheck9 PTB WITH(NOLOCK)  
  
   DROP TABLE #ProcessedDataCheck1  
   DROP TABLE #ProcessedDataCheck2  
   DROP TABLE #ProcessedDataCheck8  
   DROP TABLE #ProcessedDataCheck9        
   
END 
