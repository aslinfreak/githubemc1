	IF(@componentGroupId = 12)
	BEGIN
	  
		SELECT ESTP.PK_ITShiftAllowanceID,ESTP.AssociateID,ESTP.Fk_ComponentID,ESTP.Fk_ShifttypeID,ESTP.ProjectID,
			ESTP.Startdate, ESTP.Starttime, ESTP.Startdatetime, ESTP.Enddate, ESTP.Endtime, ESTP.Enddatetime,
			ESTP.Amount, ESTP.Grade, ESTP.SpecialCaseReason, ESTP.inputremarks, ESTP.RejectionReason,
			ESTP.Fk_RejectedRoleID, ESTP.RejectedBy, ESTP.[Status], ESTP.SetID, ESTP.ApprovedBy,
			ESTP.TransportEligibility,ESTP.ApprovedDate, ESTP.Createdby, ESTP.Createddate, ESTP.Modifiedby,
			ESTP.Modifieddate,	ESTP.RowStatus, ESTP.NSADate, 
			STP.CreatedBy AS EPCreatedby, @Currentdate AS EPCreateddate, STP.UniqueID,
			STP.RejectionReason AS EPRejectionReason, 
			STP.Approve_Reject, STP.ModifiedBy AS EPModifiedBy, STP.ModifiedDate AS EPModifiedDate, 
		COALESCE((CASE WHEN (ISNULL(STP.RejectionReason,'') = '' AND STP.approve_Reject = 'Reject') 
		THEN 'Rejection reason is mandatory,' ELSE '' END),'')
		+
		COALESCE((CASE WHEN ISNULL(ESTP.PK_ITShiftAllowanceID,'') = '' 
		THEN 'Please upload the valid Unique id' ELSE '' END),'') AS ExceptionRemarks, 		
		NULL AS Remarks,  0 AS MailStatus 
		INTO #Exception_IT
		FROM STG.ExceptiontovalidAllowance STP WITH (NOLOCK) 
			INNER JOIN pr.ITShiftAllowance ESTP WITH (NOLOCK) ON STP.UniqueID = ESTP.PK_ITShiftAllowanceID 			
			WHERE ESTP.RowStatus = 1 AND STP.RowStatus = 1 AND 
			(ESTP.[Status] IN (1,3,4,8,14,12,15,35) OR (ESTP.Status = 21 AND @CutoffDate < @Currentdate)) AND 
			STP.FK_ComponentGroupID = @componentGroupId 
			

		--------- inserting data------------------
	  INSERT INTO pr.Itshiftallowance_log (FK_ITShiftAllowanceID, AssociateID, Fk_ComponentID,
	    Fk_ShifttypeID, ProjectID, Startdate, Starttime, Startdatetime, Enddate, Endtime,
		Enddatetime, Amount, Grade, TransportEligibility, SpecialCaseReason, inputremarks, 
		RejectReason, Fk_RejectedRoleID, RejectedBy, [Status], SetID, ApprovedBy, ApprovedDate,
		Createdby, Createddate, Modifiedby, Modifieddate, Rowstatus, LogCreatedby, LogCreateddate)
	  SELECT ESTP.PK_ITShiftAllowanceID, ESTP.AssociateID, ESTP.Fk_ComponentID, ESTP.FK_ShiftTypeID,
		ESTP.ProjectID, ESTP.StartDate, ESTP.StartTime, ESTP.StartDateTime, ESTP.EndDate,
	    ESTP.Endtime, ESTP.Enddatetime, ESTP.Amount, ESTP.Grade, ESTP.TransportEligibility,
		ESTP.SpecialCaseReason, ESTP.inputremarks, ESTP.RejectionReason, ESTP.Fk_RejectedRoleID,
		ESTP.RejectedBy, ESTP.[Status], ESTP.SetID, ESTP.ApprovedBy, ESTP.ApprovedDate, EPCreatedby,
		ESTP.Createddate, EPModifiedby, ESTP.Modifieddate, ESTP.Rowstatus, EPCreatedby, @Currentdate
	  FROM #Exception_IT ESTP
		
		
		DELETE FROM #Exception_IT WHERE ISNULL(ExceptionRemarks,'')<>''	
	  	 -----------------Update----------------
	  UPDATE ESTP 
		  SET ESTP.Status = CASE WHEN STP.Approve_Reject = 'Approved' THEN 12 ELSE 3 END,
			ESTP.ModifiedBy = STP.EPCreatedby,
			ESTP.ModifiedDate = @Currentdate, 
			ESTP.Remarks = CASE WHEN STP.Approve_Reject = 'Approved' THEN 'Bulk Approve' ELSE 'Bulk Reject' END, 
			ESTP.RejectionReason = STP.EPRejectionReason, 
			ESTP.ApprovedBy = CASE WHEN STP.Approve_Reject = 'Approved' THEN STP.EPCreatedby ELSE ESTP.ApprovedBy END, 
			ESTP.ApprovedDate = CASE WHEN STP.Approve_Reject = 'Approved' THEN @Currentdate ELSE ESTP.ApprovedDate END, 
			ESTP.RejectedBy = CASE WHEN STP.Approve_Reject = 'Reject' THEN STP.EPCreatedby ELSE ESTP.RejectedBy END, 
			ESTP.FK_RejectedRoleID = CASE WHEN STP.Approve_Reject = 'Reject' THEN 3  END
		  FROM PR.ITShiftAllowance ESTP WITH (NOLOCK) 
		  INNER JOIN #Exception_IT STP WITH (NOLOCK) 
			ON ESTP.PK_ITShiftAllowanceID = STP.PK_ITShiftAllowanceID 
		  WHERE STP.Approve_Reject IN ('Approved', 'Reject')

	
		-----------------Update----------------
	  UPDATE IT SET IT.RowStatus = 0, IT.ModifiedBy = ESTP.EPCreatedBy, IT.ModifiedDate = @Currentdate,
	    IT.TopUpReason_6 = CAST(ESTP.PK_ITShiftAllowanceID AS VARCHAR(20)) + '-' + ESTP.EPRejectionReason
	  FROM PR.IT_NSA IT 
	  INNER JOIN #Exception_IT ESTP 
	  WITH (NOLOCK) ON 
				IT.AssociateID = ESTP.AssociateID AND IT.[Date] = ESTP.NSADate AND 
				IT.Fk_ComponentID = ESTP.Fk_ComponentID AND IT.ProjectID = ESTP.ProjectID 
	  WHERE ESTP.EPRejectionReason = 'Rejected due to mismatch in Trutime and NSA request'
	
	  	DROP TABLE #Exception_IT

	END
