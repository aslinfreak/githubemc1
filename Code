		--------- Comp OFF Check ----------------------
UPDATE A SET ExceptionReason = 
	   'Comp off processed for the same date. Hence 6th Day Allowance cannot be processed'
	   FROM #MANDATORY A WITH (NOLOCK) 	   
	   INNER JOIN CentralRepository.dbo.vw_CentralRepository_EAM_IND_Comp_Off CF ON CF.EMPLID = A.AssociateID 
	   WHERE CF.HOLIDAY_WORKED_DT = A.StartDate AND ISNULL(ExceptionReason, '') = ''

       INSERT INTO EXP.BPSSDA(ShiftType, AssociateID, StartDate, EndDate, StartTime, EndTime,StartDateTime,
	   EndDateTime,ProjectID,TransportEligibility, BillingDetails, Grade, SetID, ExceptionRemarks,CreatedBy,
	   CreatedDate,RowStatus)
        SELECT ShiftType, AssociateID, CONVERT(VARCHAR,StartDate), CONVERT(VARCHAR,EndDate), StartTime, EndTime, 
        NULL AS StartDateTime,NULL AS EndDateTime,
        ProjectID, TRansportEligibility, BillingDetails,Grade,BU,ExceptionReason,CreatedBy,CreatedDate,1 
        FROM #MANDATORY WITH (NOLOCK) WHERE ExceptionReason<>'' 

        DELETE FROM STG.BPSSDA WHERE PK_BPSSDAID IN (SELECT PK_BPSSDAID FROM #MANDATORY WITH(NOLOCK) 
		WHERE ExceptionReason<>'')
          
        DROP TABLE #MANDATORY

		SELECT STP.Pk_BPSSDAID,ShiftType,STP.AssociateID,StartDate,EndDate,StartTime,EndTime,ProjectID,
		TransportEligibility,BillingDetails,'' AS Grade,'' AS BU,'' AS Location,
		   
		    COALESCE((CASE WHEN (ISDATE(EndDate+' '+ EndTime)=1 AND ISDATE(EndDate)=1 
                AND CONVERT(DATETIME,(EndDate+' '+ EndTime))<CONVERT(DATETIME,(STP.StartDate+' '+ StartTime))
                AND ISDATE(STP.StartDate+' '+ StartTime)=1 AND ISDATE(STP.Startdate)=1  ) 
                    THEN 'End Time Should be greater than Start Time,' ELSE NULL END), '') 
			+
          COALESCE((CASE WHEN DATEDIFF(Mi,CONVERT(DATETIME,(CONVERT(VARCHAR,Startdate)
		  +' '+CONVERT(VARCHAR,Starttime)))
		  ,CONVERT(DATETIME,(CONVERT(VARCHAR,Enddate)+' '+CONVERT(VARCHAR,Endtime))))<120
          THEN 'Minimum Eligibility Period is 2hrs' ELSE '' END), '')
		  +
          COALESCE((CASE WHEN (ISDATE(STP.StartDate+' '+ StartTime)=1 AND ISDATE(STP.Startdate)=1 AND 
		  ISDATE(EndDate+' '+ EndTime)=1 AND ISDATE(EndDate)=1 AND 
          DATEDIFF(mi,CONVERT(DATETIME,(CONVERT(VARCHAR,STP.StartDate)+' '+CONVERT(VARCHAR,StartTime))),
		  CONVERT(DATETIME,(CONVERT(VARCHAR,EndDate)+' '+CONVERT(VARCHAR,EndTime)))) >1440)
          THEN 'Difference Between StartTime and EndTime should not exceed 24 hours, 'ELSE NULL END),'')
          AS ExceptionReason,STP.CreatedBy,STP.CreatedDate
          INTO  #datetimecheck        
       FROM STG.BPSSDA STP WITH (NOLOCK) 
          LEFT OUTER JOIN ShiftTypeMaster STM WITH (NOLOCK) ON STP.ShiftType=STM.ShiftTypeName 
		  AND STM.Rowstatus=1 AND
		  PK_ShiftTypeID in (1,2) 
          LEFT OUTER JOIN CentralRepository.dbo.vw_CentralRepository_Associate_Details AD WITH (NOLOCK) ON
		  STP.AssociateID=AD.Associate_ID 
          LEFT OUTER JOIN ComponentShiftMapping CSM WITH(NOLOCK) ON CSM.FK_ComponentID=36  AND 
		  CSM.FK_ShiftTypeID=STM.PK_ShiftTypeID AND CSM.RowStatus=1
       WHERE STP.RowStatus=1   

       INSERT INTO EXP.BPSSDA(ShiftType, AssociateID, StartDate, EndDate, StartTime, EndTime,StartDateTime,
	   EndDateTime, ProjectID,  TransportEligibility, BillingDetails, Grade, SetID, ExceptionRemarks,CreatedBy,
	   CreatedDate, RowStatus)
          SELECT ShiftType, AssociateID, CONVERT(VARCHAR,StartDate), CONVERT(VARCHAR,EndDate), StartTime, EndTime, 
          NULL AS StartDateTime,NULL AS EndDateTime,
         ProjectID, TRansportEligibility, BillingDetails,Grade,BU,ExceptionReason,CreatedBy,CreatedDate,1 
          FROM #datetimecheck WITH (NOLOCK) WHERE ExceptionReason<>'' 

          DELETE FROM STG.BPSSDA WHERE PK_BPSSDAID IN (SELECT PK_BPSSDAID FROM #datetimecheck WITH(NOLOCK) 
		  WHERE ExceptionReason<>'')
          
          DROP TABLE #datetimecheck
